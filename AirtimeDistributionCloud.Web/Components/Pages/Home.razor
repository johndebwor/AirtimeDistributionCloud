@page "/"
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@using AirtimeDistributionCloud.Application.DTOs
@using AirtimeDistributionCloud.Application.Services
@using AirtimeDistributionCloud.Core.Entities
@using AirtimeDistributionCloud.Core.Enums
@using AirtimeDistributionCloud.Core.Interfaces
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@inject IProductService ProductService
@inject IDealerService DealerService
@inject IAirtimeTransferService TransferService
@inject ICashDepositService CashDepositService
@inject IAirtimeDepositService DepositService
@inject IBranchService BranchService
@inject IAuditLogService AuditLogService
@inject IExpenseService ExpenseService
@inject ICurrentUserService CurrentUser
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject IServiceScopeFactory ScopeFactory
@using Microsoft.Extensions.DependencyInjection
@rendermode InteractiveServer

<PageTitle>Dashboard - RasidBase</PageTitle>

<div class="page-header">
    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
        <MudAvatar Color="Color.Primary" Size="Size.Large">
            <MudIcon Icon="@Icons.Material.Filled.Person" />
        </MudAvatar>
        <div>
            <h1>Welcome back, @_userName!</h1>
            <p>@_roleSubtitle</p>
        </div>
    </MudStack>
</div>

@if (_loading)
{
    <MudProgressLinear Indeterminate="true" Color="Color.Primary" Class="mb-4" />
}

@if (_isDealer)
{
    <!-- ─── DEALER DASHBOARD ─── -->
    <MudGrid Spacing="4">

        <!-- Stat Cards -->
        <MudItem xs="12" sm="6" md="3">
            <MudCard Class="stat-card" Elevation="0" Style="border-left: 4px solid #0284C7 !important;"
                     @onclick="@(() => Navigation.NavigateTo("/dealer/transfers"))">
                <MudCardContent>
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <div>
                            <MudText Typo="Typo.overline" Color="Color.Secondary">MY TRANSFERS</MudText>
                            <MudText Typo="Typo.h4">@_myTransferCount</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Info">total</MudText>
                        </div>
                        <MudAvatar Color="Color.Info" Variant="Variant.Outlined" Size="Size.Large">
                            <MudIcon Icon="@Icons.Material.Filled.SwapHoriz" />
                        </MudAvatar>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudCard Class="stat-card" Elevation="0" Style="border-left: 4px solid #D97706 !important;">
                <MudCardContent>
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <div>
                            <MudText Typo="Typo.overline" Color="Color.Secondary">PENDING</MudText>
                            <MudText Typo="Typo.h4">@_myPendingCount</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Warning">awaiting approval</MudText>
                        </div>
                        <MudAvatar Color="Color.Warning" Variant="Variant.Outlined" Size="Size.Large">
                            <MudIcon Icon="@Icons.Material.Filled.HourglassEmpty" />
                        </MudAvatar>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudCard Class="stat-card" Elevation="0" Style="border-left: 4px solid #16A34A !important;">
                <MudCardContent>
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <div>
                            <MudText Typo="Typo.overline" Color="Color.Secondary">APPROVED AIRTIME</MudText>
                            <MudText Typo="Typo.h5" Style="font-weight:700;">@_myApprovedAmount.ToString("C2")</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Success">loan airtime received</MudText>
                        </div>
                        <MudAvatar Color="Color.Success" Variant="Variant.Outlined" Size="Size.Large">
                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" />
                        </MudAvatar>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudCard Class="stat-card" Elevation="0" Style="border-left: 4px solid #A855F7 !important;"
                     @onclick="@(() => Navigation.NavigateTo("/dealer/commissions"))">
                <MudCardContent>
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <div>
                            <MudText Typo="Typo.overline" Color="Color.Secondary">TOTAL COMMISSION</MudText>
                            <MudText Typo="Typo.h5" Style="font-weight:700;">@_myTotalCommission.ToString("C2")</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">earned to date</MudText>
                        </div>
                        <MudAvatar Style="color:#A855F7; border-color:#A855F7;" Variant="Variant.Outlined" Size="Size.Large">
                            <MudIcon Icon="@Icons.Material.Filled.Payments" />
                        </MudAvatar>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Quick Actions -->
        <MudItem xs="12">
            <MudPaper Elevation="0" Class="data-card pa-4">
                <MudText Typo="Typo.h6" Class="mb-3">Quick Actions</MudText>
                <MudStack Row="true" Spacing="3" Wrap="Wrap.Wrap">
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.SwapHoriz"
                               OnClick="@(() => Navigation.NavigateTo("/dealer/transfers"))">New Transfer</MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Secondary"
                               StartIcon="@Icons.Material.Filled.Payments"
                               OnClick="@(() => Navigation.NavigateTo("/dealer/commissions"))">View Commissions</MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Info"
                               StartIcon="@Icons.Material.Filled.PersonAdd"
                               OnClick="@(() => Navigation.NavigateTo("/dealer/registration"))">Dealers</MudButton>
                </MudStack>
            </MudPaper>
        </MudItem>

        <!-- Pending alert -->
        @if (_myPendingCount > 0)
        {
            <MudItem xs="12">
                <MudAlert Severity="Severity.Warning" Variant="Variant.Filled" Dense="true"
                          Class="cursor-pointer" OnClick="@(() => Navigation.NavigateTo("/dealer/transfers"))">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudText>You have <strong>@_myPendingCount</strong> transfer(s) pending approval.</MudText>
                        <MudButton Variant="Variant.Text" Color="Color.Inherit" Size="Size.Small"
                                   EndIcon="@Icons.Material.Filled.ArrowForward">View</MudButton>
                    </MudStack>
                </MudAlert>
            </MudItem>
        }

        <!-- Transfer Status Chart -->
        <MudItem xs="12" md="5">
            <MudPaper Elevation="0" Class="data-card pa-4">
                <MudText Typo="Typo.h6" Class="mb-3">Transfer Status</MudText>
                @if (_myTransferCount > 0)
                {
                    <div style="height:260px; display:flex; justify-content:center;">
                        <canvas id="dealerTransferStatusChart"></canvas>
                    </div>
                }
                else
                {
                    <div style="text-align:center; padding:40px 0;">
                        <MudIcon Icon="@Icons.Material.Outlined.PieChart" Size="Size.Large" Color="Color.Secondary" />
                        <MudText Color="Color.Secondary" Class="mt-2">No transfers yet</MudText>
                    </div>
                }
            </MudPaper>
        </MudItem>

        <!-- Recent Transfers -->
        <MudItem xs="12" md="7">
            <MudPaper Elevation="0" Class="data-card pa-4">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
                    <MudText Typo="Typo.h6">Recent Transfers</MudText>
                    <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small"
                               EndIcon="@Icons.Material.Filled.ArrowForward"
                               OnClick="@(() => Navigation.NavigateTo("/dealer/transfers"))">View All</MudButton>
                </MudStack>
                @if (_recentTransfers.Any())
                {
                    <MudSimpleTable Hover="true" Dense="true" Striped="true">
                        <thead>
                            <tr>
                                <th>Dealer</th>
                                <th>Product</th>
                                <th>Loan Amount</th>
                                <th>Commission</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var t in _recentTransfers)
                            {
                                <tr>
                                    <td>@t.DealerName</td>
                                    <td>@t.ProductName</td>
                                    <td style="font-weight:600;">@t.LoanAmount.ToString("C2")</td>
                                    <td style="color:#16A34A; font-weight:600;">@t.CommissionAmount.ToString("C2")</td>
                                    <td>
                                        @{
                                            var tc = t.Status switch
                                            {
                                                DepositStatus.Pending => Color.Warning,
                                                DepositStatus.Approved => Color.Success,
                                                DepositStatus.Rejected => Color.Error,
                                                DepositStatus.Cancelled => Color.Dark,
                                                _ => Color.Default
                                            };
                                        }
                                        <MudChip T="string" Size="Size.Small" Color="@tc">@t.Status</MudChip>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                }
                else
                {
                    <div style="text-align:center; padding:40px 0;">
                        <MudIcon Icon="@Icons.Material.Outlined.SwapHoriz" Size="Size.Large" Color="Color.Secondary" />
                        <MudText Color="Color.Secondary" Class="mt-2">No transfers yet</MudText>
                    </div>
                }
            </MudPaper>
        </MudItem>

        <!-- Commission by Product -->
        <MudItem xs="12">
            <MudPaper Elevation="0" Class="data-card pa-4">
                <MudText Typo="Typo.h6" Class="mb-3">Commission by Product</MudText>
                @if (_dealerProductRates.Any())
                {
                    <MudSimpleTable Hover="true" Dense="true" Striped="true">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th style="text-align:right;">Commission Rate</th>
                                <th style="text-align:right;">Total Transfers</th>
                                <th style="text-align:right;">Commission Earned</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var row in _commissionRows)
                            {
                                <tr>
                                    <td>@row.ProductName</td>
                                    <td style="text-align:right; font-weight:600;">@row.Rate.ToString("N2")%</td>
                                    <td style="text-align:right;">@row.TransferCount</td>
                                    <td style="text-align:right; font-weight:600; color:#16A34A;">@row.CommissionEarned.ToString("C2")</td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                }
                else
                {
                    <div style="text-align:center; padding:30px 0;">
                        <MudText Color="Color.Secondary">No commission data available</MudText>
                    </div>
                }
            </MudPaper>
        </MudItem>

    </MudGrid>
}
else if (_isCashier)
{
    <!-- ─── CASHIER DASHBOARD ─── -->
    <MudGrid Spacing="4">

        <!-- Stat Cards -->
        <MudItem xs="12" sm="6" md="3">
            <MudCard Class="stat-card" Elevation="0" Style="border-left: 4px solid #16A34A !important;"
                     @onclick="@(() => Navigation.NavigateTo("/cashier/deposits"))">
                <MudCardContent>
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <div>
                            <MudText Typo="Typo.overline" Color="Color.Secondary">CASH DEPOSITS</MudText>
                            <MudText Typo="Typo.h4">@_cashDepositCount</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Success">@_totalCashDeposits.ToString("C2") total</MudText>
                        </div>
                        <MudAvatar Color="Color.Success" Variant="Variant.Outlined" Size="Size.Large">
                            <MudIcon Icon="@Icons.Material.Filled.AttachMoney" />
                        </MudAvatar>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudCard Class="stat-card" Elevation="0" Style="border-left: 4px solid #0284C7 !important;"
                     @onclick="@(() => Navigation.NavigateTo("/cashier/deposits"))">
                <MudCardContent>
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <div>
                            <MudText Typo="Typo.overline" Color="Color.Secondary">TODAY'S DEPOSITS</MudText>
                            <MudText Typo="Typo.h4">@_todayDepositCount</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Info">@_todayDepositAmount.ToString("C2") today</MudText>
                        </div>
                        <MudAvatar Color="Color.Info" Variant="Variant.Outlined" Size="Size.Large">
                            <MudIcon Icon="@Icons.Material.Filled.Today" />
                        </MudAvatar>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudCard Class="stat-card" Elevation="0" Style="border-left: 4px solid #D97706 !important;"
                     @onclick="@(() => Navigation.NavigateTo("/cashier/expenses"))">
                <MudCardContent>
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <div>
                            <MudText Typo="Typo.overline" Color="Color.Secondary">PENDING EXPENSES</MudText>
                            <MudText Typo="Typo.h4">@_pendingExpensesCount</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Warning">awaiting approval</MudText>
                        </div>
                        <MudAvatar Color="Color.Warning" Variant="Variant.Outlined" Size="Size.Large">
                            <MudIcon Icon="@Icons.Material.Filled.Receipt" />
                        </MudAvatar>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudCard Class="stat-card" Elevation="0" Style="border-left: 4px solid #3B82F6 !important;"
                     @onclick="@(() => Navigation.NavigateTo("/cashier/balances"))">
                <MudCardContent>
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <div>
                            <MudText Typo="Typo.overline" Color="Color.Secondary">APPROVED EXPENSES</MudText>
                            <MudText Typo="Typo.h5" Style="font-weight:700;">@_approvedExpensesAmount.ToString("C2")</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">total approved</MudText>
                        </div>
                        <MudAvatar Color="Color.Primary" Variant="Variant.Outlined" Size="Size.Large">
                            <MudIcon Icon="@Icons.Material.Filled.AccountBalance" />
                        </MudAvatar>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Quick Actions -->
        <MudItem xs="12">
            <MudPaper Elevation="0" Class="data-card pa-4">
                <MudText Typo="Typo.h6" Class="mb-3">Quick Actions</MudText>
                <MudStack Row="true" Spacing="3" Wrap="Wrap.Wrap">
                    <MudButton Variant="Variant.Outlined" Color="Color.Success"
                               StartIcon="@Icons.Material.Filled.AttachMoney"
                               OnClick="@(() => Navigation.NavigateTo("/cashier/deposits"))">New Cash Deposit</MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Warning"
                               StartIcon="@Icons.Material.Filled.Receipt"
                               OnClick="@(() => Navigation.NavigateTo("/cashier/expenses"))">New Expense</MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Info"
                               StartIcon="@Icons.Material.Filled.AccountBalance"
                               OnClick="@(() => Navigation.NavigateTo("/cashier/balances"))">Dealer Balances</MudButton>
                </MudStack>
            </MudPaper>
        </MudItem>

        <!-- Pending Expense Alert -->
        @if (_pendingExpensesCount > 0)
        {
            <MudItem xs="12">
                <MudAlert Severity="Severity.Warning" Variant="Variant.Filled" Dense="true"
                          Class="cursor-pointer" OnClick="@(() => Navigation.NavigateTo("/cashier/expenses"))">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudText><strong>@_pendingExpensesCount</strong> expense(s) are pending approval.</MudText>
                        <MudButton Variant="Variant.Text" Color="Color.Inherit" Size="Size.Small"
                                   EndIcon="@Icons.Material.Filled.ArrowForward">View</MudButton>
                    </MudStack>
                </MudAlert>
            </MudItem>
        }

        <!-- Expense Status Chart -->
        <MudItem xs="12" md="5">
            <MudPaper Elevation="0" Class="data-card pa-4">
                <MudText Typo="Typo.h6" Class="mb-3">Expense Status</MudText>
                @if (_pendingExpensesCount + _approvedExpensesCount + _rejectedExpensesCount > 0)
                {
                    <div style="height:260px; display:flex; justify-content:center;">
                        <canvas id="cashierExpenseStatusChart"></canvas>
                    </div>
                }
                else
                {
                    <div style="text-align:center; padding:40px 0;">
                        <MudIcon Icon="@Icons.Material.Outlined.PieChart" Size="Size.Large" Color="Color.Secondary" />
                        <MudText Color="Color.Secondary" Class="mt-2">No expense data yet</MudText>
                    </div>
                }
            </MudPaper>
        </MudItem>

        <!-- Recent Cash Deposits -->
        <MudItem xs="12" md="7">
            <MudPaper Elevation="0" Class="data-card pa-4">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
                    <MudText Typo="Typo.h6">Recent Cash Deposits</MudText>
                    <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small"
                               EndIcon="@Icons.Material.Filled.ArrowForward"
                               OnClick="@(() => Navigation.NavigateTo("/cashier/deposits"))">View All</MudButton>
                </MudStack>
                @if (_recentCashDeposits.Any())
                {
                    <MudSimpleTable Hover="true" Dense="true" Striped="true">
                        <thead>
                            <tr>
                                <th>Dealer</th>
                                <th>Branch</th>
                                <th>Date</th>
                                <th style="text-align:right;">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var d in _recentCashDeposits)
                            {
                                <tr>
                                    <td>@d.DealerName</td>
                                    <td>@d.BranchName</td>
                                    <td>@d.DepositDate.ToString("dd MMM HH:mm")</td>
                                    <td style="text-align:right; font-weight:600;">@d.Amount.ToString("C2")</td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                }
                else
                {
                    <div style="text-align:center; padding:40px 0;">
                        <MudIcon Icon="@Icons.Material.Outlined.Paid" Size="Size.Large" Color="Color.Secondary" />
                        <MudText Color="Color.Secondary" Class="mt-2">No cash deposits yet</MudText>
                    </div>
                }
            </MudPaper>
        </MudItem>

        <!-- Deposits by Category breakdown -->
        <MudItem xs="12">
            <MudPaper Elevation="0" Class="data-card pa-4">
                <MudText Typo="Typo.h6" Class="mb-3">Expenses by Category</MudText>
                @if (_expensesByCategory.Any())
                {
                    <MudSimpleTable Hover="true" Dense="true" Striped="true">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th style="text-align:right;">Count</th>
                                <th style="text-align:right;">Total Amount</th>
                                <th style="text-align:right;">Approved</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var row in _expensesByCategory)
                            {
                                <tr>
                                    <td>@row.Category</td>
                                    <td style="text-align:right;">@row.Count</td>
                                    <td style="text-align:right; font-weight:600;">@row.Total.ToString("C2")</td>
                                    <td style="text-align:right; color:#16A34A; font-weight:600;">@row.Approved.ToString("C2")</td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                }
                else
                {
                    <div style="text-align:center; padding:30px 0;">
                        <MudText Color="Color.Secondary">No expense records yet</MudText>
                    </div>
                }
            </MudPaper>
        </MudItem>

    </MudGrid>
}
else
{
    <!-- ─── ADMIN / SUPERADMIN DASHBOARD ─── -->
    <MudGrid Spacing="4">

        <!-- Summary Cards -->
        <MudItem xs="12" sm="6" md="3">
            <MudCard Class="stat-card" Elevation="0" Style="border-left: 4px solid #F59E0B !important;"
                     @onclick="@(() => Navigation.NavigateTo("/dealer/registration"))">
                <MudCardContent>
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <div>
                            <MudText Typo="Typo.overline" Color="Color.Secondary">DEALERS</MudText>
                            <MudText Typo="Typo.h4">@_dealerCount</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Info">registered</MudText>
                        </div>
                        <MudAvatar Color="Color.Secondary" Variant="Variant.Outlined" Size="Size.Large">
                            <MudIcon Icon="@Icons.Material.Filled.People" />
                        </MudAvatar>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudCard Class="stat-card" Elevation="0" Style="border-left: 4px solid #0284C7 !important;"
                     @onclick="@(() => Navigation.NavigateTo("/dealer/transfers"))">
                <MudCardContent>
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <div>
                            <MudText Typo="Typo.overline" Color="Color.Secondary">TRANSFERS</MudText>
                            <MudText Typo="Typo.h4">@_transferCount</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Info">@_totalTransferAmount.ToString("C6")</MudText>
                        </div>
                        <MudAvatar Color="Color.Info" Variant="Variant.Outlined" Size="Size.Large">
                            <MudIcon Icon="@Icons.Material.Filled.SwapHoriz" />
                        </MudAvatar>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudCard Class="stat-card" Elevation="0" Style="border-left: 4px solid #16A34A !important;"
                     @onclick="@(() => Navigation.NavigateTo("/cashier/deposits"))">
                <MudCardContent>
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <div>
                            <MudText Typo="Typo.overline" Color="Color.Secondary">CASH DEPOSITS</MudText>
                            <MudText Typo="Typo.h4">@_cashDepositCount</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Success">@_totalCashDeposits.ToString("C6")</MudText>
                        </div>
                        <MudAvatar Color="Color.Success" Variant="Variant.Outlined" Size="Size.Large">
                            <MudIcon Icon="@Icons.Material.Filled.AttachMoney" />
                        </MudAvatar>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudCard Class="stat-card" Elevation="0" Style="border-left: 4px solid #3B82F6 !important;"
                     @onclick="@(() => Navigation.NavigateTo("/cashier/balances"))">
                <MudCardContent>
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <div>
                            <MudText Typo="Typo.overline" Color="Color.Secondary">TOTAL BALANCE</MudText>
                            <MudText Typo="Typo.h5" Style="@($"font-weight:700;{(_totalBalance < 0 ? "color:#EF4444;" : "")}")">
                                @(_totalBalance < 0 ? $"-{Math.Abs(_totalBalance).ToString("C2")}" : _totalBalance.ToString("C2"))
                            </MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Deposits − Transfers</MudText>
                        </div>
                        <MudAvatar Color="Color.Primary" Variant="Variant.Outlined" Size="Size.Large">
                            <MudIcon Icon="@Icons.Material.Filled.AccountBalance" />
                        </MudAvatar>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Analytics Quick-Glance Cards -->
        <MudItem xs="12" sm="6" md="3">
            <MudCard Class="stat-card" Elevation="0" Style="border-left: 4px solid #0D9488 !important;"
                     @onclick="@(() => Navigation.NavigateTo("/admin/analytics"))">
                <MudCardContent>
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <div>
                            <MudText Typo="Typo.overline" Color="Color.Secondary">STOCK VALUE</MudText>
                            <MudText Typo="Typo.h5" Style="font-weight:700;">@_currentStockValue.ToString("C2")</MudText>
                            <MudText Typo="Typo.caption" Style="color:#0D9488;">@_stockUtilization.ToString("N1")% utilized</MudText>
                        </div>
                        <MudAvatar Style="color:#0D9488; border-color:#0D9488;" Variant="Variant.Outlined" Size="Size.Large">
                            <MudIcon Icon="@Icons.Material.Filled.Inventory2" />
                        </MudAvatar>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudCard Class="stat-card" Elevation="0" Style="border-left: 4px solid #7C3AED !important;"
                     @onclick="@(() => Navigation.NavigateTo("/admin/analytics"))">
                <MudCardContent>
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <div>
                            <MudText Typo="Typo.overline" Color="Color.Secondary">NET CAPITAL</MudText>
                            <MudText Typo="Typo.h5" Style="@($"font-weight:700;{(_netCapital < 0 ? "color:#EF4444;" : "")}")">
                                @(_netCapital < 0 ? $"-{Math.Abs(_netCapital).ToString("C2")}" : _netCapital.ToString("C2"))
                            </MudText>
                            <MudText Typo="Typo.caption" Style="@(_grossProfit >= 0 ? "color:#16A34A;" : "color:#EF4444;")">
                                Profit: @_grossProfit.ToString("C2")
                            </MudText>
                        </div>
                        <MudAvatar Style="color:#7C3AED; border-color:#7C3AED;" Variant="Variant.Outlined" Size="Size.Large">
                            <MudIcon Icon="@Icons.Material.Filled.TrendingUp" />
                        </MudAvatar>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Quick Actions -->
        <MudItem xs="12">
            <MudPaper Elevation="0" Class="data-card pa-4">
                <MudText Typo="Typo.h6" Class="mb-3">Quick Actions</MudText>
                <MudStack Row="true" Spacing="3" Wrap="Wrap.Wrap">
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.SwapHoriz"
                               OnClick="@(() => Navigation.NavigateTo("/dealer/transfers"))">New Transfer</MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Success"
                               StartIcon="@Icons.Material.Filled.AttachMoney"
                               OnClick="@(() => Navigation.NavigateTo("/cashier/deposits"))">Cash Deposit</MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Warning"
                               StartIcon="@Icons.Material.Filled.AccountBalanceWallet"
                               OnClick="@(() => Navigation.NavigateTo("/admin/deposits"))">Airtime Deposit</MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Info"
                               StartIcon="@Icons.Material.Filled.PersonAdd"
                               OnClick="@(() => Navigation.NavigateTo("/dealer/registration"))">Register Dealer</MudButton>
                </MudStack>
            </MudPaper>
        </MudItem>

        <!-- Pending Approvals Alerts -->
        @if (_pendingDepositsCount > 0)
        {
            <MudItem xs="12" md="6">
                <MudAlert Severity="Severity.Warning" Variant="Variant.Filled" Dense="true"
                          Class="cursor-pointer" OnClick="@(() => Navigation.NavigateTo("/admin/approvals"))">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudText>You have <strong>@_pendingDepositsCount</strong> airtime deposit(s) pending approval.</MudText>
                        <MudButton Variant="Variant.Text" Color="Color.Inherit" Size="Size.Small"
                                   EndIcon="@Icons.Material.Filled.ArrowForward">Review</MudButton>
                    </MudStack>
                </MudAlert>
            </MudItem>
        }

        @if (_pendingTransfersCount > 0)
        {
            <MudItem xs="12" md="6">
                <MudAlert Severity="Severity.Info" Variant="Variant.Filled" Dense="true"
                          Class="cursor-pointer" OnClick="@(() => Navigation.NavigateTo("/admin/transfer-approvals"))">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudText>You have <strong>@_pendingTransfersCount</strong> airtime transfer(s) pending approval.</MudText>
                        <MudButton Variant="Variant.Text" Color="Color.Inherit" Size="Size.Small"
                                   EndIcon="@Icons.Material.Filled.ArrowForward">Review</MudButton>
                    </MudStack>
                </MudAlert>
            </MudItem>
        }

        <!-- Product Balances -->
        <MudItem xs="12" md="6">
            <MudPaper Elevation="0" Class="data-card pa-4">
                <MudText Typo="Typo.h6" Class="mb-3">Product Balances</MudText>
                @if (_products.Any())
                {
                    <MudSimpleTable Hover="true" Dense="true" Striped="true">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Bonus %</th>
                                <th style="text-align:right;">Balance</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var product in _products)
                            {
                                <tr>
                                    <td>@product.Name</td>
                                    <td>@product.BonusPercentage.ToString("N6")%</td>
                                    <td style="text-align:right; font-weight:600;">@product.AirtimeAccountBalance.ToString("C6")</td>
                                    <td>
                                        <MudChip T="string" Size="Size.Small"
                                                 Color="@(product.IsActive ? Color.Success : Color.Error)">
                                            @(product.IsActive ? "Active" : "Inactive")
                                        </MudChip>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                }
                else
                {
                    <div style="text-align:center; padding:40px 0;">
                        <MudIcon Icon="@Icons.Material.Outlined.Inventory2" Size="Size.Large" Color="Color.Secondary" />
                        <MudText Color="Color.Secondary" Class="mt-2">No products configured yet</MudText>
                        <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small" Class="mt-1"
                                   OnClick="@(() => Navigation.NavigateTo("/admin/products"))">Add Product</MudButton>
                    </div>
                }
            </MudPaper>
        </MudItem>

        <!-- Deposit Status Chart -->
        <MudItem xs="12" md="6">
            <MudPaper Elevation="0" Class="data-card pa-4">
                <MudText Typo="Typo.h6" Class="mb-3">Deposit Status Distribution</MudText>
                @if (_pendingDepositsCount + _approvedDepositsCount + _rejectedDepositsCount + _cancelledDepositsCount > 0)
                {
                    <div style="height:260px; display:flex; justify-content:center;">
                        <canvas id="adminDepositStatusChart"></canvas>
                    </div>
                    <MudDivider Class="my-3" />
                    <MudStack Row="true" Justify="Justify.SpaceBetween">
                        <MudText Typo="Typo.subtitle1"><strong>Total Approved Value</strong></MudText>
                        <MudText Typo="Typo.subtitle1" Color="Color.Success"><strong>@_totalApprovedValue.ToString("C6")</strong></MudText>
                    </MudStack>
                }
                else
                {
                    <div style="text-align:center; padding:40px 0;">
                        <MudIcon Icon="@Icons.Material.Outlined.PieChart" Size="Size.Large" Color="Color.Secondary" />
                        <MudText Color="Color.Secondary" Class="mt-2">No deposit data yet</MudText>
                    </div>
                }
            </MudPaper>
        </MudItem>

        <!-- Recent Transfers -->
        <MudItem xs="12" md="6">
            <MudPaper Elevation="0" Class="data-card pa-4">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
                    <MudText Typo="Typo.h6">Recent Transfers</MudText>
                    <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small"
                               EndIcon="@Icons.Material.Filled.ArrowForward"
                               OnClick="@(() => Navigation.NavigateTo("/dealer/transfers"))">View All</MudButton>
                </MudStack>
                @if (_recentTransfers.Any())
                {
                    <MudSimpleTable Hover="true" Dense="true" Striped="true">
                        <thead>
                            <tr>
                                <th>Dealer</th>
                                <th>Product</th>
                                <th>Status</th>
                                <th style="text-align:right;">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var t in _recentTransfers)
                            {
                                <tr>
                                    <td>@t.DealerName</td>
                                    <td>@t.ProductName</td>
                                    <td>
                                        @{
                                            var tColor = t.Status switch
                                            {
                                                DepositStatus.Pending => Color.Warning,
                                                DepositStatus.Approved => Color.Success,
                                                DepositStatus.Rejected => Color.Error,
                                                DepositStatus.Cancelled => Color.Dark,
                                                _ => Color.Default
                                            };
                                        }
                                        <MudChip T="string" Size="Size.Small" Color="@tColor">@t.Status</MudChip>
                                    </td>
                                    <td style="text-align:right;">@t.Amount.ToString("C6")</td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                }
                else
                {
                    <div style="text-align:center; padding:40px 0;">
                        <MudIcon Icon="@Icons.Material.Outlined.SwapHoriz" Size="Size.Large" Color="Color.Secondary" />
                        <MudText Color="Color.Secondary" Class="mt-2">No transfers yet</MudText>
                    </div>
                }
            </MudPaper>
        </MudItem>

        <!-- Branches -->
        <MudItem xs="12" md="6">
            <MudPaper Elevation="0" Class="data-card pa-4">
                <MudText Typo="Typo.h6" Class="mb-3">Branches</MudText>
                @if (_branches.Any())
                {
                    <MudSimpleTable Hover="true" Dense="true" Striped="true">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Location</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var b in _branches)
                            {
                                <tr>
                                    <td>@b.Name</td>
                                    <td>@b.Location</td>
                                    <td>
                                        <MudChip T="string" Size="Size.Small"
                                                 Color="@(b.IsActive ? Color.Success : Color.Error)">
                                            @(b.IsActive ? "Active" : "Inactive")
                                        </MudChip>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                }
                else
                {
                    <div style="text-align:center; padding:40px 0;">
                        <MudIcon Icon="@Icons.Material.Outlined.Store" Size="Size.Large" Color="Color.Secondary" />
                        <MudText Color="Color.Secondary" Class="mt-2">No branches configured yet</MudText>
                        <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small" Class="mt-1"
                                   OnClick="@(() => Navigation.NavigateTo("/admin/branches"))">Add Branch</MudButton>
                    </div>
                }
            </MudPaper>
        </MudItem>

        <!-- Monthly Transfers Chart -->
        <MudItem xs="12">
            <MudPaper Elevation="0" Class="data-card pa-4">
                <MudText Typo="Typo.h6" Class="mb-3">Monthly Activity (Last 6 Months)</MudText>
                @if (_monthlyLabels.Length > 0)
                {
                    <div style="height:280px;">
                        <canvas id="adminMonthlyChart"></canvas>
                    </div>
                }
                else
                {
                    <div style="text-align:center; padding:40px 0;">
                        <MudIcon Icon="@Icons.Material.Outlined.BarChart" Size="Size.Large" Color="Color.Secondary" />
                        <MudText Color="Color.Secondary" Class="mt-2">No monthly data yet</MudText>
                    </div>
                }
            </MudPaper>
        </MudItem>

        <!-- Recent Activity -->
        <MudItem xs="12">
            <MudPaper Elevation="0" Class="data-card pa-4">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
                    <MudText Typo="Typo.h6">Recent Activity</MudText>
                    <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small"
                               EndIcon="@Icons.Material.Filled.ArrowForward"
                               OnClick="@(() => Navigation.NavigateTo("/superadmin/audit"))">View All</MudButton>
                </MudStack>
                @if (_recentAuditLogs.Any())
                {
                    <MudTimeline TimelineOrientation="TimelineOrientation.Vertical" TimelinePosition="TimelinePosition.Start">
                        @foreach (var log in _recentAuditLogs)
                        {
                            <MudTimelineItem Color="@GetAuditColor(log.Action)" Size="Size.Small">
                                <MudStack Spacing="0">
                                    <MudText Typo="Typo.body2"><strong>@log.Action</strong> @log.EntityName #@log.EntityId</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        @(log.UserName ?? "System") &mdash; @log.Timestamp.ToString("dd MMM yyyy HH:mm")
                                    </MudText>
                                </MudStack>
                            </MudTimelineItem>
                        }
                    </MudTimeline>
                }
                else
                {
                    <div style="text-align:center; padding:40px 0;">
                        <MudIcon Icon="@Icons.Material.Outlined.Timeline" Size="Size.Large" Color="Color.Secondary" />
                        <MudText Color="Color.Secondary" Class="mt-2">No activity recorded yet</MudText>
                    </div>
                }
            </MudPaper>
        </MudItem>

    </MudGrid>
}

@code {
    // ── Role flags ──
    private bool _loading = true;
    private bool _isDealer;
    private bool _isCashier;
    private string _userName = "User";
    private string _roleSubtitle = "Here's what's happening in your airtime distribution system";

    // ── Admin / shared ──
    private List<ProductDto> _products = new();
    private List<BranchDto> _branches = new();
    private List<AirtimeTransferDto> _recentTransfers = new();
    private List<AuditLogDto> _recentAuditLogs = new();
    private int _dealerCount, _transferCount, _cashDepositCount;
    private int _pendingDepositsCount, _approvedDepositsCount, _rejectedDepositsCount, _cancelledDepositsCount;
    private int _pendingTransfersCount;
    private decimal _totalTransferAmount, _totalCashDeposits, _totalApprovedValue, _totalBalance;
    private decimal _currentStockValue, _stockUtilization, _netCapital, _grossProfit;
    private string[] _monthlyLabels = [];
    private double[] _monthlyTransferAmounts = [];
    private double[] _monthlyCashDepositAmounts = [];

    // ── Dealer ──
    private List<DealerProductRateDto> _dealerProductRates = new();
    private int _myTransferCount, _myPendingCount, _myApprovedCount, _myRejectedCount, _myCancelledCount;
    private decimal _myApprovedAmount, _myTotalCommission;
    private List<CommissionRow> _commissionRows = new();
    private record CommissionRow(string ProductName, decimal Rate, int TransferCount, decimal CommissionEarned);

    // ── Cashier ──
    private List<CashDepositDto> _recentCashDeposits = new();
    private int _todayDepositCount, _pendingExpensesCount, _approvedExpensesCount, _rejectedExpensesCount;
    private decimal _todayDepositAmount, _approvedExpensesAmount;
    private List<ExpenseCategoryRow> _expensesByCategory = new();
    private record ExpenseCategoryRow(string Category, int Count, decimal Total, decimal Approved);

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var principal = authState.User;
        _isDealer = principal.IsInRole("Dealer") && !principal.IsInRole("SystemAdmin") && !principal.IsInRole("SuperAdministrator");
        _isCashier = principal.IsInRole("Cashier") && !principal.IsInRole("SystemAdmin") && !principal.IsInRole("SuperAdministrator") && !_isDealer;

        if (_isDealer)
            _roleSubtitle = "Here's an overview of your airtime transfers and commissions";
        else if (_isCashier)
            _roleSubtitle = "Here's your cashier activity overview";
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        try
        {
            var user = await UserManager.FindByIdAsync(CurrentUser.UserId ?? "");
            _userName = user?.FullName ?? CurrentUser.UserName ?? "User";

            if (_isDealer)
                await LoadDealerData();
            else if (_isCashier)
                await LoadCashierData();
            else
                await LoadAdminData();
        }
        catch
        {
            // Dashboard should not crash on data errors
        }
        finally
        {
            _loading = false;
            StateHasChanged();
            await Task.Yield(); // let Blazor render the canvases
            await RenderChartsAsync();
        }
    }

    private async Task RenderChartsAsync()
    {
        try
        {
            if (_isDealer && _myTransferCount > 0)
            {
                await JS.InvokeVoidAsync("chartInterop.createDoughnut", "dealerTransferStatusChart",
                    new[] { $"Pending ({_myPendingCount})", $"Approved ({_myApprovedCount})", $"Rejected ({_myRejectedCount})", $"Cancelled ({_myCancelledCount})" },
                    new double[] { _myPendingCount, _myApprovedCount, _myRejectedCount, _myCancelledCount },
                    new[] { "#D97706", "#16A34A", "#DC2626", "#6B7280" });
            }
            else if (_isCashier && (_pendingExpensesCount + _approvedExpensesCount + _rejectedExpensesCount > 0))
            {
                await JS.InvokeVoidAsync("chartInterop.createDoughnut", "cashierExpenseStatusChart",
                    new[] { $"Pending ({_pendingExpensesCount})", $"Approved ({_approvedExpensesCount})", $"Rejected ({_rejectedExpensesCount})" },
                    new double[] { _pendingExpensesCount, _approvedExpensesCount, _rejectedExpensesCount },
                    new[] { "#D97706", "#16A34A", "#DC2626" });
            }
            else if (!_isDealer && !_isCashier)
            {
                // Admin charts
                if (_pendingDepositsCount + _approvedDepositsCount + _rejectedDepositsCount + _cancelledDepositsCount > 0)
                {
                    await JS.InvokeVoidAsync("chartInterop.createDoughnut", "adminDepositStatusChart",
                        new[] { $"Pending ({_pendingDepositsCount})", $"Approved ({_approvedDepositsCount})", $"Rejected ({_rejectedDepositsCount})", $"Cancelled ({_cancelledDepositsCount})" },
                        new double[] { _pendingDepositsCount, _approvedDepositsCount, _rejectedDepositsCount, _cancelledDepositsCount },
                        new[] { "#D97706", "#16A34A", "#DC2626", "#6B7280" });
                }

                if (_monthlyLabels.Length > 0)
                {
                    await JS.InvokeVoidAsync("chartInterop.createBar", "adminMonthlyChart",
                        _monthlyLabels,
                        new object[]
                        {
                            new { label = "Transfers", data = _monthlyTransferAmounts, color = "#0284C7" },
                            new { label = "Cash Deposits", data = _monthlyCashDepositAmounts, color = "#16A34A" }
                        },
                        false);
                }
            }
        }
        catch
        {
            // Chart rendering should not crash the dashboard
        }
    }

    private async Task<T> RunInScope<T>(Func<IServiceProvider, Task<T>> work)
    {
        using var scope = ScopeFactory.CreateScope();
        return await work(scope.ServiceProvider);
    }

    private async Task LoadAdminData()
    {
        var productsTask = RunInScope(sp => sp.GetRequiredService<IProductService>().GetAllProductsAsync());
        var dealersTask = RunInScope(sp => sp.GetRequiredService<IDealerService>().GetAllDealersAsync());
        var transfersTask = RunInScope(sp => sp.GetRequiredService<IAirtimeTransferService>().GetAllTransfersAsync());
        var cashDepositsTask = RunInScope(sp => sp.GetRequiredService<ICashDepositService>().GetAllDepositsAsync());
        var airtimeDepositsTask = RunInScope(sp => sp.GetRequiredService<IAirtimeDepositService>().GetAllDepositsAsync());
        var branchesTask = RunInScope(sp => sp.GetRequiredService<IBranchService>().GetAllBranchesAsync());
        var auditTask = RunInScope(sp => sp.GetRequiredService<IAuditLogService>().GetRecentLogsAsync(8));
        var expensesTask = RunInScope(sp => sp.GetRequiredService<IExpenseService>().GetAllExpensesAsync());

        await Task.WhenAll(productsTask, dealersTask, transfersTask, cashDepositsTask, airtimeDepositsTask, branchesTask, auditTask, expensesTask);

        _products = productsTask.Result.ToList();
        _dealerCount = dealersTask.Result.Count;

        var transfers = transfersTask.Result;
        _transferCount = transfers.Count;
        _totalTransferAmount = transfers.Where(t => t.Status == DepositStatus.Approved).Sum(t => t.LoanAmount);
        _recentTransfers = transfers.OrderByDescending(t => t.CreatedDate).Take(5).ToList();
        _pendingTransfersCount = transfers.Count(t => t.Status == DepositStatus.Pending);

        var cashDeposits = cashDepositsTask.Result;
        _cashDepositCount = cashDeposits.Count;
        _totalCashDeposits = cashDeposits.Sum(d => d.Amount);
        _totalBalance = _totalCashDeposits - _totalTransferAmount;

        var airtimeDeposits = airtimeDepositsTask.Result;
        _pendingDepositsCount = airtimeDeposits.Count(d => d.Status == DepositStatus.Pending);
        _approvedDepositsCount = airtimeDeposits.Count(d => d.Status == DepositStatus.Approved);
        _rejectedDepositsCount = airtimeDeposits.Count(d => d.Status == DepositStatus.Rejected);
        _cancelledDepositsCount = airtimeDeposits.Count(d => d.Status == DepositStatus.Cancelled);
        _totalApprovedValue = airtimeDeposits.Where(d => d.Status == DepositStatus.Approved).Sum(d => d.TotalAmount);

        _branches = branchesTask.Result.ToList();
        _recentAuditLogs = auditTask.Result.ToList();

        // Monthly chart data (last 6 months)
        var now = DateTime.UtcNow;
        var months = Enumerable.Range(0, 6).Select(i => now.AddMonths(-5 + i)).ToArray();
        _monthlyLabels = months.Select(m => m.ToString("MMM yyyy")).ToArray();
        _monthlyTransferAmounts = months.Select(m =>
            (double)transfers.Where(t => t.CreatedDate.Year == m.Year && t.CreatedDate.Month == m.Month)
                .Sum(t => t.Amount)).ToArray();
        _monthlyCashDepositAmounts = months.Select(m =>
            (double)cashDeposits.Where(d => d.DepositDate.Year == m.Year && d.DepositDate.Month == m.Month)
                .Sum(d => d.Amount)).ToArray();

        // Analytics quick-glance
        _currentStockValue = _products.Sum(p => p.AirtimeAccountBalance);
        var totalPurchased = airtimeDeposits.Where(d => d.Status == DepositStatus.Approved).Sum(d => d.TotalAmount);
        var totalDistributed = transfers.Where(t => t.Status == DepositStatus.Approved).Sum(t => t.LoanAmount);
        _stockUtilization = totalPurchased > 0 ? totalDistributed / totalPurchased * 100 : 0;
        var totalInvestment = airtimeDeposits.Where(d => d.Status == DepositStatus.Approved).Sum(d => d.Amount);
        var totalExpenses = expensesTask.Result.Where(e => e.Status == DepositStatus.Approved).Sum(e => e.Amount);
        _netCapital = _totalCashDeposits + _currentStockValue - totalExpenses;
        _grossProfit = _totalCashDeposits - totalInvestment - totalExpenses;
    }

    private async Task LoadDealerData()
    {
        var transfersTask = RunInScope(sp => sp.GetRequiredService<IAirtimeTransferService>().GetAllTransfersAsync());
        var ratesTask = RunInScope(sp => sp.GetRequiredService<IDealerService>().GetAllDealerProductRatesAsync());
        var productsTask = RunInScope(sp => sp.GetRequiredService<IProductService>().GetAllProductsAsync());

        await Task.WhenAll(transfersTask, ratesTask, productsTask);

        var transfers = transfersTask.Result;
        _myTransferCount = transfers.Count;
        _myPendingCount = transfers.Count(t => t.Status == DepositStatus.Pending);
        _myApprovedCount = transfers.Count(t => t.Status == DepositStatus.Approved);
        _myRejectedCount = transfers.Count(t => t.Status == DepositStatus.Rejected);
        _myCancelledCount = transfers.Count(t => t.Status == DepositStatus.Cancelled);
        _myApprovedAmount = transfers.Where(t => t.Status == DepositStatus.Approved).Sum(t => t.LoanAmount);
        _myTotalCommission = transfers.Where(t => t.Status == DepositStatus.Approved).Sum(t => t.CommissionAmount);
        _recentTransfers = transfers.OrderByDescending(t => t.CreatedDate).Take(6).ToList();

        _dealerProductRates = ratesTask.Result.ToList();
        var productMap = productsTask.Result.ToDictionary(p => p.Id, p => p.Name);

        _commissionRows = _dealerProductRates
            .GroupBy(r => r.ProductId)
            .Select(g =>
            {
                var productName = productMap.TryGetValue(g.Key, out var n) ? n : $"Product #{g.Key}";
                var rate = g.Average(r => r.CommissionRate);
                var productTransfers = transfers.Where(t => t.ProductId == g.Key).ToList();
                var count = productTransfers.Count(t => t.Status == DepositStatus.Approved);
                var earned = productTransfers.Where(t => t.Status == DepositStatus.Approved).Sum(t => t.CommissionAmount);
                return new CommissionRow(productName, rate, count, earned);
            })
            .OrderByDescending(r => r.CommissionEarned)
            .ToList();
    }

    private async Task LoadCashierData()
    {
        var cashDepositsTask = RunInScope(sp => sp.GetRequiredService<ICashDepositService>().GetAllDepositsAsync());
        var expensesTask = RunInScope(sp => sp.GetRequiredService<IExpenseService>().GetAllExpensesAsync());

        await Task.WhenAll(cashDepositsTask, expensesTask);

        var today = DateTime.UtcNow.Date;
        var cashDeposits = cashDepositsTask.Result;
        _cashDepositCount = cashDeposits.Count;
        _totalCashDeposits = cashDeposits.Sum(d => d.Amount);
        _todayDepositCount = cashDeposits.Count(d => d.DepositDate.Date == today);
        _todayDepositAmount = cashDeposits.Where(d => d.DepositDate.Date == today).Sum(d => d.Amount);
        _recentCashDeposits = cashDeposits.OrderByDescending(d => d.DepositDate).Take(6).ToList();

        var expenses = expensesTask.Result;
        _pendingExpensesCount = expenses.Count(e => e.Status == DepositStatus.Pending);
        _approvedExpensesCount = expenses.Count(e => e.Status == DepositStatus.Approved);
        _rejectedExpensesCount = expenses.Count(e => e.Status == DepositStatus.Rejected);
        _approvedExpensesAmount = expenses.Where(e => e.Status == DepositStatus.Approved).Sum(e => e.Amount);

        _expensesByCategory = expenses
            .GroupBy(e => e.CategoryName)
            .Select(g => new ExpenseCategoryRow(
                g.Key,
                g.Count(),
                g.Sum(e => e.Amount),
                g.Where(e => e.Status == DepositStatus.Approved).Sum(e => e.Amount)))
            .OrderByDescending(r => r.Total)
            .ToList();
    }

    private Color GetAuditColor(string action) => action switch
    {
        "Create" => Color.Success,
        "Update" => Color.Info,
        "Delete" => Color.Error,
        "Approve" => Color.Success,
        "Reject" => Color.Warning,
        _ => Color.Default
    };
}
