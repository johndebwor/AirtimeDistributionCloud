@page "/"
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@using AirtimeDistributionCloud.Application.DTOs
@using AirtimeDistributionCloud.Application.Services
@using AirtimeDistributionCloud.Core.Entities
@using AirtimeDistributionCloud.Core.Enums
@using AirtimeDistributionCloud.Core.Interfaces
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject IServiceScopeFactory ScopeFactory
@using Microsoft.Extensions.DependencyInjection
@rendermode InteractiveServer

<PageTitle>@(Lang?.T("Nav_Dashboard") ?? "Dashboard") - RasidBase</PageTitle>

<div class="dashboard-hero">
    <div class="dashboard-hero-content">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
            <MudAvatar Class="dashboard-hero-avatar" Size="Size.Large">
                <MudIcon Icon="@Icons.Material.Filled.Person" />
            </MudAvatar>
            <div>
                <h1 class="dashboard-hero-title">@(Lang?.T("Dash_WelcomeBack") ?? "Welcome back,") @_userName!</h1>
                <p class="dashboard-hero-subtitle">@_roleSubtitle</p>
            </div>
        </MudStack>
        <div class="dashboard-hero-date">
            <MudIcon Icon="@Icons.Material.Outlined.CalendarToday" Size="Size.Small" />
            <span>@DateTime.Now.ToString("dddd, dd MMM yyyy")</span>
        </div>
    </div>
</div>

@if (_loading)
{
    <MudProgressLinear Indeterminate="true" Color="Color.Primary" Class="mb-4" />
    <MudGrid Spacing="4">
        <MudItem xs="12" sm="6" md="3">
            <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="120px" Style="border-radius:12px;" />
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="120px" Style="border-radius:12px;" />
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="120px" Style="border-radius:12px;" />
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="120px" Style="border-radius:12px;" />
        </MudItem>
        <MudItem xs="12">
            <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="80px" Style="border-radius:12px;" />
        </MudItem>
        <MudItem xs="12" md="6">
            <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="300px" Style="border-radius:12px;" />
        </MudItem>
        <MudItem xs="12" md="6">
            <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="300px" Style="border-radius:12px;" />
        </MudItem>
    </MudGrid>
}
else if (!string.IsNullOrEmpty(_loadError))
{
    <MudAlert Severity="Severity.Error" Variant="Variant.Outlined" Class="mb-4">
        @(Lang?.T("Dash_LoadError") ?? "Failed to load dashboard data.") @_loadError
    </MudAlert>
}
else if (_isDealer)
{
    <!-- ─── DEALER DASHBOARD ─── -->
    <MudGrid Spacing="4">

        <!-- Stat Cards -->
        <MudItem xs="12" sm="6" md="3">
            <div class="stat-card-v2 stat-card-blue" @onclick="@(() => Navigation.NavigateTo("/dealer/transfers"))">
                <div class="stat-card-icon-bg">
                    <MudIcon Icon="@Icons.Material.Filled.SwapHoriz" />
                </div>
                <div class="stat-card-body">
                    <span class="stat-card-label">@(Lang?.T("Dash_MyTransfers") ?? "MY TRANSFERS")</span>
                    <span class="stat-card-value">@_myTransferCount</span>
                    <span class="stat-card-sub">@(Lang?.T("Dash_TotalLabel") ?? "total")</span>
                </div>
            </div>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <div class="stat-card-v2 stat-card-amber">
                <div class="stat-card-icon-bg">
                    <MudIcon Icon="@Icons.Material.Filled.HourglassEmpty" />
                </div>
                <div class="stat-card-body">
                    <span class="stat-card-label">@(Lang?.T("Pending") ?? "PENDING")</span>
                    <span class="stat-card-value">@_myPendingCount</span>
                    <span class="stat-card-sub">@(Lang?.T("Dash_AwaitingApproval") ?? "awaiting approval")</span>
                </div>
            </div>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <div class="stat-card-v2 stat-card-green">
                <div class="stat-card-icon-bg">
                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" />
                </div>
                <div class="stat-card-body">
                    <span class="stat-card-label">@(Lang?.T("Dash_ApprovedAirtime") ?? "APPROVED AIRTIME")</span>
                    <span class="stat-card-value stat-card-value-sm">@_myApprovedAmount.ToString("C2")</span>
                    <span class="stat-card-sub">@(Lang?.T("Dash_LoanAirtimeReceived") ?? "loan airtime received")</span>
                </div>
            </div>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <div class="stat-card-v2 stat-card-violet" @onclick="@(() => Navigation.NavigateTo("/dealer/commissions"))">
                <div class="stat-card-icon-bg">
                    <MudIcon Icon="@Icons.Material.Filled.Payments" />
                </div>
                <div class="stat-card-body">
                    <span class="stat-card-label">@(Lang?.T("Dash_TotalCommission") ?? "TOTAL COMMISSION")</span>
                    <span class="stat-card-value stat-card-value-sm">@_myTotalCommission.ToString("C2")</span>
                    <span class="stat-card-sub">@(Lang?.T("Dash_EarnedToDate") ?? "earned to date")</span>
                </div>
            </div>
        </MudItem>

        <!-- Quick Actions -->
        <MudItem xs="12">
            <MudPaper Elevation="0" Class="data-card pa-4 quick-actions-card">
                <MudText Typo="Typo.subtitle2" Color="Color.Secondary" Style="font-weight:600; text-transform:uppercase; letter-spacing:1px; margin-bottom:12px;">@(Lang?.T("Dash_QuickActions") ?? "Quick Actions")</MudText>
                <MudStack Row="true" Spacing="2" Wrap="Wrap.Wrap">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small"
                               StartIcon="@Icons.Material.Filled.SwapHoriz" Class="quick-action-btn"
                               OnClick="@(() => Navigation.NavigateTo("/dealer/transfers"))">@(Lang?.T("Dash_NewTransfer") ?? "New Transfer")</MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Secondary" Size="Size.Small"
                               StartIcon="@Icons.Material.Filled.Payments" Class="quick-action-btn"
                               OnClick="@(() => Navigation.NavigateTo("/dealer/commissions"))">@(Lang?.T("Dash_ViewCommissions") ?? "View Commissions")</MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Info" Size="Size.Small"
                               StartIcon="@Icons.Material.Filled.PersonAdd" Class="quick-action-btn"
                               OnClick="@(() => Navigation.NavigateTo("/dealer/registration"))">@(Lang?.T("Nav_Dealers") ?? "Dealers")</MudButton>
                </MudStack>
            </MudPaper>
        </MudItem>

        <!-- Pending alert -->
        @if (_myPendingCount > 0)
        {
            <MudItem xs="12">
                <MudAlert Severity="Severity.Warning" Variant="Variant.Filled" Dense="true"
                          Class="cursor-pointer" OnClick="@(() => Navigation.NavigateTo("/dealer/transfers"))">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudText>@(Lang?.T("Dash_PendingTransfersAlert", _myPendingCount) ?? $"You have {_myPendingCount} transfer(s) pending approval.")</MudText>
                        <MudButton Variant="Variant.Text" Color="Color.Inherit" Size="Size.Small"
                                   EndIcon="@Icons.Material.Filled.ArrowForward">@(Lang?.T("View") ?? "View")</MudButton>
                    </MudStack>
                </MudAlert>
            </MudItem>
        }

        <!-- Transfer Status Chart -->
        <MudItem xs="12" md="5">
            <MudPaper Elevation="0" Class="data-card pa-4">
                <MudText Typo="Typo.h6" Class="mb-3">@(Lang?.T("Dash_TransferStatus") ?? "Transfer Status")</MudText>
                @if (_myTransferCount > 0)
                {
                    <div style="height:260px; display:flex; justify-content:center;">
                        <canvas id="dealerTransferStatusChart"></canvas>
                    </div>
                }
                else
                {
                    <div style="text-align:center; padding:40px 0;">
                        <MudIcon Icon="@Icons.Material.Outlined.PieChart" Size="Size.Large" Color="Color.Secondary" />
                        <MudText Color="Color.Secondary" Class="mt-2">@(Lang?.T("Dash_NoTransfersYet") ?? "No transfers yet")</MudText>
                    </div>
                }
            </MudPaper>
        </MudItem>

        <!-- Recent Transfers -->
        <MudItem xs="12" md="7">
            <MudPaper Elevation="0" Class="data-card pa-4">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
                    <MudText Typo="Typo.h6">@(Lang?.T("Dash_RecentTransfers") ?? "Recent Transfers")</MudText>
                    <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small"
                               EndIcon="@Icons.Material.Filled.ArrowForward"
                               OnClick="@(() => Navigation.NavigateTo("/dealer/transfers"))">@(Lang?.T("ViewAll") ?? "View All")</MudButton>
                </MudStack>
                @if (_recentTransfers.Any())
                {
                    <MudSimpleTable Hover="true" Dense="true" Striped="true">
                        <thead>
                            <tr>
                                <th>@(Lang?.T("Dealer") ?? "Dealer")</th>
                                <th>@(Lang?.T("Product") ?? "Product")</th>
                                <th>@(Lang?.T("Dash_LoanAmount") ?? "Loan Amount")</th>
                                <th>@(Lang?.T("Commission") ?? "Commission")</th>
                                <th>@(Lang?.T("Status") ?? "Status")</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var t in _recentTransfers)
                            {
                                <tr>
                                    <td>@t.DealerName</td>
                                    <td>@t.ProductName</td>
                                    <td style="font-weight:600;">@t.LoanAmount.ToString("C2")</td>
                                    <td style="color:#16A34A; font-weight:600;">@t.CommissionAmount.ToString("C2")</td>
                                    <td>
                                        @{
                                            var tc = t.Status switch
                                            {
                                                DepositStatus.Pending => Color.Warning,
                                                DepositStatus.Approved => Color.Success,
                                                DepositStatus.Rejected => Color.Error,
                                                DepositStatus.Cancelled => Color.Dark,
                                                _ => Color.Default
                                            };
                                        }
                                        <MudChip T="string" Size="Size.Small" Color="@tc">@t.Status</MudChip>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                }
                else
                {
                    <div style="text-align:center; padding:40px 0;">
                        <MudIcon Icon="@Icons.Material.Outlined.SwapHoriz" Size="Size.Large" Color="Color.Secondary" />
                        <MudText Color="Color.Secondary" Class="mt-2">@(Lang?.T("Dash_NoTransfersYet") ?? "No transfers yet")</MudText>
                    </div>
                }
            </MudPaper>
        </MudItem>

        <!-- Commission by Product -->
        <MudItem xs="12">
            <MudPaper Elevation="0" Class="data-card pa-4">
                <MudText Typo="Typo.h6" Class="mb-3">@(Lang?.T("Dash_CommissionByProduct") ?? "Commission by Product")</MudText>
                @if (_dealerProductRates.Any())
                {
                    <MudSimpleTable Hover="true" Dense="true" Striped="true">
                        <thead>
                            <tr>
                                <th>@(Lang?.T("Product") ?? "Product")</th>
                                <th style="text-align:right;">@(Lang?.T("Dash_CommissionRate") ?? "Commission Rate")</th>
                                <th style="text-align:right;">@(Lang?.T("Dash_TotalTransfers") ?? "Total Transfers")</th>
                                <th style="text-align:right;">@(Lang?.T("Dash_CommissionEarned") ?? "Commission Earned")</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var row in _commissionRows)
                            {
                                <tr>
                                    <td>@row.ProductName</td>
                                    <td style="text-align:right; font-weight:600;">@row.Rate.ToString("N2")%</td>
                                    <td style="text-align:right;">@row.TransferCount</td>
                                    <td style="text-align:right; font-weight:600; color:#16A34A;">@row.CommissionEarned.ToString("C2")</td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                }
                else
                {
                    <div style="text-align:center; padding:30px 0;">
                        <MudText Color="Color.Secondary">@(Lang?.T("Dash_NoCommissionData") ?? "No commission data available")</MudText>
                    </div>
                }
            </MudPaper>
        </MudItem>

    </MudGrid>
}
else if (_isCashier)
{
    <!-- ─── CASHIER DASHBOARD ─── -->
    <MudGrid Spacing="4">

        <!-- Stat Cards -->
        <MudItem xs="12" sm="6" md="3">
            <div class="stat-card-v2 stat-card-green" @onclick="@(() => Navigation.NavigateTo("/cashier/deposits"))">
                <div class="stat-card-icon-bg">
                    <MudIcon Icon="@Icons.Material.Filled.AttachMoney" />
                </div>
                <div class="stat-card-body">
                    <span class="stat-card-label">@(Lang?.T("Dash_CashDeposits") ?? "CASH DEPOSITS")</span>
                    <span class="stat-card-value">@_cashDepositCount</span>
                    <span class="stat-card-sub">@_totalCashDeposits.ToString("C2") @(Lang?.T("Dash_TotalLabel") ?? "total")</span>
                </div>
            </div>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <div class="stat-card-v2 stat-card-blue" @onclick="@(() => Navigation.NavigateTo("/cashier/deposits"))">
                <div class="stat-card-icon-bg">
                    <MudIcon Icon="@Icons.Material.Filled.Today" />
                </div>
                <div class="stat-card-body">
                    <span class="stat-card-label">@(Lang?.T("Dash_TodaysDeposits") ?? "TODAY'S DEPOSITS")</span>
                    <span class="stat-card-value">@_todayDepositCount</span>
                    <span class="stat-card-sub">@_todayDepositAmount.ToString("C2") @(Lang?.T("Dash_Today") ?? "today")</span>
                </div>
            </div>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <div class="stat-card-v2 stat-card-amber" @onclick="@(() => Navigation.NavigateTo("/cashier/expenses"))">
                <div class="stat-card-icon-bg">
                    <MudIcon Icon="@Icons.Material.Filled.Receipt" />
                </div>
                <div class="stat-card-body">
                    <span class="stat-card-label">@(Lang?.T("Dash_PendingExpenses") ?? "PENDING EXPENSES")</span>
                    <span class="stat-card-value">@_pendingExpensesCount</span>
                    <span class="stat-card-sub">@(Lang?.T("Dash_AwaitingApproval") ?? "awaiting approval")</span>
                </div>
            </div>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <div class="stat-card-v2 stat-card-indigo" @onclick="@(() => Navigation.NavigateTo("/cashier/balances"))">
                <div class="stat-card-icon-bg">
                    <MudIcon Icon="@Icons.Material.Filled.AccountBalance" />
                </div>
                <div class="stat-card-body">
                    <span class="stat-card-label">@(Lang?.T("Dash_ApprovedExpenses") ?? "APPROVED EXPENSES")</span>
                    <span class="stat-card-value stat-card-value-sm">@_approvedExpensesAmount.ToString("C2")</span>
                    <span class="stat-card-sub">@(Lang?.T("Dash_TotalApproved") ?? "total approved")</span>
                </div>
            </div>
        </MudItem>

        <!-- Quick Actions -->
        <MudItem xs="12">
            <MudPaper Elevation="0" Class="data-card pa-4 quick-actions-card">
                <MudText Typo="Typo.subtitle2" Color="Color.Secondary" Style="font-weight:600; text-transform:uppercase; letter-spacing:1px; margin-bottom:12px;">@(Lang?.T("Dash_QuickActions") ?? "Quick Actions")</MudText>
                <MudStack Row="true" Spacing="2" Wrap="Wrap.Wrap">
                    <MudButton Variant="Variant.Filled" Color="Color.Success" Size="Size.Small"
                               StartIcon="@Icons.Material.Filled.AttachMoney" Class="quick-action-btn"
                               OnClick="@(() => Navigation.NavigateTo("/cashier/deposits"))">@(Lang?.T("Dash_NewCashDeposit") ?? "New Cash Deposit")</MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Warning" Size="Size.Small"
                               StartIcon="@Icons.Material.Filled.Receipt" Class="quick-action-btn"
                               OnClick="@(() => Navigation.NavigateTo("/cashier/expenses"))">@(Lang?.T("Dash_NewExpense") ?? "New Expense")</MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Info" Size="Size.Small"
                               StartIcon="@Icons.Material.Filled.AccountBalance" Class="quick-action-btn"
                               OnClick="@(() => Navigation.NavigateTo("/cashier/balances"))">@(Lang?.T("Dash_DealerBalances") ?? "Dealer Balances")</MudButton>
                </MudStack>
            </MudPaper>
        </MudItem>

        <!-- Pending Expense Alert -->
        @if (_pendingExpensesCount > 0)
        {
            <MudItem xs="12">
                <MudAlert Severity="Severity.Warning" Variant="Variant.Filled" Dense="true"
                          Class="cursor-pointer" OnClick="@(() => Navigation.NavigateTo("/cashier/expenses"))">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudText>@(Lang?.T("Dash_PendingExpensesAlert", _pendingExpensesCount) ?? $"{_pendingExpensesCount} expense(s) are pending approval.")</MudText>
                        <MudButton Variant="Variant.Text" Color="Color.Inherit" Size="Size.Small"
                                   EndIcon="@Icons.Material.Filled.ArrowForward">@(Lang?.T("View") ?? "View")</MudButton>
                    </MudStack>
                </MudAlert>
            </MudItem>
        }

        <!-- Expense Status Chart -->
        <MudItem xs="12" md="5">
            <MudPaper Elevation="0" Class="data-card pa-4">
                <MudText Typo="Typo.h6" Class="mb-3">@(Lang?.T("Dash_ExpenseStatus") ?? "Expense Status")</MudText>
                @if (_pendingExpensesCount + _approvedExpensesCount + _rejectedExpensesCount > 0)
                {
                    <div style="height:260px; display:flex; justify-content:center;">
                        <canvas id="cashierExpenseStatusChart"></canvas>
                    </div>
                }
                else
                {
                    <div style="text-align:center; padding:40px 0;">
                        <MudIcon Icon="@Icons.Material.Outlined.PieChart" Size="Size.Large" Color="Color.Secondary" />
                        <MudText Color="Color.Secondary" Class="mt-2">@(Lang?.T("Dash_NoExpenseDataYet") ?? "No expense data yet")</MudText>
                    </div>
                }
            </MudPaper>
        </MudItem>

        <!-- Recent Cash Deposits -->
        <MudItem xs="12" md="7">
            <MudPaper Elevation="0" Class="data-card pa-4">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
                    <MudText Typo="Typo.h6">@(Lang?.T("Dash_RecentCashDeposits") ?? "Recent Cash Deposits")</MudText>
                    <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small"
                               EndIcon="@Icons.Material.Filled.ArrowForward"
                               OnClick="@(() => Navigation.NavigateTo("/cashier/deposits"))">@(Lang?.T("ViewAll") ?? "View All")</MudButton>
                </MudStack>
                @if (_recentCashDeposits.Any())
                {
                    <MudSimpleTable Hover="true" Dense="true" Striped="true">
                        <thead>
                            <tr>
                                <th>@(Lang?.T("Dealer") ?? "Dealer")</th>
                                <th>@(Lang?.T("Branch") ?? "Branch")</th>
                                <th>@(Lang?.T("Date") ?? "Date")</th>
                                <th style="text-align:right;">@(Lang?.T("Amount") ?? "Amount")</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var d in _recentCashDeposits)
                            {
                                <tr>
                                    <td>@d.DealerName</td>
                                    <td>@d.BranchName</td>
                                    <td>@d.DepositDate.ToString("dd MMM HH:mm")</td>
                                    <td style="text-align:right; font-weight:600;">@d.Amount.ToString("C2")</td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                }
                else
                {
                    <div style="text-align:center; padding:40px 0;">
                        <MudIcon Icon="@Icons.Material.Outlined.Paid" Size="Size.Large" Color="Color.Secondary" />
                        <MudText Color="Color.Secondary" Class="mt-2">@(Lang?.T("Dash_NoCashDepositsYet") ?? "No cash deposits yet")</MudText>
                    </div>
                }
            </MudPaper>
        </MudItem>

        <!-- Deposits by Category breakdown -->
        <MudItem xs="12">
            <MudPaper Elevation="0" Class="data-card pa-4">
                <MudText Typo="Typo.h6" Class="mb-3">@(Lang?.T("Dash_ExpensesByCategory") ?? "Expenses by Category")</MudText>
                @if (_expensesByCategory.Any())
                {
                    <MudSimpleTable Hover="true" Dense="true" Striped="true">
                        <thead>
                            <tr>
                                <th>@(Lang?.T("Category") ?? "Category")</th>
                                <th style="text-align:right;">@(Lang?.T("Dash_Count") ?? "Count")</th>
                                <th style="text-align:right;">@(Lang?.T("Dash_TotalAmount") ?? "Total Amount")</th>
                                <th style="text-align:right;">@(Lang?.T("Approved") ?? "Approved")</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var row in _expensesByCategory)
                            {
                                <tr>
                                    <td>@row.Category</td>
                                    <td style="text-align:right;">@row.Count</td>
                                    <td style="text-align:right; font-weight:600;">@row.Total.ToString("C2")</td>
                                    <td style="text-align:right; color:#16A34A; font-weight:600;">@row.Approved.ToString("C2")</td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                }
                else
                {
                    <div style="text-align:center; padding:30px 0;">
                        <MudText Color="Color.Secondary">@(Lang?.T("Dash_NoExpenseRecords") ?? "No expense records yet")</MudText>
                    </div>
                }
            </MudPaper>
        </MudItem>

    </MudGrid>
}
else
{
    <!-- ─── ADMIN / SUPERADMIN DASHBOARD ─── -->
    <MudGrid Spacing="4">

        <!-- Summary Cards -->
        <MudItem xs="12" sm="6" md="3">
            <div class="stat-card-v2 stat-card-amber" @onclick="@(() => Navigation.NavigateTo("/dealer/registration"))">
                <div class="stat-card-icon-bg">
                    <MudIcon Icon="@Icons.Material.Filled.People" />
                </div>
                <div class="stat-card-body">
                    <span class="stat-card-label">@(Lang?.T("Dash_Dealers") ?? "DEALERS")</span>
                    <span class="stat-card-value">@_dealerCount</span>
                    <span class="stat-card-sub">@(Lang?.T("Dash_Registered") ?? "registered")</span>
                </div>
            </div>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <div class="stat-card-v2 stat-card-blue" @onclick="@(() => Navigation.NavigateTo("/dealer/transfers"))">
                <div class="stat-card-icon-bg">
                    <MudIcon Icon="@Icons.Material.Filled.SwapHoriz" />
                </div>
                <div class="stat-card-body">
                    <span class="stat-card-label">@(Lang?.T("Dash_Transfers") ?? "TRANSFERS")</span>
                    <span class="stat-card-value">@_transferCount</span>
                    <span class="stat-card-sub">@_totalTransferAmount.ToString("C2")</span>
                </div>
            </div>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <div class="stat-card-v2 stat-card-green" @onclick="@(() => Navigation.NavigateTo("/cashier/deposits"))">
                <div class="stat-card-icon-bg">
                    <MudIcon Icon="@Icons.Material.Filled.AttachMoney" />
                </div>
                <div class="stat-card-body">
                    <span class="stat-card-label">@(Lang?.T("Dash_CashDeposits") ?? "CASH DEPOSITS")</span>
                    <span class="stat-card-value">@_cashDepositCount</span>
                    <span class="stat-card-sub">@_totalCashDeposits.ToString("C2")</span>
                </div>
            </div>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <div class="stat-card-v2 stat-card-indigo" @onclick="@(() => Navigation.NavigateTo("/cashier/balances"))">
                <div class="stat-card-icon-bg">
                    <MudIcon Icon="@Icons.Material.Filled.AccountBalance" />
                </div>
                <div class="stat-card-body">
                    <span class="stat-card-label">@(Lang?.T("Dash_TotalBalance") ?? "TOTAL BALANCE")</span>
                    <span class="stat-card-value @(_totalBalance < 0 ? "stat-card-negative" : "")">
                        @(_totalBalance < 0 ? $"-{Math.Abs(_totalBalance).ToString("C2")}" : _totalBalance.ToString("C2"))
                    </span>
                    <span class="stat-card-sub">@(Lang?.T("Dash_DepositsMinusTransfers") ?? "Deposits − Transfers")</span>
                </div>
            </div>
        </MudItem>

        <!-- Analytics Quick-Glance Cards -->
        <MudItem xs="12" sm="6" md="3">
            <div class="stat-card-v2 stat-card-teal" @onclick="@(() => Navigation.NavigateTo("/admin/analytics"))">
                <div class="stat-card-icon-bg">
                    <MudIcon Icon="@Icons.Material.Filled.Inventory2" />
                </div>
                <div class="stat-card-body">
                    <span class="stat-card-label">@(Lang?.T("Dash_StockValue") ?? "STOCK VALUE")</span>
                    <span class="stat-card-value stat-card-value-sm">@_currentStockValue.ToString("C2")</span>
                    <span class="stat-card-sub">@_stockUtilization.ToString("N1")% @(Lang?.T("Dash_Utilized") ?? "utilized")</span>
                </div>
            </div>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <div class="stat-card-v2 stat-card-violet" @onclick="@(() => Navigation.NavigateTo("/admin/analytics"))">
                <div class="stat-card-icon-bg">
                    <MudIcon Icon="@Icons.Material.Filled.TrendingUp" />
                </div>
                <div class="stat-card-body">
                    <span class="stat-card-label">@(Lang?.T("Dash_NetCapital") ?? "NET CAPITAL")</span>
                    <span class="stat-card-value stat-card-value-sm @(_netCapital < 0 ? "stat-card-negative" : "")">
                        @(_netCapital < 0 ? $"-{Math.Abs(_netCapital).ToString("C2")}" : _netCapital.ToString("C2"))
                    </span>
                    <span class="stat-card-sub" style="@(_grossProfit >= 0 ? "color:#16A34A;" : "color:#EF4444;")">
                        @(Lang?.T("Dash_Profit") ?? "Profit:") @_grossProfit.ToString("C2")
                    </span>
                </div>
            </div>
        </MudItem>

        <!-- Quick Actions -->
        <MudItem xs="12" sm="6">
            <MudPaper Elevation="0" Class="data-card pa-4 quick-actions-card">
                <MudText Typo="Typo.subtitle2" Color="Color.Secondary" Style="font-weight:600; text-transform:uppercase; letter-spacing:1px; margin-bottom:12px;">@(Lang?.T("Dash_QuickActions") ?? "Quick Actions")</MudText>
                <MudStack Row="true" Spacing="2" Wrap="Wrap.Wrap">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small"
                               StartIcon="@Icons.Material.Filled.SwapHoriz" Class="quick-action-btn"
                               OnClick="@(() => Navigation.NavigateTo("/dealer/transfers"))">@(Lang?.T("Dash_NewTransfer") ?? "New Transfer")</MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Success" Size="Size.Small"
                               StartIcon="@Icons.Material.Filled.AttachMoney" Class="quick-action-btn"
                               OnClick="@(() => Navigation.NavigateTo("/cashier/deposits"))">@(Lang?.T("Dash_CashDeposit") ?? "Cash Deposit")</MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Warning" Size="Size.Small"
                               StartIcon="@Icons.Material.Filled.AccountBalanceWallet" Class="quick-action-btn"
                               OnClick="@(() => Navigation.NavigateTo("/admin/deposits"))">@(Lang?.T("Dash_AirtimeDeposit") ?? "Airtime Deposit")</MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Info" Size="Size.Small"
                               StartIcon="@Icons.Material.Filled.PersonAdd" Class="quick-action-btn"
                               OnClick="@(() => Navigation.NavigateTo("/dealer/registration"))">@(Lang?.T("Dash_RegisterDealer") ?? "Register Dealer")</MudButton>
                </MudStack>
            </MudPaper>
        </MudItem>

        <!-- Pending Approvals Alerts -->
        @if (_pendingDepositsCount > 0)
        {
            <MudItem xs="12" md="6">
                <MudAlert Severity="Severity.Warning" Variant="Variant.Filled" Dense="true"
                          Class="cursor-pointer" OnClick="@(() => Navigation.NavigateTo("/admin/approvals"))">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudText>@(Lang?.T("Dash_PendingDepositsAlert", _pendingDepositsCount) ?? $"You have {_pendingDepositsCount} airtime deposit(s) pending approval.")</MudText>
                        <MudButton Variant="Variant.Text" Color="Color.Inherit" Size="Size.Small"
                                   EndIcon="@Icons.Material.Filled.ArrowForward">@(Lang?.T("Review") ?? "Review")</MudButton>
                    </MudStack>
                </MudAlert>
            </MudItem>
        }

        @if (_pendingTransfersCount > 0)
        {
            <MudItem xs="12" md="6">
                <MudAlert Severity="Severity.Info" Variant="Variant.Filled" Dense="true"
                          Class="cursor-pointer" OnClick="@(() => Navigation.NavigateTo("/admin/transfer-approvals"))">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudText>@(Lang?.T("Dash_PendingTransfersAdminAlert", _pendingTransfersCount) ?? $"You have {_pendingTransfersCount} airtime transfer(s) pending approval.")</MudText>
                        <MudButton Variant="Variant.Text" Color="Color.Inherit" Size="Size.Small"
                                   EndIcon="@Icons.Material.Filled.ArrowForward">@(Lang?.T("Review") ?? "Review")</MudButton>
                    </MudStack>
                </MudAlert>
            </MudItem>
        }

        <!-- Product Balances -->
        <MudItem xs="12" md="6">
            <MudPaper Elevation="0" Class="data-card pa-4">
                <MudText Typo="Typo.h6" Class="mb-3">@(Lang?.T("Dash_ProductBalances") ?? "Product Balances")</MudText>
                @if (_products.Any())
                {
                    <MudSimpleTable Hover="true" Dense="true" Striped="true">
                        <thead>
                            <tr>
                                <th>@(Lang?.T("Product") ?? "Product")</th>
                                <th>@(Lang?.T("Dash_BonusPercent") ?? "Bonus %")</th>
                                <th style="text-align:right;">@(Lang?.T("Balance") ?? "Balance")</th>
                                <th>@(Lang?.T("Status") ?? "Status")</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var product in _products)
                            {
                                <tr>
                                    <td>@product.Name</td>
                                    <td>@product.BonusPercentage.ToString("N6")%</td>
                                    <td style="text-align:right; font-weight:600;">@product.AirtimeAccountBalance.ToString("C6")</td>
                                    <td>
                                        <MudChip T="string" Size="Size.Small"
                                                 Color="@(product.IsActive ? Color.Success : Color.Error)">
                                            @(product.IsActive ? (Lang?.T("Active") ?? "Active") : (Lang?.T("Inactive") ?? "Inactive"))
                                        </MudChip>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                }
                else
                {
                    <div style="text-align:center; padding:40px 0;">
                        <MudIcon Icon="@Icons.Material.Outlined.Inventory2" Size="Size.Large" Color="Color.Secondary" />
                        <MudText Color="Color.Secondary" Class="mt-2">@(Lang?.T("Dash_NoProductsYet") ?? "No products configured yet")</MudText>
                        <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small" Class="mt-1"
                                   OnClick="@(() => Navigation.NavigateTo("/admin/products"))">@(Lang?.T("Dash_AddProduct") ?? "Add Product")</MudButton>
                    </div>
                }
            </MudPaper>
        </MudItem>

        <!-- Deposit Status Chart -->
        <MudItem xs="12" md="6">
            <MudPaper Elevation="0" Class="data-card pa-4">
                <MudText Typo="Typo.h6" Class="mb-3">@(Lang?.T("Dash_DepositStatus") ?? "Deposit Status Distribution")</MudText>
                @if (_pendingDepositsCount + _approvedDepositsCount + _rejectedDepositsCount + _cancelledDepositsCount > 0)
                {
                    <div style="height:260px; display:flex; justify-content:center;">
                        <canvas id="adminDepositStatusChart"></canvas>
                    </div>
                    <MudDivider Class="my-3" />
                    <MudStack Row="true" Justify="Justify.SpaceBetween">
                        <MudText Typo="Typo.subtitle1"><strong>@(Lang?.T("Dash_TotalApprovedValue") ?? "Total Approved Value")</strong></MudText>
                        <MudText Typo="Typo.subtitle1" Color="Color.Success"><strong>@_totalApprovedValue.ToString("C6")</strong></MudText>
                    </MudStack>
                }
                else
                {
                    <div style="text-align:center; padding:40px 0;">
                        <MudIcon Icon="@Icons.Material.Outlined.PieChart" Size="Size.Large" Color="Color.Secondary" />
                        <MudText Color="Color.Secondary" Class="mt-2">@(Lang?.T("Dash_NoDepositDataYet") ?? "No deposit data yet")</MudText>
                    </div>
                }
            </MudPaper>
        </MudItem>

        <!-- Recent Transfers -->
        <MudItem xs="12" md="6">
            <MudPaper Elevation="0" Class="data-card pa-4">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
                    <MudText Typo="Typo.h6">@(Lang?.T("Dash_RecentTransfers") ?? "Recent Transfers")</MudText>
                    <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small"
                               EndIcon="@Icons.Material.Filled.ArrowForward"
                               OnClick="@(() => Navigation.NavigateTo("/dealer/transfers"))">@(Lang?.T("ViewAll") ?? "View All")</MudButton>
                </MudStack>
                @if (_recentTransfers.Any())
                {
                    <MudSimpleTable Hover="true" Dense="true" Striped="true">
                        <thead>
                            <tr>
                                <th>@(Lang?.T("Dealer") ?? "Dealer")</th>
                                <th>@(Lang?.T("Product") ?? "Product")</th>
                                <th>@(Lang?.T("Status") ?? "Status")</th>
                                <th style="text-align:right;">@(Lang?.T("Amount") ?? "Amount")</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var t in _recentTransfers)
                            {
                                <tr>
                                    <td>@t.DealerName</td>
                                    <td>@t.ProductName</td>
                                    <td>
                                        @{
                                            var tColor = t.Status switch
                                            {
                                                DepositStatus.Pending => Color.Warning,
                                                DepositStatus.Approved => Color.Success,
                                                DepositStatus.Rejected => Color.Error,
                                                DepositStatus.Cancelled => Color.Dark,
                                                _ => Color.Default
                                            };
                                        }
                                        <MudChip T="string" Size="Size.Small" Color="@tColor">@t.Status</MudChip>
                                    </td>
                                    <td style="text-align:right;">@t.Amount.ToString("C6")</td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                }
                else
                {
                    <div style="text-align:center; padding:40px 0;">
                        <MudIcon Icon="@Icons.Material.Outlined.SwapHoriz" Size="Size.Large" Color="Color.Secondary" />
                        <MudText Color="Color.Secondary" Class="mt-2">@(Lang?.T("Dash_NoTransfersYetAdmin") ?? "No transfers yet")</MudText>
                    </div>
                }
            </MudPaper>
        </MudItem>

        <!-- Branches -->
        <MudItem xs="12" md="6">
            <MudPaper Elevation="0" Class="data-card pa-4">
                <MudText Typo="Typo.h6" Class="mb-3">@(Lang?.T("Dash_Branches") ?? "Branches")</MudText>
                @if (_branches.Any())
                {
                    <MudSimpleTable Hover="true" Dense="true" Striped="true">
                        <thead>
                            <tr>
                                <th>@(Lang?.T("Name") ?? "Name")</th>
                                <th>@(Lang?.T("Location") ?? "Location")</th>
                                <th>@(Lang?.T("Status") ?? "Status")</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var b in _branches)
                            {
                                <tr>
                                    <td>@b.Name</td>
                                    <td>@b.Location</td>
                                    <td>
                                        <MudChip T="string" Size="Size.Small"
                                                 Color="@(b.IsActive ? Color.Success : Color.Error)">
                                            @(b.IsActive ? (Lang?.T("Active") ?? "Active") : (Lang?.T("Inactive") ?? "Inactive"))
                                        </MudChip>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                }
                else
                {
                    <div style="text-align:center; padding:40px 0;">
                        <MudIcon Icon="@Icons.Material.Outlined.Store" Size="Size.Large" Color="Color.Secondary" />
                        <MudText Color="Color.Secondary" Class="mt-2">@(Lang?.T("Dash_NoBranchesYet") ?? "No branches configured yet")</MudText>
                        <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small" Class="mt-1"
                                   OnClick="@(() => Navigation.NavigateTo("/admin/branches"))">@(Lang?.T("Dash_AddBranch") ?? "Add Branch")</MudButton>
                    </div>
                }
            </MudPaper>
        </MudItem>

        <!-- Top 5 Lists -->
        <MudItem xs="12" sm="6">
            <MudPaper Elevation="0" Class="data-card pa-4" Style="height:100%;">
                <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-3" Spacing="1">
                    <MudIcon Icon="@Icons.Material.Filled.EmojiEvents" Color="Color.Warning" Size="Size.Small" />
                    <MudText Typo="Typo.h6">Top 5 Products by Profit</MudText>
                </MudStack>
                @if (_top5Products.Count > 0)
                {
                    <div style="display:flex;flex-direction:column;gap:6px;">
                        @for (int i = 0; i < _top5Products.Count; i++)
                        {
                            var rank = i + 1;
                            var item = _top5Products[i];
                            var maxCommission = _top5Products[0].Commission;
                            var barPct = maxCommission > 0 ? (double)(item.Commission / maxCommission * 100) : 0;
                            <div style="display:flex;align-items:center;gap:8px;padding:4px 0;">
                                <MudText Typo="Typo.body2" Style="width:20px;text-align:right;font-weight:600;color:var(--mud-palette-text-secondary);">@rank</MudText>
                                <div style="flex:1;min-width:0;">
                                    <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:2px;">
                                        <MudText Typo="Typo.body2" Style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-weight:500;">@item.Name</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Success" Style="margin-left:8px;white-space:nowrap;font-weight:600;">@item.Commission.ToString("C0")</MudText>
                                    </div>
                                    <div style="height:4px;border-radius:2px;background:var(--mud-palette-action-disabled-background);overflow:hidden;">
                                        <div style="height:100%;width:@(barPct.ToString("F0"))%;background:linear-gradient(90deg,#16A34A,#4ADE80);border-radius:2px;transition:width 0.6s ease;"></div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div style="text-align:center;padding:32px 0;">
                        <MudIcon Icon="@Icons.Material.Outlined.BarChart" Size="Size.Large" Color="Color.Secondary" />
                        <MudText Color="Color.Secondary" Class="mt-2" Typo="Typo.body2">No approved transfers yet</MudText>
                    </div>
                }
            </MudPaper>
        </MudItem>

        <MudItem xs="12" sm="6">
            <MudPaper Elevation="0" Class="data-card pa-4" Style="height:100%;">
                <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-3" Spacing="1">
                    <MudIcon Icon="@Icons.Material.Filled.Star" Color="Color.Warning" Size="Size.Small" />
                    <MudText Typo="Typo.h6">Top 5 Dealers by Profit</MudText>
                </MudStack>
                @if (_top5Dealers.Count > 0)
                {
                    <div style="display:flex;flex-direction:column;gap:6px;">
                        @for (int i = 0; i < _top5Dealers.Count; i++)
                        {
                            var rank = i + 1;
                            var item = _top5Dealers[i];
                            var maxCommission = _top5Dealers[0].Commission;
                            var barPct = maxCommission > 0 ? (double)(item.Commission / maxCommission * 100) : 0;
                            <div style="display:flex;align-items:center;gap:8px;padding:4px 0;">
                                <MudText Typo="Typo.body2" Style="width:20px;text-align:right;font-weight:600;color:var(--mud-palette-text-secondary);">@rank</MudText>
                                <div style="flex:1;min-width:0;">
                                    <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:2px;">
                                        <MudText Typo="Typo.body2" Style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-weight:500;">@item.Name</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Primary" Style="margin-left:8px;white-space:nowrap;font-weight:600;">@item.Commission.ToString("C0")</MudText>
                                    </div>
                                    <div style="height:4px;border-radius:2px;background:var(--mud-palette-action-disabled-background);overflow:hidden;">
                                        <div style="height:100%;width:@(barPct.ToString("F0"))%;background:linear-gradient(90deg,#2563EB,#60A5FA);border-radius:2px;transition:width 0.6s ease;"></div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div style="text-align:center;padding:32px 0;">
                        <MudIcon Icon="@Icons.Material.Outlined.People" Size="Size.Large" Color="Color.Secondary" />
                        <MudText Color="Color.Secondary" Class="mt-2" Typo="Typo.body2">No approved transfers yet</MudText>
                    </div>
                }
            </MudPaper>
        </MudItem>

        <!-- Monthly Transfers Chart -->
        <MudItem xs="12">
            <MudPaper Elevation="0" Class="data-card pa-4">
                <MudText Typo="Typo.h6" Class="mb-3">@(Lang?.T("Dash_MonthlyActivity") ?? "Monthly Activity (Last 6 Months)")</MudText>
                @if (_monthlyLabels.Length > 0)
                {
                    <div style="height:280px;">
                        <canvas id="adminMonthlyChart"></canvas>
                    </div>
                }
                else
                {
                    <div style="text-align:center; padding:40px 0;">
                        <MudIcon Icon="@Icons.Material.Outlined.BarChart" Size="Size.Large" Color="Color.Secondary" />
                        <MudText Color="Color.Secondary" Class="mt-2">@(Lang?.T("Dash_NoMonthlyData") ?? "No monthly data yet")</MudText>
                    </div>
                }
            </MudPaper>
        </MudItem>

        <!-- Recent Activity -->
        <MudItem xs="12">
            <MudPaper Elevation="0" Class="data-card pa-4">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
                    <MudText Typo="Typo.h6">@(Lang?.T("Dash_RecentActivity") ?? "Recent Activity")</MudText>
                    <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small"
                               EndIcon="@Icons.Material.Filled.ArrowForward"
                               OnClick="@(() => Navigation.NavigateTo("/superadmin/audit"))">@(Lang?.T("ViewAll") ?? "View All")</MudButton>
                </MudStack>
                @if (_recentAuditLogs.Any())
                {
                    <MudTimeline TimelineOrientation="TimelineOrientation.Vertical" TimelinePosition="TimelinePosition.Start">
                        @foreach (var log in _recentAuditLogs)
                        {
                            <MudTimelineItem Color="@GetAuditColor(log.Action)" Size="Size.Small">
                                <MudStack Spacing="0">
                                    <MudText Typo="Typo.body2"><strong>@log.Action</strong> @log.EntityName #@log.EntityId</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        @(log.UserName ?? "System") &mdash; @log.Timestamp.ToString("dd MMM yyyy HH:mm")
                                    </MudText>
                                </MudStack>
                            </MudTimelineItem>
                        }
                    </MudTimeline>
                }
                else
                {
                    <div style="text-align:center; padding:40px 0;">
                        <MudIcon Icon="@Icons.Material.Outlined.Timeline" Size="Size.Large" Color="Color.Secondary" />
                        <MudText Color="Color.Secondary" Class="mt-2">@(Lang?.T("Dash_NoActivityYet") ?? "No activity recorded yet")</MudText>
                    </div>
                }
            </MudPaper>
        </MudItem>

    </MudGrid>
}

@code {
    [CascadingParameter] public AirtimeDistributionCloud.Application.Services.ILanguageService? Lang { get; set; }

    // ── Role flags ──
    private bool _loading = true;
    private string? _loadError;
    private bool _isDealer;
    private bool _isCashier;
    private string _userName = "User";

    private string _roleSubtitle => _isDealer
        ? (Lang?.T("Dash_DealerSubtitle") ?? "Here's an overview of your airtime transfers and commissions")
        : _isCashier
            ? (Lang?.T("Dash_CashierSubtitle") ?? "Here's your cashier activity overview")
            : (Lang?.T("Dash_AdminSubtitle") ?? "Here's what's happening in your airtime distribution system");

    // ── Admin / shared ──
    private List<ProductDto> _products = new();
    private List<BranchDto> _branches = new();
    private List<AirtimeTransferDto> _recentTransfers = new();
    private List<AuditLogDto> _recentAuditLogs = new();
    private int _dealerCount, _transferCount, _cashDepositCount;
    private int _pendingDepositsCount, _approvedDepositsCount, _rejectedDepositsCount, _cancelledDepositsCount;
    private int _pendingTransfersCount;
    private decimal _totalTransferAmount, _totalCashDeposits, _totalApprovedValue, _totalBalance;
    private decimal _currentStockValue, _stockUtilization, _netCapital, _grossProfit;
    private string[] _monthlyLabels = [];
    private double[] _monthlyTransferAmounts = [];
    private double[] _monthlyCashDepositAmounts = [];

    // ── Dealer ──
    private List<DealerProductRateDto> _dealerProductRates = new();
    private int _myTransferCount, _myPendingCount, _myApprovedCount, _myRejectedCount, _myCancelledCount;
    private decimal _myApprovedAmount, _myTotalCommission;
    private List<CommissionRow> _commissionRows = new();
    private record CommissionRow(string ProductName, decimal Rate, int TransferCount, decimal CommissionEarned);

    // ── Top 5 Lists ──
    private List<(string Name, decimal Commission)> _top5Products = new();
    private List<(string Name, decimal Commission)> _top5Dealers = new();

    // ── Cashier ──
    private List<CashDepositDto> _recentCashDeposits = new();
    private int _todayDepositCount, _pendingExpensesCount, _approvedExpensesCount, _rejectedExpensesCount;
    private decimal _todayDepositAmount, _approvedExpensesAmount;
    private List<ExpenseCategoryRow> _expensesByCategory = new();
    private record ExpenseCategoryRow(string Category, int Count, decimal Total, decimal Approved);

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var principal = authState.User;
        _isDealer = principal.IsInRole("Dealer") && !principal.IsInRole("SystemAdmin") && !principal.IsInRole("SuperAdministrator");
        _isCashier = principal.IsInRole("Cashier") && !principal.IsInRole("SystemAdmin") && !principal.IsInRole("SuperAdministrator") && !_isDealer;

        // Don't set subtitles here, they'll be computed based on Lang
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        try
        {
            // Get auth state first (no DB hit — reads from the SignalR/cookie context)
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var principal = authState.User;
            var userId = principal.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

            // Create a single isolated scope for ALL DB operations so we never touch
            // the circuit-scoped DbContext, which may be in use by NavMenu concurrently.
            using var scope = ScopeFactory.CreateScope();
            var sp = scope.ServiceProvider;

            if (!string.IsNullOrEmpty(userId))
            {
                var userMgr = sp.GetRequiredService<UserManager<ApplicationUser>>();
                var user = await userMgr.FindByIdAsync(userId);
                _userName = user?.FullName ?? principal.Identity?.Name ?? "User";
            }
            else
            {
                _userName = principal.Identity?.Name ?? "User";
            }

            if (_isDealer)
                await LoadDealerData(sp);
            else if (_isCashier)
                await LoadCashierData(sp);
            else
                await LoadAdminData(sp);
        }
        catch (Exception ex)
        {
            _loadError = ex.Message;
        }
        finally
        {
            _loading = false;
            StateHasChanged();
            await Task.Yield(); // let Blazor render the canvases
            await RenderChartsAsync();
        }
    }

    private async Task RenderChartsAsync()
    {
        try
        {
            if (_isDealer && _myTransferCount > 0)
            {
                await JS.InvokeVoidAsync("chartInterop.createDoughnut", "dealerTransferStatusChart",
                    new[] { $"{Lang?.T("Pending") ?? "Pending"} ({_myPendingCount})", $"{Lang?.T("Approved") ?? "Approved"} ({_myApprovedCount})", $"{Lang?.T("Rejected") ?? "Rejected"} ({_myRejectedCount})", $"{Lang?.T("Cancelled") ?? "Cancelled"} ({_myCancelledCount})" },
                    new double[] { _myPendingCount, _myApprovedCount, _myRejectedCount, _myCancelledCount },
                    new[] { "#D97706", "#16A34A", "#DC2626", "#6B7280" });
            }
            else if (_isCashier && (_pendingExpensesCount + _approvedExpensesCount + _rejectedExpensesCount > 0))
            {
                await JS.InvokeVoidAsync("chartInterop.createDoughnut", "cashierExpenseStatusChart",
                    new[] { $"{Lang?.T("Pending") ?? "Pending"} ({_pendingExpensesCount})", $"{Lang?.T("Approved") ?? "Approved"} ({_approvedExpensesCount})", $"{Lang?.T("Rejected") ?? "Rejected"} ({_rejectedExpensesCount})" },
                    new double[] { _pendingExpensesCount, _approvedExpensesCount, _rejectedExpensesCount },
                    new[] { "#D97706", "#16A34A", "#DC2626" });
            }
            else if (!_isDealer && !_isCashier)
            {
                // Admin charts
                if (_pendingDepositsCount + _approvedDepositsCount + _rejectedDepositsCount + _cancelledDepositsCount > 0)
                {
                    await JS.InvokeVoidAsync("chartInterop.createDoughnut", "adminDepositStatusChart",
                        new[] { $"{Lang?.T("Pending") ?? "Pending"} ({_pendingDepositsCount})", $"{Lang?.T("Approved") ?? "Approved"} ({_approvedDepositsCount})", $"{Lang?.T("Rejected") ?? "Rejected"} ({_rejectedDepositsCount})", $"{Lang?.T("Cancelled") ?? "Cancelled"} ({_cancelledDepositsCount})" },
                        new double[] { _pendingDepositsCount, _approvedDepositsCount, _rejectedDepositsCount, _cancelledDepositsCount },
                        new[] { "#D97706", "#16A34A", "#DC2626", "#6B7280" });
                }

                if (_monthlyLabels.Length > 0)
                {
                    await JS.InvokeVoidAsync("chartInterop.createBar", "adminMonthlyChart",
                        _monthlyLabels,
                        new object[]
                        {
                            new { label = Lang?.T("Chart_Transfers") ?? "Transfers", data = _monthlyTransferAmounts, color = "#0284C7" },
                            new { label = Lang?.T("Chart_CashDeposits") ?? "Cash Deposits", data = _monthlyCashDepositAmounts, color = "#16A34A" }
                        },
                        false);
                }
            }
        }
        catch
        {
            // Chart rendering should not crash the dashboard
        }
    }

    private async Task LoadAdminData(IServiceProvider sp)
    {
        _products = (await sp.GetRequiredService<IProductService>().GetAllProductsAsync()).ToList();
        var dealers = await sp.GetRequiredService<IDealerService>().GetAllDealersAsync();
        _dealerCount = dealers.Count;

        var transfers = await sp.GetRequiredService<IAirtimeTransferService>().GetAllTransfersAsync();
        _transferCount = transfers.Count;
        _totalTransferAmount = transfers.Where(t => t.Status == DepositStatus.Approved).Sum(t => t.LoanAmount);
        _recentTransfers = transfers.OrderByDescending(t => t.CreatedDate).Take(5).ToList();
        _pendingTransfersCount = transfers.Count(t => t.Status == DepositStatus.Pending);

        var cashDeposits = await sp.GetRequiredService<ICashDepositService>().GetAllDepositsAsync();
        _cashDepositCount = cashDeposits.Count;
        _totalCashDeposits = cashDeposits.Sum(d => d.Amount);
        _totalBalance = _totalCashDeposits - _totalTransferAmount;

        var airtimeDeposits = await sp.GetRequiredService<IAirtimeDepositService>().GetAllDepositsAsync();
        _pendingDepositsCount = airtimeDeposits.Count(d => d.Status == DepositStatus.Pending);
        _approvedDepositsCount = airtimeDeposits.Count(d => d.Status == DepositStatus.Approved);
        _rejectedDepositsCount = airtimeDeposits.Count(d => d.Status == DepositStatus.Rejected);
        _cancelledDepositsCount = airtimeDeposits.Count(d => d.Status == DepositStatus.Cancelled);
        _totalApprovedValue = airtimeDeposits.Where(d => d.Status == DepositStatus.Approved).Sum(d => d.TotalAmount);

        _branches = (await sp.GetRequiredService<IBranchService>().GetAllBranchesAsync()).ToList();
        _recentAuditLogs = (await sp.GetRequiredService<IAuditLogService>().GetRecentLogsAsync(8)).ToList();

        var expenses = await sp.GetRequiredService<IExpenseService>().GetAllExpensesAsync();

        // Monthly chart data (last 6 months)
        var now = DateTime.UtcNow;
        var months = Enumerable.Range(0, 6).Select(i => now.AddMonths(-5 + i)).ToArray();
        _monthlyLabels = months.Select(m => m.ToString("MMM yyyy")).ToArray();
        _monthlyTransferAmounts = months.Select(m =>
            (double)transfers.Where(t => t.CreatedDate.Year == m.Year && t.CreatedDate.Month == m.Month)
                .Sum(t => t.Amount)).ToArray();
        _monthlyCashDepositAmounts = months.Select(m =>
            (double)cashDeposits.Where(d => d.DepositDate.Year == m.Year && d.DepositDate.Month == m.Month)
                .Sum(d => d.Amount)).ToArray();

        // Analytics quick-glance
        _currentStockValue = _products.Sum(p => p.AirtimeAccountBalance);
        var totalPurchased = airtimeDeposits.Where(d => d.Status == DepositStatus.Approved).Sum(d => d.TotalAmount);
        var totalDistributed = transfers.Where(t => t.Status == DepositStatus.Approved).Sum(t => t.LoanAmount);
        _stockUtilization = totalPurchased > 0 ? totalDistributed / totalPurchased * 100 : 0;
        var totalInvestment = airtimeDeposits.Where(d => d.Status == DepositStatus.Approved).Sum(d => d.Amount);
        var totalExpenses = expenses.Where(e => e.Status == DepositStatus.Approved).Sum(e => e.Amount);
        _netCapital = _totalCashDeposits + _currentStockValue - totalExpenses;
        _grossProfit = _totalCashDeposits - totalInvestment - totalExpenses;

        var approvedTransfers = transfers.Where(t => t.Status == DepositStatus.Approved).ToList();
        _top5Products = approvedTransfers
            .GroupBy(t => t.ProductName)
            .Select(g => (Name: g.Key, Commission: g.Sum(t => t.CommissionAmount)))
            .OrderByDescending(x => x.Commission).Take(5).ToList();
        _top5Dealers = approvedTransfers
            .GroupBy(t => t.DealerName)
            .Select(g => (Name: g.Key, Commission: g.Sum(t => t.CommissionAmount)))
            .OrderByDescending(x => x.Commission).Take(5).ToList();
    }

    private async Task LoadDealerData(IServiceProvider sp)
    {
        var transfers = await sp.GetRequiredService<IAirtimeTransferService>().GetAllTransfersAsync();
        _myTransferCount = transfers.Count;
        _myPendingCount = transfers.Count(t => t.Status == DepositStatus.Pending);
        _myApprovedCount = transfers.Count(t => t.Status == DepositStatus.Approved);
        _myRejectedCount = transfers.Count(t => t.Status == DepositStatus.Rejected);
        _myCancelledCount = transfers.Count(t => t.Status == DepositStatus.Cancelled);
        _myApprovedAmount = transfers.Where(t => t.Status == DepositStatus.Approved).Sum(t => t.LoanAmount);
        _myTotalCommission = transfers.Where(t => t.Status == DepositStatus.Approved).Sum(t => t.CommissionAmount);
        _recentTransfers = transfers.OrderByDescending(t => t.CreatedDate).Take(6).ToList();

        _dealerProductRates = (await sp.GetRequiredService<IDealerService>().GetAllDealerProductRatesAsync()).ToList();
        var productMap = (await sp.GetRequiredService<IProductService>().GetAllProductsAsync()).ToDictionary(p => p.Id, p => p.Name);

        _commissionRows = _dealerProductRates
            .GroupBy(r => r.ProductId)
            .Select(g =>
            {
                var productName = productMap.TryGetValue(g.Key, out var n) ? n : $"Product #{g.Key}";
                var rate = g.Average(r => r.CommissionRate);
                var productTransfers = transfers.Where(t => t.ProductId == g.Key).ToList();
                var count = productTransfers.Count(t => t.Status == DepositStatus.Approved);
                var earned = productTransfers.Where(t => t.Status == DepositStatus.Approved).Sum(t => t.CommissionAmount);
                return new CommissionRow(productName, rate, count, earned);
            })
            .OrderByDescending(r => r.CommissionEarned)
            .ToList();
    }

    private async Task LoadCashierData(IServiceProvider sp)
    {
        var today = DateTime.UtcNow.Date;
        var cashDeposits = await sp.GetRequiredService<ICashDepositService>().GetAllDepositsAsync();
        _cashDepositCount = cashDeposits.Count;
        _totalCashDeposits = cashDeposits.Sum(d => d.Amount);
        _todayDepositCount = cashDeposits.Count(d => d.DepositDate.Date == today);
        _todayDepositAmount = cashDeposits.Where(d => d.DepositDate.Date == today).Sum(d => d.Amount);
        _recentCashDeposits = cashDeposits.OrderByDescending(d => d.DepositDate).Take(6).ToList();

        var expenses = await sp.GetRequiredService<IExpenseService>().GetAllExpensesAsync();
        _pendingExpensesCount = expenses.Count(e => e.Status == DepositStatus.Pending);
        _approvedExpensesCount = expenses.Count(e => e.Status == DepositStatus.Approved);
        _rejectedExpensesCount = expenses.Count(e => e.Status == DepositStatus.Rejected);
        _approvedExpensesAmount = expenses.Where(e => e.Status == DepositStatus.Approved).Sum(e => e.Amount);

        _expensesByCategory = expenses
            .GroupBy(e => e.CategoryName)
            .Select(g => new ExpenseCategoryRow(
                g.Key,
                g.Count(),
                g.Sum(e => e.Amount),
                g.Where(e => e.Status == DepositStatus.Approved).Sum(e => e.Amount)))
            .OrderByDescending(r => r.Total)
            .ToList();
    }

    private Color GetAuditColor(string action) => action switch
    {
        "Create" => Color.Success,
        "Update" => Color.Info,
        "Delete" => Color.Error,
        "Approve" => Color.Success,
        "Reject" => Color.Warning,
        _ => Color.Default
    };
}