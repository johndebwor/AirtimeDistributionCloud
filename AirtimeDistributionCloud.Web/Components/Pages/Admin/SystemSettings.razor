@page "/admin/settings"
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "SystemAdmin,SuperAdministrator")]
@using AirtimeDistributionCloud.Core.Entities
@using AirtimeDistributionCloud.Core.Interfaces
@inject IUnitOfWork UnitOfWork
@inject ISnackbar Snackbar
@rendermode InteractiveServer

<PageTitle>@(Lang?.T("Settings_Title") ?? "System Settings") - RasidBase</PageTitle>

<div class="page-header">
    <h1>@(Lang?.T("Settings_Title") ?? "System Settings")</h1>
    <p>@(Lang?.T("Settings_Subtitle") ?? "Configure application-wide settings")</p>
</div>

@if (_loading)
{
    <MudProgressLinear Indeterminate="true" />
}
else
{
    <!-- General Settings -->
    <MudPaper Elevation="0" Class="data-card pa-4 mb-4">
        <MudText Typo="Typo.h6" Class="mb-3">@(Lang?.T("Settings_GeneralSettings") ?? "General Settings")</MudText>
        <MudGrid>
            <!-- Airtime Deposit Auto Approve Toggle -->
            <MudItem xs="12">
                <MudPaper Elevation="1" Class="pa-4" Style="border-radius:8px;">
                    <div class="d-flex align-center justify-space-between">
                        <div>
                            <MudText Typo="Typo.subtitle2">@(Lang?.T("Settings_AutoApprove") ?? "Airtime Deposit Auto Approve")</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                @(Lang?.T("Settings_AutoApproveDesc") ?? "Automatically approve new airtime deposits without admin review")
                            </MudText>
                        </div>
                        <MudSwitch T="bool" Value="_autoApproveDeposit" ValueChanged="OnAutoApproveChanged"
                                   Color="Color.Primary" Disabled="@_saving" />
                    </div>
                </MudPaper>
            </MudItem>
            <!-- Passkey Login Toggle -->
            <MudItem xs="12">
                <MudPaper Elevation="1" Class="pa-4" Style="border-radius:8px;">
                    <div class="d-flex align-center justify-space-between">
                        <div>
                            <MudText Typo="Typo.subtitle2">@(Lang?.T("Settings_ShowPasskeyLogin") ?? "Show Passkey Sign-In on Login Page")</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                @(Lang?.T("Settings_ShowPasskeyLoginDesc") ?? "Show the 'Sign in with a passkey' option on the login page")
                            </MudText>
                        </div>
                        <MudSwitch T="bool" Value="_showPasskeyLogin" ValueChanged="OnPasskeyLoginChanged"
                                   Color="Color.Primary" Disabled="@_saving" />
                    </div>
                </MudPaper>
            </MudItem>
            @foreach (var setting in GetGeneralSettings())
            {
                <MudItem xs="12" sm="6">
                    <MudPaper Elevation="1" Class="pa-4 mb-2" Style="border-radius:8px;">
                        <MudText Typo="Typo.subtitle2" Class="mb-1">@FormatKey(setting.Key)</MudText>
                        @if (!string.IsNullOrEmpty(setting.Description))
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-2">@setting.Description</MudText>
                        }
                        <div class="d-flex align-center gap-2">
                            @if (_editingId == setting.Id)
                            {
                                <MudTextField @bind-Value="_editValue" Variant="Variant.Outlined"
                                              Margin="Margin.Dense" Style="flex:1" />
                                <MudIconButton Icon="@Icons.Material.Filled.Check" Color="Color.Success"
                                               Size="Size.Small" OnClick="@(() => SaveSetting(setting))" Disabled="@_saving" />
                                <MudIconButton Icon="@Icons.Material.Filled.Close" Color="Color.Default"
                                               Size="Size.Small" OnClick="CancelEdit" />
                            }
                            else
                            {
                                <MudText Typo="Typo.body1" Style="flex:1; font-weight:600;">@setting.Value</MudText>
                                <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary"
                                               Size="Size.Small" OnClick="@(() => StartEdit(setting))" />
                            }
                        </div>
                    </MudPaper>
                </MudItem>
            }
        </MudGrid>
    </MudPaper>

    <!-- Transfer Notification Settings -->
    <MudPaper Elevation="0" Class="data-card pa-4 mb-4">
        <div class="d-flex align-center gap-2 mb-3">
            <MudIcon Icon="@Icons.Material.Outlined.Notifications" />
            <MudText Typo="Typo.h6">@(Lang?.T("Settings_TransferNotification") ?? "Transfer Notification Settings")</MudText>
        </div>

        <MudGrid>
            <!-- Enabled Toggle -->
            <MudItem xs="12">
                <MudPaper Elevation="1" Class="pa-4" Style="border-radius:8px;">
                    <div class="d-flex align-center justify-space-between">
                        <div>
                            <MudText Typo="Typo.subtitle2">@(Lang?.T("Settings_NotifEnabled") ?? "Transfer Notification Enabled")</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                @(Lang?.T("Settings_NotifEnabledDesc") ?? "Enable dealer notifications when airtime transfers are approved")
                            </MudText>
                        </div>
                        <MudSwitch T="bool" Value="_notificationEnabled" ValueChanged="OnNotificationEnabledChanged"
                                   Color="Color.Primary" Disabled="@_saving" />
                    </div>
                </MudPaper>
            </MudItem>

            <!-- Notification Methods -->
            <MudItem xs="12" sm="6">
                <MudPaper Elevation="1" Class="pa-4" Style="border-radius:8px; height:100%;">
                    <MudText Typo="Typo.subtitle2" Class="mb-1">@(Lang?.T("Settings_NotifMethod") ?? "Transfer Notification Method")</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-3">
                        @(Lang?.T("Settings_NotifMethodDesc") ?? "Select one or more notification channels")
                    </MudText>
                    <MudCheckBox T="bool" Value="_emailChecked" ValueChanged="OnEmailChanged"
                                 Label="@(Lang?.T("Email") ?? "Email")" Color="Color.Primary"
                                 Disabled="@(!_notificationEnabled || _saving)" Class="mb-1" />
                    <MudCheckBox T="bool" Value="_dealerWhatsAppChecked" ValueChanged="OnDealerWhatsAppChanged"
                                 Label="@(Lang?.T("Settings_DealerWhatsApp") ?? "Dealer WhatsApp")" Color="Color.Primary"
                                 Disabled="@(!_notificationEnabled || _saving)" Class="mb-1" />
                    <MudCheckBox T="bool" Value="_whatsAppGroupChecked" ValueChanged="OnWhatsAppGroupChanged"
                                 Label="@(Lang?.T("Settings_WhatsAppGroup") ?? "WhatsApp Group")" Color="Color.Primary"
                                 Disabled="@(!_notificationEnabled || _saving)" />
                </MudPaper>
            </MudItem>

            <!-- WhatsApp Group URL -->
            <MudItem xs="12" sm="6">
                <MudPaper Elevation="1" Class="pa-4" Style="border-radius:8px; height:100%;">
                    <MudText Typo="Typo.subtitle2" Class="mb-1">@(Lang?.T("Settings_GroupUrl") ?? "Transfer Notification to WhatsApp Group Url")</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-3">
                        @(Lang?.T("Settings_GroupUrlDesc") ?? "WhatsApp group invite URL (used when WhatsApp Group method is selected)")
                    </MudText>
                    <div class="d-flex align-center gap-2">
                        @if (_editingWhatsAppUrl)
                        {
                            <MudTextField @bind-Value="_whatsAppGroupUrl" Variant="Variant.Outlined"
                                          Margin="Margin.Dense" Style="flex:1"
                                          Placeholder="https://chat.whatsapp.com/..."
                                          Disabled="@(!_notificationEnabled)" />
                            <MudIconButton Icon="@Icons.Material.Filled.Check" Color="Color.Success"
                                           Size="Size.Small" OnClick="SaveWhatsAppGroupUrl"
                                           Disabled="@(!_notificationEnabled || _saving)" />
                            <MudIconButton Icon="@Icons.Material.Filled.Close" Color="Color.Default"
                                           Size="Size.Small" OnClick="@(() => _editingWhatsAppUrl = false)" />
                        }
                        else
                        {
                            <MudText Typo="Typo.body1" Style="flex:1; font-weight:600; word-break:break-all;">
                                @(string.IsNullOrEmpty(_whatsAppGroupUrl) ? (Lang?.T("Settings_NotSet") ?? "(not set)") : _whatsAppGroupUrl)
                            </MudText>
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary"
                                           Size="Size.Small" OnClick="@(() => _editingWhatsAppUrl = true)"
                                           Disabled="@(!_notificationEnabled)" />
                        }
                    </div>
                </MudPaper>
            </MudItem>

            <!-- Template Editor with Preview -->
            <MudItem xs="12">
                <MudPaper Elevation="1" Class="pa-4" Style="border-radius:8px;">
                    <MudText Typo="Typo.subtitle2" Class="mb-1">@(Lang?.T("Settings_Template") ?? "Transfer Notification Template")</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-3">
                        @(Lang?.T("Settings_AvailablePlaceholders") ?? "Available placeholders"):
                        <code>@("{{Name}}")</code>, <code>@("{{DealerNumber}}")</code>, <code>@("{{AirtimeTransferId}}")</code>,
                        <code>@("{{Product}}")</code>, <code>@("{{AirtimeAmount}}")</code>, <code>@("{{CommissionAmount}}")</code>,
                        <code>@("{{Branch}}")</code>, <code>@("{{CreatedDate}}")</code>, <code>@("{{TotalBalance}}")</code>,
                        <code>@("{{TotalCommission}}")</code>, <code>@("{{CashBalance}}")</code>, <code>@("{{CompanyName}}")</code>
                    </MudText>
                    <MudGrid>
                        <MudItem xs="12" md="6">
                            <MudText Typo="Typo.body2" Class="mb-2" Style="font-weight:600;">@(Lang?.T("Settings_Editor") ?? "Editor")</MudText>
                            <MudTextField @bind-Value="_templateValue" Variant="Variant.Outlined"
                                          Lines="12" Immediate="true"
                                          Disabled="@(!_notificationEnabled)"
                                          Style="font-family:monospace; font-size:0.85rem;" />
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small"
                                       Class="mt-2" OnClick="SaveTemplate"
                                       Disabled="@(!_notificationEnabled || _saving)"
                                       StartIcon="@Icons.Material.Filled.Save">@(Lang?.T("Settings_SaveTemplate") ?? "Save Template")</MudButton>
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudText Typo="Typo.body2" Class="mb-2" Style="font-weight:600;">@(Lang?.T("Settings_Preview") ?? "Preview")</MudText>
                            <MudPaper Elevation="0" Class="pa-4"
                                      Style="border-radius:8px; border: 1px solid var(--mud-palette-divider); background: var(--mud-palette-background); min-height: 260px; font-size: 0.85rem;">
                                @((MarkupString)GetTemplatePreview())
                            </MudPaper>
                        </MudItem>
                    </MudGrid>
                </MudPaper>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <!-- Email Configuration -->
    <MudPaper Elevation="0" Class="data-card pa-4 mb-4">
        <div class="d-flex align-center gap-2 mb-3">
            <MudIcon Icon="@Icons.Material.Outlined.Email" />
            <MudText Typo="Typo.h6">@(Lang?.T("Settings_EmailConfig") ?? "Email Configuration (SMTP)")</MudText>
        </div>

        <MudGrid>
            <MudItem xs="12" sm="6">
                <MudTextField @bind-Value="_smtpHost" Label="@(Lang?.T("Settings_SmtpServer") ?? "SMTP Server")" Variant="Variant.Outlined"
                              Margin="Margin.Dense" Placeholder="smtp.gmail.com" />
            </MudItem>
            <MudItem xs="12" sm="3">
                <MudTextField @bind-Value="_smtpPort" Label="@(Lang?.T("Settings_Port") ?? "Port")" Variant="Variant.Outlined"
                              Margin="Margin.Dense" Placeholder="587" />
            </MudItem>
            <MudItem xs="12" sm="3">
                <MudPaper Elevation="0" Class="d-flex align-center" Style="height:100%;">
                    <MudSwitch T="bool" @bind-Value="_smtpUseSsl" Label="@(Lang?.T("Settings_UseSsl") ?? "Use SSL/TLS")" Color="Color.Primary" />
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="6">
                <MudTextField @bind-Value="_smtpUsername" Label="@(Lang?.T("Settings_Username") ?? "Username")" Variant="Variant.Outlined"
                              Margin="Margin.Dense" Placeholder="user@example.com" />
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudTextField @bind-Value="_smtpPassword" Label="@(Lang?.T("Password") ?? "Password")" Variant="Variant.Outlined"
                              Margin="Margin.Dense" Placeholder="••••••••"
                              InputType="@(_showPassword ? InputType.Text : InputType.Password)"
                              Adornment="Adornment.End"
                              AdornmentIcon="@(_showPassword ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)"
                              OnAdornmentClick="@(() => _showPassword = !_showPassword)" />
            </MudItem>

            <MudItem xs="12" sm="6">
                <MudTextField @bind-Value="_smtpSenderEmail" Label="@(Lang?.T("Settings_SenderEmail") ?? "Sender Email (From)")" Variant="Variant.Outlined"
                              Margin="Margin.Dense" Placeholder="noreply@company.com" />
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudTextField @bind-Value="_smtpSenderName" Label="@(Lang?.T("Settings_SenderName") ?? "Sender Name")" Variant="Variant.Outlined"
                              Margin="Margin.Dense" Placeholder="RasidBase" />
            </MudItem>

            <MudItem xs="12">
                <div class="d-flex align-center gap-2">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small"
                               OnClick="SaveEmailSettings" Disabled="@_savingEmail"
                               StartIcon="@Icons.Material.Filled.Save">
                        @(_savingEmail ? (Lang?.T("Saving") ?? "Saving...") : (Lang?.T("Settings_SaveEmail") ?? "Save Email Settings"))
                    </MudButton>
                </div>
            </MudItem>

            <!-- Test Email -->
            <MudItem xs="12">
                <MudPaper Elevation="1" Class="pa-4" Style="border-radius:8px;">
                    <MudText Typo="Typo.subtitle2" Class="mb-1">@(Lang?.T("Settings_SendTest") ?? "Send Test Email")</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-3">
                        @(Lang?.T("Settings_TestDesc") ?? "Save settings first, then send a test email to verify the configuration")
                    </MudText>
                    <div class="d-flex align-center gap-2">
                        <MudTextField @bind-Value="_testEmailAddress" Label="@(Lang?.T("Settings_RecipientEmail") ?? "Recipient Email")" Variant="Variant.Outlined"
                                      Margin="Margin.Dense" Style="max-width:360px;" Placeholder="test@example.com" />
                        <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small"
                                   OnClick="SendTestEmail" Disabled="@(_sendingTest || string.IsNullOrWhiteSpace(_testEmailAddress))"
                                   StartIcon="@Icons.Material.Filled.Send">
                            @(_sendingTest ? (Lang?.T("Sending") ?? "Sending...") : (Lang?.T("Settings_SendTestBtn") ?? "Send Test"))
                        </MudButton>
                    </div>
                </MudPaper>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <!-- WhatsApp Business API Configuration -->
    <MudPaper Elevation="0" Class="data-card pa-4 mb-4">
        <div class="d-flex align-center gap-2 mb-3">
            <MudIcon Icon="@Icons.Custom.Brands.WhatsApp" />
            <MudText Typo="Typo.h6">@(Lang?.T("Settings_WhatsAppApi") ?? "WhatsApp Business API")</MudText>
        </div>
        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3">
            @(Lang?.T("Settings_WhatsAppApiDesc") ?? "Configure Meta WhatsApp Business Cloud API credentials to send messages directly to dealers. Required when using the \"Dealer WhatsApp\" notification method.")
        </MudText>

        <MudGrid>
            <MudItem xs="12" sm="6">
                <MudTextField @bind-Value="_whatsAppApiPhoneNumberId" Label="@(Lang?.T("Settings_PhoneNumberId") ?? "Phone Number ID")" Variant="Variant.Outlined"
                              Margin="Margin.Dense" Placeholder="e.g. 123456789012345"
                              HelperText="From your Meta WhatsApp Business dashboard" />
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudTextField @bind-Value="_whatsAppApiAccessToken" Label="@(Lang?.T("Settings_AccessToken") ?? "Access Token")" Variant="Variant.Outlined"
                              Margin="Margin.Dense" Placeholder="EAAxxxxxxx..."
                              InputType="@(_showWhatsAppToken ? InputType.Text : InputType.Password)"
                              Adornment="Adornment.End"
                              AdornmentIcon="@(_showWhatsAppToken ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)"
                              OnAdornmentClick="@(() => _showWhatsAppToken = !_showWhatsAppToken)" />
            </MudItem>

            <MudItem xs="12">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small"
                           OnClick="SaveWhatsAppApiSettings" Disabled="@_savingWhatsApp"
                           StartIcon="@Icons.Material.Filled.Save">
                    @(_savingWhatsApp ? (Lang?.T("Saving") ?? "Saving...") : (Lang?.T("Settings_SaveWhatsApp") ?? "Save WhatsApp API Settings"))
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <!-- Currency Configuration -->
    <MudPaper Elevation="0" Class="data-card pa-4 mb-4">
        <div class="d-flex align-center gap-2 mb-3">
            <MudIcon Icon="@Icons.Material.Outlined.CurrencyExchange" />
            <MudText Typo="Typo.h6">@(Lang?.T("Settings_CurrencyConfig") ?? "Currency Configuration")</MudText>
        </div>
        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3">
            @(Lang?.T("Settings_CurrencyDesc") ?? "Configure the default currency and available currencies for the asset registry.")
        </MudText>

        <MudTable Items="_currencies" Dense="true" Hover="true" Striped="true" Elevation="1"
                  Style="border-radius: 8px;">
            <HeaderContent>
                <MudTh>@(Lang?.T("Settings_CurrencyCode") ?? "Code")</MudTh>
                <MudTh>@(Lang?.T("Settings_CurrencyName") ?? "Name")</MudTh>
                <MudTh>@(Lang?.T("Settings_CurrencySymbol") ?? "Symbol")</MudTh>
                <MudTh Style="text-align:center;">@(Lang?.T("Settings_Default") ?? "Default")</MudTh>
                <MudTh Style="text-align:center;">@(Lang?.T("Actions") ?? "Actions")</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Code"><MudText Typo="Typo.body2" Style="font-weight:600;">@context.Code</MudText></MudTd>
                <MudTd DataLabel="Name">@context.Name</MudTd>
                <MudTd DataLabel="Symbol">@context.Symbol</MudTd>
                <MudTd DataLabel="Default" Style="text-align:center;">
                    @if (context.Code == _defaultCurrency)
                    {
                        <MudChip T="string" Color="Color.Primary" Size="Size.Small" Variant="Variant.Filled">@(Lang?.T("Settings_Default") ?? "Default")</MudChip>
                    }
                    else
                    {
                        <MudButton Size="Size.Small" Variant="Variant.Text" Color="Color.Primary"
                                   OnClick="@(() => SetDefaultCurrency(context.Code))" Disabled="@_saving">
                            @(Lang?.T("Settings_SetDefault") ?? "Set Default")
                        </MudButton>
                    }
                </MudTd>
                <MudTd DataLabel="Actions" Style="text-align:center;">
                    @if (_currencies.Count > 1)
                    {
                        <MudTooltip Text="@(Lang?.T("Delete") ?? "Delete")">
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small"
                                           OnClick="@(() => RemoveCurrency(context.Code))" Disabled="@(_saving || context.Code == _defaultCurrency)" />
                        </MudTooltip>
                    }
                </MudTd>
            </RowTemplate>
        </MudTable>

        @if (_showAddCurrency)
        {
            <MudPaper Elevation="1" Class="pa-4 mt-3" Style="border-radius:8px; border-left: 4px solid var(--mud-palette-primary);">
                <MudText Typo="Typo.subtitle2" Class="mb-2">@(Lang?.T("Settings_AddCurrency") ?? "Add Currency")</MudText>
                <MudGrid>
                    <MudItem xs="12" sm="3">
                        <MudTextField @bind-Value="_newCurrencyCode" Label="@(Lang?.T("Settings_CurrencyCode") ?? "Code")" Variant="Variant.Outlined"
                                      Margin="Margin.Dense" Placeholder="e.g. EUR" MaxLength="3"
                                      Style="text-transform:uppercase;" />
                    </MudItem>
                    <MudItem xs="12" sm="4">
                        <MudTextField @bind-Value="_newCurrencyName" Label="@(Lang?.T("Settings_CurrencyName") ?? "Name")" Variant="Variant.Outlined"
                                      Margin="Margin.Dense" Placeholder="e.g. Euro" />
                    </MudItem>
                    <MudItem xs="12" sm="3">
                        <MudTextField @bind-Value="_newCurrencySymbol" Label="@(Lang?.T("Settings_CurrencySymbol") ?? "Symbol")" Variant="Variant.Outlined"
                                      Margin="Margin.Dense" Placeholder="e.g. €" />
                    </MudItem>
                    <MudItem xs="12" sm="2" Class="d-flex align-end gap-2">
                        <MudIconButton Icon="@Icons.Material.Filled.Check" Color="Color.Success" OnClick="AddCurrency" Disabled="@_saving" />
                        <MudIconButton Icon="@Icons.Material.Filled.Close" Color="Color.Default" OnClick="@(() => _showAddCurrency = false)" />
                    </MudItem>
                </MudGrid>
            </MudPaper>
        }
        else
        {
            <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small" Class="mt-3"
                       StartIcon="@Icons.Material.Filled.Add" OnClick="@(() => _showAddCurrency = true)">
                @(Lang?.T("Settings_AddCurrency") ?? "Add Currency")
            </MudButton>
        }
    </MudPaper>

    <!-- AI Assistant Configuration -->
    <MudPaper Elevation="0" Class="data-card pa-4 mb-4">
        <div class="d-flex align-center gap-2 mb-3">
            <MudIcon Icon="@Icons.Material.Outlined.SmartToy" />
            <MudText Typo="Typo.h6">@(Lang?.T("Settings_AIAssistant") ?? "AI Assistant")</MudText>
        </div>
        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3">
            @(Lang?.T("Settings_AIAssistantDesc") ?? "Configure the AI Assistant chat widget that helps users navigate the system.")
        </MudText>

        <MudGrid>
            <MudItem xs="12">
                <MudPaper Elevation="1" Class="pa-4" Style="border-radius:8px;">
                    <div class="d-flex align-center justify-space-between">
                        <div>
                            <MudText Typo="Typo.subtitle2">@(Lang?.T("Settings_AIEnabled") ?? "Enable AI Assistant")</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                @(Lang?.T("Settings_AIEnabledDesc") ?? "Show or hide the AI Assistant chat widget for all users")
                            </MudText>
                        </div>
                        <MudSwitch T="bool" Value="_aiAssistantEnabled" ValueChanged="OnAIAssistantEnabledChanged"
                                   Color="Color.Primary" Disabled="@_saving" />
                    </div>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudTextField @bind-Value="_aiAssistantName" Label="@(Lang?.T("Settings_AIName") ?? "Assistant Name")" Variant="Variant.Outlined"
                              Margin="Margin.Dense" Placeholder="RasidBase Assistant" />
            </MudItem>
            <MudItem xs="12">
                <MudTextField @bind-Value="_aiAssistantWelcomeMessage" Label="@(Lang?.T("Settings_AIWelcome") ?? "Welcome Message")" Variant="Variant.Outlined"
                              Lines="3" Placeholder="Hello! I'm your assistant..." />
            </MudItem>
        </MudGrid>

        <!-- API Configuration -->
        <MudDivider Class="my-4" />
        <div class="d-flex align-center gap-2 mb-2">
            <MudIcon Icon="@Icons.Material.Outlined.Api" Size="Size.Small" />
            <MudText Typo="Typo.subtitle1" Style="font-weight:600;">@(Lang?.T("Settings_AIApiConfig") ?? "API Configuration")</MudText>
        </div>
        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-3">
            @(Lang?.T("Settings_AIApiConfigDesc") ?? "Connect to an AI provider (OpenAI, Anthropic, etc.) to enable intelligent responses. Leave blank to use built-in FAQ responses.")
        </MudText>

        <MudGrid>
            <MudItem xs="12" sm="6">
                <MudTextField @bind-Value="_aiApiEndpoint" Label="@(Lang?.T("Settings_AIApiEndpoint") ?? "API Endpoint")" Variant="Variant.Outlined"
                              Margin="Margin.Dense" Placeholder="https://api.openai.com/v1/chat/completions"
                              HelperText="@(Lang?.T("Settings_AIApiEndpointHelp") ?? "Full URL of the chat completions API endpoint")" />
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudTextField @bind-Value="_aiModel" Label="@(Lang?.T("Settings_AIModel") ?? "Model")" Variant="Variant.Outlined"
                              Margin="Margin.Dense" Placeholder="gpt-4o-mini"
                              HelperText="@(Lang?.T("Settings_AIModelHelp") ?? "Model name (e.g. gpt-4o-mini, claude-sonnet-4-6)")" />
            </MudItem>
            <MudItem xs="12">
                <MudTextField @bind-Value="_aiApiKey" Label="@(Lang?.T("Settings_AIApiKey") ?? "API Key")" Variant="Variant.Outlined"
                              Margin="Margin.Dense" Placeholder="sk-..."
                              InputType="@(_showApiKey ? InputType.Text : InputType.Password)"
                              Adornment="Adornment.End"
                              AdornmentIcon="@(_showApiKey ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)"
                              OnAdornmentClick="@(() => _showApiKey = !_showApiKey)"
                              HelperText="@(Lang?.T("Settings_AIApiKeyHelp") ?? "Your API key from the AI provider. Stored securely in the database.")" />
            </MudItem>
            <MudItem xs="12">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small"
                           OnClick="SaveAIAssistantSettings" Disabled="@_savingAI"
                           StartIcon="@Icons.Material.Filled.Save">
                    @(_savingAI ? (Lang?.T("Saving") ?? "Saving...") : (Lang?.T("Settings_SaveAI") ?? "Save AI Assistant Settings"))
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <!-- Danger Zone (Formulas) -->
    @if (_settings.Any(s => IsDangerSetting(s.Key)))
    {
        <MudPaper Elevation="0" Class="data-card pa-4">
            <MudPaper Elevation="1" Class="pa-4" Style="border: 2px solid var(--mud-palette-error); border-radius: 8px;">
                <div class="d-flex align-center gap-2 mb-2">
                    <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Error" />
                    <MudText Typo="Typo.h6" Color="Color.Error">@(Lang?.T("Settings_DangerZone") ?? "Danger Zone")</MudText>
                </div>
                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                    @(Lang?.T("Settings_DangerDesc") ?? "These formulas define how airtime calculations are performed. Edit with caution — changes serve as documentation for all future transactions.")
                </MudText>
                <MudGrid>
                    @foreach (var setting in _settings.Where(s => IsDangerSetting(s.Key)))
                    {
                        <MudItem xs="12">
                            <MudPaper Elevation="1" Class="pa-4 mb-2" Style="border-radius:8px; border-left: 4px solid var(--mud-palette-error);">
                                <MudText Typo="Typo.subtitle2" Class="mb-1">@FormatKey(setting.Key)</MudText>
                                @if (!string.IsNullOrEmpty(setting.Description))
                                {
                                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-2">@setting.Description</MudText>
                                }
                                <div class="d-flex align-center gap-2">
                                    @if (_editingId == setting.Id)
                                    {
                                        <MudTextField @bind-Value="_editValue" Variant="Variant.Outlined"
                                                      Margin="Margin.Dense" Style="flex:1; font-family:monospace;" />
                                        <MudIconButton Icon="@Icons.Material.Filled.Check" Color="Color.Success"
                                                       Size="Size.Small" OnClick="@(() => SaveSetting(setting))" Disabled="@_saving" />
                                        <MudIconButton Icon="@Icons.Material.Filled.Close" Color="Color.Default"
                                                       Size="Size.Small" OnClick="CancelEdit" />
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body1" Style="flex:1; font-weight:600; font-family:monospace;">@setting.Value</MudText>
                                        <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Error"
                                                       Size="Size.Small" OnClick="@(() => StartEdit(setting))" />
                                    }
                                </div>
                            </MudPaper>
                        </MudItem>
                    }
                </MudGrid>
                <MudButton Variant="Variant.Outlined" Color="Color.Error" Size="Size.Small"
                           Class="mt-3" OnClick="ResetFormulasToDefault"
                           StartIcon="@Icons.Material.Filled.RestartAlt" Disabled="@_saving">
                    @(Lang?.T("Settings_ResetDefault") ?? "Reset to Default")
                </MudButton>
            </MudPaper>
        </MudPaper>
    }
}

@code {
    [CascadingParameter] public AirtimeDistributionCloud.Application.Services.ILanguageService? Lang { get; set; }

    private List<SystemSetting> _settings = new();
    private bool _loading = true;
    private bool _saving;
    private int? _editingId;
    private string _editValue = "";

    // General state
    private bool _autoApproveDeposit;
    private bool _showPasskeyLogin = true;

    // Notification state
    private bool _notificationEnabled;
    private bool _emailChecked;
    private bool _dealerWhatsAppChecked;
    private bool _whatsAppGroupChecked;
    private string _whatsAppGroupUrl = "";
    private string _templateValue = "";
    private bool _editingWhatsAppUrl;

    // Email configuration state
    private string _smtpHost = "";
    private string _smtpPort = "587";
    private string _smtpUsername = "";
    private string _smtpPassword = "";
    private string _smtpSenderEmail = "";
    private string _smtpSenderName = "";
    private bool _smtpUseSsl = true;
    private bool _savingEmail;
    private bool _sendingTest;
    private string _testEmailAddress = "";
    private bool _showPassword;

    // WhatsApp API configuration state
    private string _whatsAppApiAccessToken = "";
    private string _whatsAppApiPhoneNumberId = "";
    private bool _savingWhatsApp;
    private bool _showWhatsAppToken;

    // Currency configuration state
    private string _defaultCurrency = "SSP";
    private string _availableCurrencies = "SSP, USD";
    private List<CurrencyItem> _currencies = new();
    private bool _showAddCurrency;
    private string _newCurrencyCode = "";
    private string _newCurrencyName = "";
    private string _newCurrencySymbol = "";

    // AI Assistant configuration state
    private bool _aiAssistantEnabled = true;
    private string _aiAssistantName = "RasidBase Assistant";
    private string _aiAssistantWelcomeMessage = "";
    private string _aiApiKey = "";
    private string _aiApiEndpoint = "";
    private string _aiModel = "";
    private bool _showApiKey;
    private bool _savingAI;

    private record CurrencyItem(string Code, string Name, string Symbol);

    private static readonly Dictionary<string, (string Name, string Symbol)> KnownCurrencies = new()
    {
        ["SSP"] = ("South Sudan Pound", "SSP"),
        ["USD"] = ("US Dollar", "$"),
        ["EUR"] = ("Euro", "€"),
        ["GBP"] = ("British Pound", "£"),
        ["AED"] = ("UAE Dirham", "د.إ"),
        ["SAR"] = ("Saudi Riyal", "﷼"),
        ["KES"] = ("Kenyan Shilling", "KSh"),
        ["UGX"] = ("Ugandan Shilling", "USh"),
        ["ETB"] = ("Ethiopian Birr", "Br"),
        ["SDG"] = ("Sudanese Pound", "ج.س"),
    };

    // General settings display order (AirtimeDepositAutoApprove handled as toggle above)
    private static readonly string[] GeneralSettingsOrder =
        ["ExpenseApprovalThreshold", "CommissionMinPercentage", "CommissionMaxPercentage"];

    private static readonly HashSet<string> ToggleKeys =
        ["AirtimeDepositAutoApprove"];

    private static readonly HashSet<string> NotificationKeys =
        ["TransferNotificationEnabled", "TransferNotificationMethod",
         "TransferNotificationWhatsAppGroupUrl", "TransferNotificationTemplate"];

    private static readonly HashSet<string> EmailKeys =
        ["SmtpHost", "SmtpPort", "SmtpUsername", "SmtpPassword",
         "SmtpSenderEmail", "SmtpSenderName", "SmtpUseSsl"];

    private static readonly HashSet<string> WhatsAppApiKeys =
        ["WhatsAppApiAccessToken", "WhatsAppApiPhoneNumberId"];

    private static readonly HashSet<string> CurrencyKeys =
        ["DefaultCurrency", "AvailableCurrencies"];

    private static readonly HashSet<string> AIAssistantKeys =
        ["AIAssistantEnabled", "AIAssistantName", "AIAssistantWelcomeMessage",
         "AIApiKey", "AIApiEndpoint", "AIModel"];

    private static readonly HashSet<string> CompanyKeys =
        ["CompanyName", "CompanyAbbreviation", "CompanyAddress", "CompanyTel1", "CompanyTel2", "CompanyTel3",
         "CompanyLogoPath", "CompanyStampPath",
         "CompanyNameAr", "CompanyAbbreviationAr", "CompanyAddressAr"];

    protected override async Task OnInitializedAsync()
    {
        await LoadSettings();
    }

    private async Task LoadSettings()
    {
        _loading = true;
        try
        {
            _settings = (await UnitOfWork.Repository<SystemSetting>().GetAllAsync()).ToList();
            InitializeNotificationState();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"{Lang?.T("Error") ?? "Error"}: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private void InitializeNotificationState()
    {
        var dict = _settings.ToDictionary(s => s.Key, s => s.Value);

        _autoApproveDeposit = dict.TryGetValue("AirtimeDepositAutoApprove", out var aa) &&
                              string.Equals(aa, "Yes", StringComparison.OrdinalIgnoreCase);

        _showPasskeyLogin = !dict.TryGetValue("ShowPasskeyLogin", out var pk) ||
                            !string.Equals(pk, "No", StringComparison.OrdinalIgnoreCase);

        _notificationEnabled = dict.TryGetValue("TransferNotificationEnabled", out var en) &&
                               string.Equals(en, "Yes", StringComparison.OrdinalIgnoreCase);

        if (dict.TryGetValue("TransferNotificationMethod", out var methods))
        {
            var parts = methods.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
            _emailChecked = parts.Contains("Email");
            _dealerWhatsAppChecked = parts.Contains("DealerWhatsApp");
            _whatsAppGroupChecked = parts.Contains("WhatsAppGroup");
        }

        _whatsAppGroupUrl = dict.GetValueOrDefault("TransferNotificationWhatsAppGroupUrl", "");
        _templateValue = dict.GetValueOrDefault("TransferNotificationTemplate", "");

        // Email configuration
        _smtpHost = dict.GetValueOrDefault("SmtpHost", "");
        _smtpPort = dict.GetValueOrDefault("SmtpPort", "587");
        _smtpUsername = dict.GetValueOrDefault("SmtpUsername", "");
        _smtpPassword = dict.GetValueOrDefault("SmtpPassword", "");
        _smtpSenderEmail = dict.GetValueOrDefault("SmtpSenderEmail", "");
        _smtpSenderName = dict.GetValueOrDefault("SmtpSenderName", "");
        _smtpUseSsl = !dict.TryGetValue("SmtpUseSsl", out var ssl) ||
                      string.Equals(ssl, "Yes", StringComparison.OrdinalIgnoreCase);

        // WhatsApp API configuration
        _whatsAppApiAccessToken = dict.GetValueOrDefault("WhatsAppApiAccessToken", "");
        _whatsAppApiPhoneNumberId = dict.GetValueOrDefault("WhatsAppApiPhoneNumberId", "");

        // Currency configuration
        _defaultCurrency = dict.GetValueOrDefault("DefaultCurrency", "SSP");
        _availableCurrencies = dict.GetValueOrDefault("AvailableCurrencies", "SSP, USD");
        ParseCurrencies();

        // AI Assistant configuration
        _aiAssistantEnabled = !dict.TryGetValue("AIAssistantEnabled", out var aiEn) ||
                              string.Equals(aiEn, "Yes", StringComparison.OrdinalIgnoreCase);
        _aiAssistantName = dict.GetValueOrDefault("AIAssistantName", "RasidBase Assistant");
        _aiAssistantWelcomeMessage = dict.GetValueOrDefault("AIAssistantWelcomeMessage", "");
        _aiApiKey = dict.GetValueOrDefault("AIApiKey", "");
        _aiApiEndpoint = dict.GetValueOrDefault("AIApiEndpoint", "");
        _aiModel = dict.GetValueOrDefault("AIModel", "");
    }

    private void ParseCurrencies()
    {
        _currencies.Clear();
        var codes = _availableCurrencies.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
        foreach (var code in codes)
        {
            var upper = code.Trim().ToUpperInvariant();
            if (string.IsNullOrEmpty(upper)) continue;
            var name = KnownCurrencies.TryGetValue(upper, out var known) ? known.Name : upper;
            var symbol = KnownCurrencies.TryGetValue(upper, out var k2) ? k2.Symbol : upper;
            _currencies.Add(new CurrencyItem(upper, name, symbol));
        }
    }

    private IEnumerable<SystemSetting> GetGeneralSettings()
    {
        var dict = _settings.ToDictionary(s => s.Key);
        foreach (var key in GeneralSettingsOrder)
        {
            if (dict.TryGetValue(key, out var setting))
                yield return setting;
        }
        // Any additional non-notification, non-formula, non-toggle, non-company settings
        foreach (var s in _settings.Where(s => !NotificationKeys.Contains(s.Key) &&
                                               !IsDangerSetting(s.Key) &&
                                               !GeneralSettingsOrder.Contains(s.Key) &&
                                               !ToggleKeys.Contains(s.Key) &&
                                               !CompanyKeys.Contains(s.Key) &&
                                               !EmailKeys.Contains(s.Key) &&
                                               !WhatsAppApiKeys.Contains(s.Key) &&
                                               !CurrencyKeys.Contains(s.Key) &&
                                               !AIAssistantKeys.Contains(s.Key)))
            yield return s;
    }

    // --- General settings edit ---

    private void StartEdit(SystemSetting setting)
    {
        _editingId = setting.Id;
        _editValue = setting.Value;
    }

    private void CancelEdit()
    {
        _editingId = null;
        _editValue = "";
    }

    private async Task SaveSetting(SystemSetting setting)
    {
        _saving = true;
        try
        {
            setting.Value = _editValue;
            await UnitOfWork.Repository<SystemSetting>().UpdateAsync(setting);
            await UnitOfWork.SaveChangesAsync();
            _editingId = null;
            Snackbar.Add(Lang?.T("Settings_Updated") ?? "Setting updated", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"{Lang?.T("Error") ?? "Error"}: {ex.Message}", Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    // --- Notification settings ---

    private async Task SaveNotificationSetting(string key, string value)
    {
        _saving = true;
        try
        {
            var setting = _settings.FirstOrDefault(s => s.Key == key);
            if (setting is not null)
            {
                setting.Value = value;
                await UnitOfWork.Repository<SystemSetting>().UpdateAsync(setting);
                await UnitOfWork.SaveChangesAsync();
                Snackbar.Add(Lang?.T("Settings_Updated") ?? "Setting updated", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"{Lang?.T("Error") ?? "Error"}: {ex.Message}", Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task OnAutoApproveChanged(bool value)
    {
        _autoApproveDeposit = value;
        await SaveNotificationSetting("AirtimeDepositAutoApprove", value ? "Yes" : "No");
    }

    private async Task OnPasskeyLoginChanged(bool value)
    {
        _showPasskeyLogin = value;
        await SaveNotificationSetting("ShowPasskeyLogin", value ? "Yes" : "No");
    }

    private async Task OnNotificationEnabledChanged(bool value)
    {
        _notificationEnabled = value;
        await SaveNotificationSetting("TransferNotificationEnabled", value ? "Yes" : "No");
    }

    private async Task OnEmailChanged(bool value)
    {
        _emailChecked = value;
        await SaveMethodSettings();
    }

    private async Task OnDealerWhatsAppChanged(bool value)
    {
        _dealerWhatsAppChecked = value;
        await SaveMethodSettings();
    }

    private async Task OnWhatsAppGroupChanged(bool value)
    {
        _whatsAppGroupChecked = value;
        await SaveMethodSettings();
    }

    private async Task SaveMethodSettings()
    {
        var methods = new List<string>();
        if (_emailChecked) methods.Add("Email");
        if (_dealerWhatsAppChecked) methods.Add("DealerWhatsApp");
        if (_whatsAppGroupChecked) methods.Add("WhatsAppGroup");
        await SaveNotificationSetting("TransferNotificationMethod", string.Join(",", methods));
    }

    private async Task SaveWhatsAppGroupUrl()
    {
        await SaveNotificationSetting("TransferNotificationWhatsAppGroupUrl", _whatsAppGroupUrl);
        _editingWhatsAppUrl = false;
    }

    private async Task SaveTemplate()
    {
        await SaveNotificationSetting("TransferNotificationTemplate", _templateValue);
    }

    // --- Template preview ---

    private string GetTemplatePreview()
    {
        if (string.IsNullOrWhiteSpace(_templateValue))
            return $"<em style='color:var(--mud-palette-text-secondary)'>({Lang?.T("Settings_NoTemplate") ?? "No template configured"})</em>";

        var preview = System.Net.WebUtility.HtmlEncode(_templateValue)
            .Replace("{{Name}}", "<strong>John Okoth</strong>")
            .Replace("{{DealerNumber}}", "<strong>DLR-0001</strong>")
            .Replace("{{AirtimeTransferId}}", "<strong>1042</strong>")
            .Replace("{{Product}}", "<strong>MTN Airtime</strong>")
            .Replace("{{AirtimeAmount}}", "<strong>50,000.00</strong>")
            .Replace("{{CommissionAmount}}", "<strong>5,000.00</strong>")
            .Replace("{{Branch}}", "<strong>Main Branch</strong>")
            .Replace("{{CreatedDate}}", $"<strong>{DateTime.Now:dd/MM/yyyy HH:mm}</strong>")
            .Replace("{{TotalBalance}}", "<strong>150,000.00</strong>")
            .Replace("{{TotalCommission}}", "<strong>25,000.00</strong>")
            .Replace("{{CashBalance}}", "<strong>75,000.00</strong>")
            .Replace("{{CompanyName}}", "<strong>Guru Brothers Ltd</strong>")
            .Replace("\n", "<br />");

        return preview;
    }

    private static readonly Dictionary<string, string> DefaultFormulas = new()
    {
        ["AirtimeDepositFormula"] = "TotalAmount = Amount + (Amount × BonusPercentage ÷ 100)",
        ["AirtimeTransferFormula"] = "AirtimeAmount = Amount ÷ (1 + CommissionRate ÷ 100); CommissionAmount = Amount − AirtimeAmount; DeductedFromProduct = Amount (AirtimeAmount + CommissionAmount)"
    };

    private async Task ResetFormulasToDefault()
    {
        _saving = true;
        try
        {
            foreach (var setting in _settings.Where(s => IsDangerSetting(s.Key)))
            {
                if (DefaultFormulas.TryGetValue(setting.Key, out var defaultValue))
                {
                    setting.Value = defaultValue;
                    await UnitOfWork.Repository<SystemSetting>().UpdateAsync(setting);
                }
            }
            await UnitOfWork.SaveChangesAsync();
            Snackbar.Add(Lang?.T("Settings_FormulasReset") ?? "Formulas reset to default", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"{Lang?.T("Error") ?? "Error"}: {ex.Message}", Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    private static bool IsDangerSetting(string key) => key.EndsWith("Formula");

    // --- Email configuration ---

    private async Task SaveEmailSettings()
    {
        _savingEmail = true;
        try
        {
            var emailSettings = new Dictionary<string, string>
            {
                ["SmtpHost"] = _smtpHost,
                ["SmtpPort"] = _smtpPort,
                ["SmtpUsername"] = _smtpUsername,
                ["SmtpPassword"] = _smtpPassword,
                ["SmtpSenderEmail"] = _smtpSenderEmail,
                ["SmtpSenderName"] = _smtpSenderName,
                ["SmtpUseSsl"] = _smtpUseSsl ? "Yes" : "No"
            };

            foreach (var (key, value) in emailSettings)
            {
                var setting = _settings.FirstOrDefault(s => s.Key == key);
                if (setting is not null)
                {
                    setting.Value = value;
                    await UnitOfWork.Repository<SystemSetting>().UpdateAsync(setting);
                }
            }
            await UnitOfWork.SaveChangesAsync();
            Snackbar.Add(Lang?.T("Settings_EmailSaved") ?? "Email settings saved", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"{Lang?.T("Error") ?? "Error"}: {ex.Message}", Severity.Error);
        }
        finally
        {
            _savingEmail = false;
        }
    }

    // --- WhatsApp API configuration ---

    private async Task SaveWhatsAppApiSettings()
    {
        _savingWhatsApp = true;
        try
        {
            var waSettings = new Dictionary<string, string>
            {
                ["WhatsAppApiAccessToken"] = _whatsAppApiAccessToken,
                ["WhatsAppApiPhoneNumberId"] = _whatsAppApiPhoneNumberId
            };

            foreach (var (key, value) in waSettings)
            {
                var setting = _settings.FirstOrDefault(s => s.Key == key);
                if (setting is not null)
                {
                    setting.Value = value;
                    await UnitOfWork.Repository<SystemSetting>().UpdateAsync(setting);
                }
            }
            await UnitOfWork.SaveChangesAsync();
            Snackbar.Add(Lang?.T("Settings_WhatsAppSaved") ?? "WhatsApp API settings saved", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"{Lang?.T("Error") ?? "Error"}: {ex.Message}", Severity.Error);
        }
        finally
        {
            _savingWhatsApp = false;
        }
    }

    // --- Currency configuration ---

    private async Task AddCurrency()
    {
        var code = _newCurrencyCode.Trim().ToUpperInvariant();
        if (string.IsNullOrEmpty(code) || code.Length > 3)
        {
            Snackbar.Add(Lang?.T("Settings_InvalidCode") ?? "Currency code must be 1-3 characters", Severity.Warning);
            return;
        }
        if (_currencies.Any(c => c.Code == code))
        {
            Snackbar.Add(Lang?.T("Settings_CurrencyExists") ?? "Currency already exists", Severity.Warning);
            return;
        }

        var name = string.IsNullOrWhiteSpace(_newCurrencyName)
            ? (KnownCurrencies.TryGetValue(code, out var kn) ? kn.Name : code)
            : _newCurrencyName.Trim();
        var symbol = string.IsNullOrWhiteSpace(_newCurrencySymbol)
            ? (KnownCurrencies.TryGetValue(code, out var ks) ? ks.Symbol : code)
            : _newCurrencySymbol.Trim();

        _currencies.Add(new CurrencyItem(code, name, symbol));
        _newCurrencyCode = "";
        _newCurrencyName = "";
        _newCurrencySymbol = "";
        _showAddCurrency = false;
        await SaveCurrencySettings();
    }

    private async Task RemoveCurrency(string code)
    {
        _currencies.RemoveAll(c => c.Code == code);
        if (_defaultCurrency == code && _currencies.Count > 0)
            _defaultCurrency = _currencies[0].Code;
        await SaveCurrencySettings();
    }

    private async Task SetDefaultCurrency(string code)
    {
        _defaultCurrency = code;
        await SaveCurrencySettings();
    }

    private async Task SaveCurrencySettings()
    {
        _saving = true;
        try
        {
            _availableCurrencies = string.Join(", ", _currencies.Select(c => c.Code));
            var currencySettings = new Dictionary<string, string>
            {
                ["DefaultCurrency"] = _defaultCurrency,
                ["AvailableCurrencies"] = _availableCurrencies
            };

            foreach (var (key, value) in currencySettings)
            {
                var setting = _settings.FirstOrDefault(s => s.Key == key);
                if (setting is not null)
                {
                    setting.Value = value;
                    await UnitOfWork.Repository<SystemSetting>().UpdateAsync(setting);
                }
            }
            await UnitOfWork.SaveChangesAsync();
            Snackbar.Add(Lang?.T("Settings_CurrencySaved") ?? "Currency settings saved", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"{Lang?.T("Error") ?? "Error"}: {ex.Message}", Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    // --- AI Assistant configuration ---

    private async Task OnAIAssistantEnabledChanged(bool value)
    {
        _aiAssistantEnabled = value;
        await SaveNotificationSetting("AIAssistantEnabled", value ? "Yes" : "No");
    }

    private async Task SaveAIAssistantSettings()
    {
        _savingAI = true;
        try
        {
            var aiSettings = new Dictionary<string, string>
            {
                ["AIAssistantEnabled"] = _aiAssistantEnabled ? "Yes" : "No",
                ["AIAssistantName"] = _aiAssistantName,
                ["AIAssistantWelcomeMessage"] = _aiAssistantWelcomeMessage,
                ["AIApiKey"] = _aiApiKey,
                ["AIApiEndpoint"] = _aiApiEndpoint,
                ["AIModel"] = _aiModel
            };

            foreach (var (key, value) in aiSettings)
            {
                var setting = _settings.FirstOrDefault(s => s.Key == key);
                if (setting is not null)
                {
                    setting.Value = value;
                    await UnitOfWork.Repository<SystemSetting>().UpdateAsync(setting);
                }
            }
            await UnitOfWork.SaveChangesAsync();
            Snackbar.Add(Lang?.T("Settings_AISaved") ?? "AI Assistant settings saved", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"{Lang?.T("Error") ?? "Error"}: {ex.Message}", Severity.Error);
        }
        finally
        {
            _savingAI = false;
        }
    }

    private async Task SendTestEmail()
    {
        _sendingTest = true;
        try
        {
            if (string.IsNullOrWhiteSpace(_smtpHost))
            {
                Snackbar.Add(Lang?.T("Settings_ConfigureSmtp") ?? "Please configure SMTP server first", Severity.Warning);
                return;
            }

            using var smtp = new System.Net.Mail.SmtpClient(_smtpHost);
            smtp.Port = int.TryParse(_smtpPort, out var port) ? port : 587;
            smtp.EnableSsl = _smtpUseSsl;
            if (!string.IsNullOrWhiteSpace(_smtpUsername))
                smtp.Credentials = new System.Net.NetworkCredential(_smtpUsername, _smtpPassword);

            var from = new System.Net.Mail.MailAddress(
                string.IsNullOrWhiteSpace(_smtpSenderEmail) ? _smtpUsername : _smtpSenderEmail,
                string.IsNullOrWhiteSpace(_smtpSenderName) ? "RasidBase" : _smtpSenderName);

            var message = new System.Net.Mail.MailMessage(from, new System.Net.Mail.MailAddress(_testEmailAddress))
            {
                Subject = "RasidBase - Test Email",
                Body = "This is a test email from RasidBase to verify your SMTP configuration is working correctly.\n\nIf you received this, your email settings are configured properly.",
                IsBodyHtml = false
            };

            await smtp.SendMailAsync(message);
            Snackbar.Add(Lang?.T("Settings_TestSent") ?? $"Test email sent to {_testEmailAddress}", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"{Lang?.T("Settings_FailedToSend") ?? "Failed to send"}: {ex.Message}", Severity.Error);
        }
        finally
        {
            _sendingTest = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private static readonly Dictionary<string, string> FriendlyLabels = new()
    {
        ["ExpenseApprovalThreshold"] = "Expense Approval Threshold",
        ["CommissionMinPercentage"] = "Minimum Commission (%)",
        ["CommissionMaxPercentage"] = "Maximum Commission (%)",
        ["AirtimeDepositAutoApprove"] = "Airtime Deposit Auto-Approve",
        ["AirtimeDepositFormula"] = "Airtime Deposit Formula",
        ["AirtimeTransferFormula"] = "Airtime Transfer Formula",
        ["TransferNotificationEnabled"] = "Transfer Notification Enabled",
        ["TransferNotificationMethod"] = "Notification Method",
        ["TransferNotificationWhatsAppGroupUrl"] = "WhatsApp Group URL",
        ["TransferNotificationTemplate"] = "Notification Template",
        ["SmtpHost"] = "SMTP Server Host",
        ["SmtpPort"] = "SMTP Port",
        ["SmtpUsername"] = "SMTP Username",
        ["SmtpPassword"] = "SMTP Password",
        ["SmtpSenderEmail"] = "Sender Email Address",
        ["SmtpSenderName"] = "Sender Display Name",
        ["SmtpUseSsl"] = "Use SSL/TLS",
        ["WhatsAppApiAccessToken"] = "WhatsApp API Access Token",
        ["WhatsAppApiPhoneNumberId"] = "WhatsApp Phone Number ID",
        ["DefaultCurrency"] = "Default Currency",
        ["AvailableCurrencies"] = "Available Currencies",
        ["CompanyName"] = "Company Name",
        ["CompanyNameAr"] = "Company Name (Arabic)",
        ["CompanyAbbreviation"] = "Company Abbreviation",
        ["CompanyAbbreviationAr"] = "Company Abbreviation (Arabic)",
        ["CompanyAddress"] = "Company Address",
        ["CompanyAddressAr"] = "Company Address (Arabic)",
        ["CompanyTel1"] = "Phone Number 1",
        ["CompanyTel2"] = "Phone Number 2",
        ["CompanyTel3"] = "Phone Number 3",
        ["CompanyLogoPath"] = "Company Logo",
        ["CompanyStampPath"] = "Company Stamp",
        ["AIAssistantEnabled"] = "AI Assistant Enabled",
        ["AIAssistantName"] = "Assistant Name",
        ["AIAssistantWelcomeMessage"] = "Welcome Message",
        ["AIApiKey"] = "AI API Key",
        ["AIApiEndpoint"] = "AI API Endpoint",
        ["AIModel"] = "AI Model",
    };

    private static string FormatKey(string key) =>
        FriendlyLabels.TryGetValue(key, out var label)
            ? label
            : System.Text.RegularExpressions.Regex.Replace(key, "([A-Z])", " $1").Trim();
}
