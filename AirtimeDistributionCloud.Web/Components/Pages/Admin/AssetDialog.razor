@rendermode InteractiveServer
@using AirtimeDistributionCloud.Application.DTOs
@using AirtimeDistributionCloud.Application.Services
@using AirtimeDistributionCloud.Core.Enums
@using AirtimeDistributionCloud.Core.Interfaces
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Hosting
@inject IAssetService AssetService
@inject ICurrentUserService CurrentUser
@inject ISnackbar Snackbar
@inject IJSRuntime JS
@inject IWebHostEnvironment Env

<MudDialog>
    <DialogContent>
        <MudTextField @bind-Value="_name" Label="@(Lang?.T("Name") ?? "Name")" Required="true"
                      RequiredError="@(Lang?.T("NameRequired") ?? "Name is required")" Class="mb-3" />
        <MudSelect T="int" @bind-Value="_categoryId" Label="@(Lang?.T("Category") ?? "Category")" Required="true"
                   RequiredError="@(Lang?.T("CategoryRequired") ?? "Category is required")" Placeholder="@(Lang?.T("SelectCategory") ?? "-- Select Category --")" Class="mb-3">
            @foreach (var cat in Categories)
            {
                <MudSelectItem T="int" Value="@cat.Id">@cat.Name</MudSelectItem>
            }
        </MudSelect>
        <MudTextField @bind-Value="_serialNumber" Label="@(Lang?.T("AssetDetail_SerialNumber") ?? "Serial Number")" Class="mb-3" />
        <MudTextField @bind-Value="_assetTag" Label="@(Lang?.T("AssetDetail_AssetTag") ?? "Asset Tag")" Class="mb-3" />
        <MudSelect T="int" @bind-Value="_branchId" Label="@(Lang?.T("Branch") ?? "Branch")" Required="true"
                   RequiredError="@(Lang?.T("BranchRequired") ?? "Branch is required")" Placeholder="@(Lang?.T("SelectBranch") ?? "-- Select Branch --")" Class="mb-3">
            @foreach (var b in Branches)
            {
                <MudSelectItem T="int" Value="@b.Id">@b.Name</MudSelectItem>
            }
        </MudSelect>
        <MudDatePicker @bind-Date="_purchaseDate" Label="@(Lang?.T("AssetDialog_PurchaseDate") ?? "Purchase Date")" Class="mb-3"
                       DateFormat="dd MMM yyyy" />
        <MudSelect T="string" @bind-Value="_currency" Label="@(Lang?.T("AssetDetail_Currency") ?? "Currency")" Required="true"
                   RequiredError="@(Lang?.T("AssetDialog_CurrencyRequired") ?? "Currency is required")" Class="mb-3">
            <MudSelectItem T="string" Value="@("SSP")">@(Lang?.T("Settings_SSP") ?? "SSP - South Sudan Pound")</MudSelectItem>
            <MudSelectItem T="string" Value="@("USD")">@(Lang?.T("Settings_USD") ?? "USD - United States Dollar")</MudSelectItem>
        </MudSelect>
        <div @ref="_purchaseValueRef">
            <MudTextField T="string" Value="@_purchaseValueDisplay" ValueChanged="OnPurchaseValueChanged"
                          Label="@(Lang?.T("AssetDialog_PurchaseValue") ?? "Purchase Value")" Required="true" RequiredError="@(Lang?.T("AssetDialog_PurchaseValueRequired") ?? "Purchase value is required")" Class="mb-3" />
        </div>
        <div @ref="_currentValueRef">
            <MudTextField T="string" Value="@_currentValueDisplay" ValueChanged="OnCurrentValueChanged"
                          Label="@(Lang?.T("AssetDialog_CurrentValue") ?? "Current Value")" Required="true" RequiredError="@(Lang?.T("AssetDialog_CurrentValueRequired") ?? "Current value is required")" Class="mb-3" />
        </div>
        <MudNumericField T="int" @bind-Value="_usefulLifeMonths" Label="@(Lang?.T("AssetDialog_UsefulLife") ?? "Useful Life (months)")"
                         Min="1" Class="mb-3" />
        <MudSelect T="string" @bind-Value="_depreciationMethod" Label="@(Lang?.T("AssetDialog_DepreciationMethod") ?? "Depreciation Method")" Class="mb-3">
            <MudSelectItem T="string" Value="@("StraightLine")">@(Lang?.T("AssetDialog_StraightLine") ?? "Straight Line")</MudSelectItem>
            <MudSelectItem T="string" Value="@("DecliningBalance")">@(Lang?.T("AssetDialog_DecliningBalance") ?? "Declining Balance")</MudSelectItem>
        </MudSelect>
        <MudSelect T="AssetCondition" @bind-Value="_condition" Label="@(Lang?.T("Assets_Condition") ?? "Condition")" Class="mb-3">
            @foreach (AssetCondition cond in Enum.GetValues<AssetCondition>())
            {
                <MudSelectItem T="AssetCondition" Value="@cond">@cond</MudSelectItem>
            }
        </MudSelect>

        @* --- Photos (multiple) --- *@
        <MudText Typo="Typo.subtitle2" Class="mt-2 mb-1">@(Lang?.T("Photos") ?? "Photos")</MudText>
        @if (_existingPhotoPaths.Count > 0 || _newPhotoFiles.Count > 0)
        {
            <div class="d-flex flex-wrap gap-2 mb-2">
                @foreach (var path in _existingPhotoPaths)
                {
                    <MudChip T="string" Color="Color.Default" OnClose="@(() => _existingPhotoPaths.Remove(path))">
                        @Path.GetFileName(path)
                    </MudChip>
                }
                @foreach (var file in _newPhotoFiles)
                {
                    <MudChip T="string" Color="Color.Success" OnClose="@(() => _newPhotoFiles.Remove(file))">
                        @file.Name (@($"{file.Size / 1024.0:F0} KB"))
                    </MudChip>
                }
            </div>
        }
        <MudFileUpload T="IReadOnlyList<IBrowserFile>" Accept=".jpg,.jpeg,.png" FilesChanged="OnPhotosSelected">
            <ActivatorContent>
                <MudButton Variant="Variant.Outlined" Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.PhotoCamera" Class="mb-3">
                    @(Lang?.T("AssetDialog_AddPhotos") ?? "Add Photos")
                </MudButton>
            </ActivatorContent>
        </MudFileUpload>

        @* --- Documents (multiple) --- *@
        <MudText Typo="Typo.subtitle2" Class="mt-2 mb-1">@(Lang?.T("Documents") ?? "Documents")</MudText>
        @if (_existingDocumentPaths.Count > 0 || _newDocumentFiles.Count > 0)
        {
            <div class="d-flex flex-wrap gap-2 mb-2">
                @foreach (var path in _existingDocumentPaths)
                {
                    <MudChip T="string" Color="Color.Default" OnClose="@(() => _existingDocumentPaths.Remove(path))">
                        @Path.GetFileName(path)
                    </MudChip>
                }
                @foreach (var file in _newDocumentFiles)
                {
                    <MudChip T="string" Color="Color.Success" OnClose="@(() => _newDocumentFiles.Remove(file))">
                        @file.Name (@($"{file.Size / 1024.0:F0} KB"))
                    </MudChip>
                }
            </div>
        }
        <MudFileUpload T="IReadOnlyList<IBrowserFile>" Accept=".pdf,.jpg,.jpeg,.png" FilesChanged="OnDocumentsSelected">
            <ActivatorContent>
                <MudButton Variant="Variant.Outlined" Color="Color.Secondary"
                           StartIcon="@Icons.Material.Filled.Description" Class="mb-3">
                    @(Lang?.T("AssetDialog_AddDocuments") ?? "Add Documents")
                </MudButton>
            </ActivatorContent>
        </MudFileUpload>

        <MudTextField @bind-Value="_notes" Label="@(Lang?.T("Notes") ?? "Notes")" Lines="3" Class="mb-3" />
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">@(Lang?.T("Cancel") ?? "Cancel")</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Submit"
                   Disabled="@_saving">@(Lang?.T("Save") ?? "Save")</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = null!;
    [CascadingParameter] public AirtimeDistributionCloud.Application.Services.ILanguageService? Lang { get; set; }
    [Parameter] public AssetDto? Asset { get; set; }
    [Parameter] public List<BranchDto> Branches { get; set; } = new();
    [Parameter] public List<AssetCategoryDto> Categories { get; set; } = new();

    private bool _saving;
    private string _name = string.Empty;
    private int _categoryId;
    private string? _serialNumber;
    private string? _assetTag;
    private int _branchId;
    private DateTime? _purchaseDate;
    private decimal _purchaseValue;
    private string _purchaseValueDisplay = "";
    private decimal _currentValue;
    private string _currentValueDisplay = "";
    private int _usefulLifeMonths = 12;
    private string _depreciationMethod = "StraightLine";
    private AssetCondition _condition = AssetCondition.New;
    private string _currency = "SSP";
    private string? _notes;

    // Multi-file state
    private List<string> _existingPhotoPaths = new();
    private List<IBrowserFile> _newPhotoFiles = new();
    private List<string> _existingDocumentPaths = new();
    private List<IBrowserFile> _newDocumentFiles = new();

    private ElementReference _purchaseValueRef;
    private ElementReference _currentValueRef;

    protected override void OnInitialized()
    {
        if (Asset is not null)
        {
            _name = Asset.Name;
            _categoryId = Asset.AssetCategoryId;
            _serialNumber = Asset.SerialNumber;
            _assetTag = Asset.AssetTag;
            _branchId = Asset.BranchId;
            _purchaseDate = Asset.PurchaseDate;
            _currency = Asset.Currency;
            _purchaseValue = Asset.PurchaseValue;
            _purchaseValueDisplay = Asset.PurchaseValue > 0 ? FormatNumber(Asset.PurchaseValue.ToString("F2")) : "";
            _currentValue = Asset.CurrentValue;
            _currentValueDisplay = Asset.CurrentValue > 0 ? FormatNumber(Asset.CurrentValue.ToString("F2")) : "";
            _usefulLifeMonths = Asset.UsefulLifeMonths;
            _depreciationMethod = Asset.DepreciationMethod;
            _condition = Asset.Condition;
            _notes = Asset.Notes;

            if (!string.IsNullOrEmpty(Asset.PhotoPath))
                _existingPhotoPaths = Asset.PhotoPath.Split(';', StringSplitOptions.RemoveEmptyEntries).ToList();
            if (!string.IsNullOrEmpty(Asset.DocumentPath))
                _existingDocumentPaths = Asset.DocumentPath.Split(';', StringSplitOptions.RemoveEmptyEntries).ToList();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("initNumericFormat", _purchaseValueRef);
            await JS.InvokeVoidAsync("initNumericFormat", _currentValueRef);
        }
    }

    private void OnPurchaseValueChanged(string value)
    {
        _purchaseValueDisplay = FormatNumber(value);
        _purchaseValue = ParseNumber(value);
    }

    private void OnCurrentValueChanged(string value)
    {
        _currentValueDisplay = FormatNumber(value);
        _currentValue = ParseNumber(value);
    }

    private void OnPhotosSelected(IReadOnlyList<IBrowserFile> files)
    {
        foreach (var f in files)
            _newPhotoFiles.Add(f);
    }

    private void OnDocumentsSelected(IReadOnlyList<IBrowserFile> files)
    {
        foreach (var f in files)
            _newDocumentFiles.Add(f);
    }

    private async Task Submit()
    {
        var rawPurchase = await JS.InvokeAsync<string>("getNumericInputValue", _purchaseValueRef);
        _purchaseValue = ParseNumber(rawPurchase);

        var rawCurrent = await JS.InvokeAsync<string>("getNumericInputValue", _currentValueRef);
        _currentValue = ParseNumber(rawCurrent);

        if (string.IsNullOrWhiteSpace(_name) || _categoryId == 0 || _branchId == 0 || _purchaseValue <= 0)
        {
            Snackbar.Add(Lang?.T("FillRequiredFields") ?? "Please fill in all required fields", Severity.Warning);
            return;
        }

        _saving = true;
        try
        {
            // Upload new photos
            var allPhotoPaths = new List<string>(_existingPhotoPaths);
            foreach (var file in _newPhotoFiles)
            {
                var path = await UploadFile(file, "uploads/assets", 5 * 1024 * 1024);
                allPhotoPaths.Add(path);
            }

            // Upload new documents
            var allDocumentPaths = new List<string>(_existingDocumentPaths);
            foreach (var file in _newDocumentFiles)
            {
                var path = await UploadFile(file, "uploads/assets/docs", 10 * 1024 * 1024);
                allDocumentPaths.Add(path);
            }

            var photoPath = allPhotoPaths.Count > 0 ? string.Join(";", allPhotoPaths) : null;
            var documentPath = allDocumentPaths.Count > 0 ? string.Join(";", allDocumentPaths) : null;

            if (Asset is not null)
            {
                await AssetService.UpdateAssetAsync(new UpdateAssetRequest(
                    Asset.Id, _name, _categoryId, _serialNumber, _assetTag,
                    _branchId, Asset.AssignedToUserId,
                    _purchaseDate, _currency, _purchaseValue, _currentValue,
                    _usefulLifeMonths, _depreciationMethod,
                    _condition, photoPath, documentPath, _notes));
                Snackbar.Add(Lang?.T("AssetDialog_Updated") ?? "Asset updated successfully", Severity.Success);
            }
            else
            {
                await AssetService.CreateAssetAsync(new CreateAssetRequest(
                    _name, _categoryId, _serialNumber, _assetTag,
                    _branchId, null,
                    _purchaseDate, _currency, _purchaseValue, _currentValue,
                    _usefulLifeMonths, _depreciationMethod,
                    _condition, photoPath, documentPath, _notes),
                    CurrentUser.UserId ?? "");
                Snackbar.Add(Lang?.T("AssetDialog_Created") ?? "Asset created successfully", Severity.Success);
            }

            MudDialog.Close(DialogResult.Ok(true));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"{Lang?.T("Error") ?? "Error"}: {ex.Message}", Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task<string> UploadFile(IBrowserFile file, string subFolder, long maxSize)
    {
        var uploadsDir = Path.Combine(Env.WebRootPath, subFolder);
        Directory.CreateDirectory(uploadsDir);
        var ext = Path.GetExtension(file.Name);
        var fileName = $"{Guid.NewGuid()}{ext}";
        var filePath = Path.Combine(uploadsDir, fileName);
        await using var stream = new FileStream(filePath, FileMode.Create);
        await file.OpenReadStream(maxSize).CopyToAsync(stream);
        return $"/{subFolder}/{fileName}";
    }

    private void Cancel() => MudDialog.Cancel();

    private static string FormatNumber(string input)
    {
        if (string.IsNullOrEmpty(input)) return "";
        var clean = "";
        var hasDecimal = false;
        foreach (var c in input)
        {
            if (char.IsDigit(c)) clean += c;
            else if (c == '.' && !hasDecimal) { clean += c; hasDecimal = true; }
        }
        if (string.IsNullOrEmpty(clean)) return "";
        var parts = clean.Split('.');
        if (long.TryParse(parts[0], out var intPart))
            parts[0] = intPart.ToString("N0", System.Globalization.CultureInfo.GetCultureInfo("en-US"));
        return parts.Length > 1 ? $"{parts[0]}.{parts[1]}" : parts[0];
    }

    private static decimal ParseNumber(string formatted)
    {
        var clean = new string(formatted.Where(c => char.IsDigit(c) || c == '.').ToArray());
        return decimal.TryParse(clean, System.Globalization.NumberStyles.Any,
            System.Globalization.CultureInfo.InvariantCulture, out var val) ? val : 0;
    }
}
