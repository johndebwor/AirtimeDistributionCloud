@rendermode InteractiveServer
@using AirtimeDistributionCloud.Application.DTOs
@using AirtimeDistributionCloud.Application.Services
@using AirtimeDistributionCloud.Core.Interfaces
@inject IAssetService AssetService
@inject ICurrentUserService CurrentUser
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudSelect T="string" @bind-Value="_assignmentType" Label="@(Lang?.T("Type") ?? "Assignment Type")" Required="true"
                   RequiredError="@(Lang?.T("AssetAssign_TypeRequired") ?? "Type is required")" Class="mb-3">
            <MudSelectItem T="string" Value="@("Individual")">@(Lang?.T("AssetAssign_Individual") ?? "Individual")</MudSelectItem>
            <MudSelectItem T="string" Value="@("Branch")">@(Lang?.T("Branch") ?? "Branch")</MudSelectItem>
            <MudSelectItem T="string" Value="@("Department")">@(Lang?.T("AssetAssign_Department") ?? "Department")</MudSelectItem>
            <MudSelectItem T="string" Value="@("Office")">@(Lang?.T("AssetDetail_Office") ?? "Office")</MudSelectItem>
        </MudSelect>

        @if (_assignmentType == "Individual")
        {
            <MudTextField @bind-Value="_contactName" Label="@(Lang?.T("FullName") ?? "Full Name")" Required="true"
                          RequiredError="@(Lang?.T("NameRequired") ?? "Name is required")" Class="mb-3" />
            <MudTextField @bind-Value="_contactPhone" Label="@(Lang?.T("PhoneNumber") ?? "Phone Number")" Required="true"
                          RequiredError="@(Lang?.T("AssetAssign_PhoneRequired") ?? "Phone is required")" Class="mb-3" />
        }
        else if (_assignmentType == "Branch")
        {
            <MudSelect T="int" @bind-Value="_branchId" Label="@(Lang?.T("Branch") ?? "Branch")" Required="true"
                       RequiredError="@(Lang?.T("BranchRequired") ?? "Branch is required")" Placeholder="@(Lang?.T("SelectBranch") ?? "-- Select Branch --")" Class="mb-3">
                @foreach (var b in Branches)
                {
                    <MudSelectItem T="int" Value="@b.Id">@b.Name</MudSelectItem>
                }
            </MudSelect>
            <MudTextField @bind-Value="_location" Label="@(Lang?.T("Location") ?? "Location")" Class="mb-3" />
            <MudTextField @bind-Value="_contactName" Label="@(Lang?.T("AssetAssign_ReceivedByName") ?? "Received By (Name)")" Required="true"
                          RequiredError="@(Lang?.T("AssetAssign_ReceivedByRequired") ?? "Received by name is required")" Class="mb-3" />
            <MudTextField @bind-Value="_contactPhone" Label="@(Lang?.T("AssetAssign_ReceivedByPhone") ?? "Received By (Phone)")" Class="mb-3" />
        }
        else if (_assignmentType == "Department")
        {
            <MudTextField @bind-Value="_departmentName" Label="@(Lang?.T("AssetAssign_DeptName") ?? "Department Name")" Required="true"
                          RequiredError="@(Lang?.T("AssetAssign_DeptRequired") ?? "Department name is required")" Class="mb-3" />
            <MudSelect T="int" @bind-Value="_branchId" Label="@(Lang?.T("Branch") ?? "Branch")" Required="true"
                       RequiredError="@(Lang?.T("BranchRequired") ?? "Branch is required")" Placeholder="@(Lang?.T("SelectBranch") ?? "-- Select Branch --")" Class="mb-3">
                @foreach (var b in Branches)
                {
                    <MudSelectItem T="int" Value="@b.Id">@b.Name</MudSelectItem>
                }
            </MudSelect>
            <MudTextField @bind-Value="_contactName" Label="@(Lang?.T("AssetAssign_ReceivedByName") ?? "Received By (Name)")" Required="true"
                          RequiredError="@(Lang?.T("AssetAssign_ReceivedByRequired") ?? "Received by name is required")" Class="mb-3" />
            <MudTextField @bind-Value="_contactPhone" Label="@(Lang?.T("AssetAssign_ReceivedByPhone") ?? "Received By (Phone)")" Class="mb-3" />
        }
        else if (_assignmentType == "Office")
        {
            <MudTextField @bind-Value="_officeName" Label="@(Lang?.T("AssetAssign_OfficeName") ?? "Office Name")" Required="true"
                          RequiredError="@(Lang?.T("AssetAssign_OfficeRequired") ?? "Office name is required")" Class="mb-3" />
            <MudSelect T="int" @bind-Value="_branchId" Label="@(Lang?.T("Branch") ?? "Branch")" Required="true"
                       RequiredError="@(Lang?.T("BranchRequired") ?? "Branch is required")" Placeholder="@(Lang?.T("SelectBranch") ?? "-- Select Branch --")" Class="mb-3">
                @foreach (var b in Branches)
                {
                    <MudSelectItem T="int" Value="@b.Id">@b.Name</MudSelectItem>
                }
            </MudSelect>
            <MudTextField @bind-Value="_departmentName" Label="@(Lang?.T("AssetAssign_DeptOptional") ?? "Department (Optional)")" Class="mb-3" />
            <MudTextField @bind-Value="_contactName" Label="@(Lang?.T("AssetAssign_ReceivedByName") ?? "Received By (Name)")" Required="true"
                          RequiredError="@(Lang?.T("AssetAssign_ReceivedByRequired") ?? "Received by name is required")" Class="mb-3" />
            <MudTextField @bind-Value="_contactPhone" Label="@(Lang?.T("AssetAssign_ReceivedByPhone") ?? "Received By (Phone)")" Class="mb-3" />
        }

        <MudTextField @bind-Value="_notes" Label="@(Lang?.T("Notes") ?? "Notes")" Lines="3" Class="mb-3" />
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">@(Lang?.T("Cancel") ?? "Cancel")</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Submit"
                   Disabled="@_saving">@(Lang?.T("Assign") ?? "Assign")</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = null!;
    [CascadingParameter] public AirtimeDistributionCloud.Application.Services.ILanguageService? Lang { get; set; }
    [Parameter] public int AssetId { get; set; }
    [Parameter] public List<BranchDto> Branches { get; set; } = new();

    private bool _saving;
    private string _assignmentType = "Branch";
    private int _branchId;
    private string? _contactName;
    private string? _contactPhone;
    private string? _departmentName;
    private string? _officeName;
    private string? _location;
    private string? _notes;

    private async Task Submit()
    {
        if (!Validate())
            return;

        _saving = true;
        try
        {
            await AssetService.AssignAssetAsync(
                new CreateAssetAssignmentRequest(
                    AssetId, _assignmentType,
                    _assignmentType != "Individual" ? _branchId : null,
                    null,
                    _contactName, _contactPhone,
                    _departmentName, _officeName, _location,
                    _notes),
                CurrentUser.UserId ?? "");
            Snackbar.Add(Lang?.T("AssetAssign_Assigned") ?? "Asset assigned successfully", Severity.Success);
            MudDialog.Close(DialogResult.Ok(true));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"{Lang?.T("Error") ?? "Error"}: {ex.Message}", Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    private bool Validate()
    {
        if (string.IsNullOrWhiteSpace(_assignmentType))
        {
            Snackbar.Add(Lang?.T("AssetAssign_SelectType") ?? "Please select an assignment type", Severity.Warning);
            return false;
        }

        if (_assignmentType == "Individual")
        {
            if (string.IsNullOrWhiteSpace(_contactName))
            {
                Snackbar.Add(Lang?.T("AssetAssign_EnterName") ?? "Please enter the individual's name", Severity.Warning);
                return false;
            }
            if (string.IsNullOrWhiteSpace(_contactPhone))
            {
                Snackbar.Add(Lang?.T("AssetAssign_EnterPhone") ?? "Please enter the individual's phone number", Severity.Warning);
                return false;
            }
        }
        else
        {
            if (_branchId == 0)
            {
                Snackbar.Add(Lang?.T("AssetAssign_SelectBranch") ?? "Please select a branch", Severity.Warning);
                return false;
            }
            if (string.IsNullOrWhiteSpace(_contactName))
            {
                Snackbar.Add(Lang?.T("AssetAssign_EnterReceivedBy") ?? "Please enter the received by name", Severity.Warning);
                return false;
            }
        }

        if (_assignmentType == "Department" && string.IsNullOrWhiteSpace(_departmentName))
        {
            Snackbar.Add(Lang?.T("AssetAssign_EnterDeptName") ?? "Please enter the department name", Severity.Warning);
            return false;
        }

        if (_assignmentType == "Office" && string.IsNullOrWhiteSpace(_officeName))
        {
            Snackbar.Add(Lang?.T("AssetAssign_EnterOfficeName") ?? "Please enter the office name", Severity.Warning);
            return false;
        }

        return true;
    }

    private void Cancel() => MudDialog.Cancel();
}
