@page "/admin/reports"
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@rendermode InteractiveServer
@using AirtimeDistributionCloud.Application.DTOs
@using AirtimeDistributionCloud.Application.Services
@using AirtimeDistributionCloud.Core.Entities
@using AirtimeDistributionCloud.Core.Enums
@using AirtimeDistributionCloud.Core.Interfaces
@using QuestPDF.Fluent
@inject IProductService ProductService
@inject IDealerService DealerService
@inject IAirtimeTransferService TransferService
@inject ICashDepositService CashDepositService
@inject IAirtimeDepositService DepositService
@inject IExpenseService ExpenseService
@inject ISystemSettingRepository SettingsRepo
@inject IJSRuntime JS
@inject ISnackbar Snackbar
@inject IWebHostEnvironment WebHostEnv
@using Microsoft.AspNetCore.Hosting

<PageTitle>@(Lang?.T("Reports_Title") ?? "Reports") - RasidBase</PageTitle>

<div class="page-header">
    <h1>@(Lang?.T("Reports_Title") ?? "Reports")</h1>
    <p>@(Lang?.T("Reports_Subtitle") ?? "Generate and download reports in PDF or Excel format")</p>
</div>

<MudGrid Spacing="4">
    <!-- Filters -->
    <MudItem xs="12">
        <MudPaper Elevation="0" Class="data-card pa-4">
            <MudGrid>
                <MudItem xs="12" sm="4">
                    <MudSelect T="string" @bind-Value="_selectedReport" Label="@(Lang?.T("Reports_ReportType") ?? "Report Type")" Variant="Variant.Outlined"
                               Placeholder="@(Lang?.T("Reports_SelectReport") ?? "-- Select Report --")">
                        <MudSelectItem T="string" Value="@("transfers")">@(Lang?.T("Reports_AirtimeTransfers") ?? "Airtime Transfers")</MudSelectItem>
                        <MudSelectItem T="string" Value="@("cash-deposits")">@(Lang?.T("Reports_CashDeposits") ?? "Cash Deposits")</MudSelectItem>
                        <MudSelectItem T="string" Value="@("airtime-deposits")">@(Lang?.T("Reports_AirtimeDeposits") ?? "Airtime Deposits")</MudSelectItem>
                        <MudSelectItem T="string" Value="@("expenses")">@(Lang?.T("Reports_Expenses") ?? "Expenses")</MudSelectItem>
                        <MudSelectItem T="string" Value="@("dealers")">@(Lang?.T("Reports_Dealers") ?? "Dealers")</MudSelectItem>
                    </MudSelect>
                    @if (!string.IsNullOrEmpty(_selectedReport) && ReportDescriptions.TryGetValue(_selectedReport, out var descKey))
                    {
                        <MudAlert Severity="Severity.Info" Variant="Variant.Text" Dense="true" Class="mt-2" NoIcon="false"
                                  Style="font-size:0.8rem; padding:6px 12px;">
                            @(Lang?.T(descKey) ?? GetDefaultDescription(_selectedReport))
                        </MudAlert>
                    }
                </MudItem>
                <MudItem xs="12" sm="3">
                    <MudDatePicker @bind-Date="_dateFrom" Label="@(Lang?.T("Reports_FromDate") ?? "From Date")" Variant="Variant.Outlined" Clearable="true" />
                </MudItem>
                <MudItem xs="12" sm="3">
                    <MudDatePicker @bind-Date="_dateTo" Label="@(Lang?.T("Reports_ToDate") ?? "To Date")" Variant="Variant.Outlined" Clearable="true" />
                </MudItem>
                <MudItem xs="12" sm="2" Class="d-flex align-end gap-2 flex-wrap">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small"
                               StartIcon="@Icons.Material.Filled.Visibility"
                               OnClick="PreviewReport" Disabled="@(_generating || string.IsNullOrEmpty(_selectedReport))">
                        @(Lang?.T("Reports_View") ?? "View")
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Error" Size="Size.Small"
                               StartIcon="@Icons.Material.Filled.PictureAsPdf"
                               OnClick="@(() => GenerateReport("pdf"))" Disabled="@(_generating || string.IsNullOrEmpty(_selectedReport))">
                        @(Lang?.T("Reports_PDF") ?? "PDF")
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Success" Size="Size.Small"
                               StartIcon="@Icons.Material.Filled.TableChart"
                               OnClick="@(() => GenerateReport("excel"))" Disabled="@(_generating || string.IsNullOrEmpty(_selectedReport))">
                        @(Lang?.T("Reports_Excel") ?? "Excel")
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudPaper>
    </MudItem>

    @if (_generating)
    {
        <MudItem xs="12">
            <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
        </MudItem>
    }

    <!-- Inline Report Preview -->
    @if (_showPreview)
    {
        <MudItem xs="12">
            <MudPaper Elevation="0" Class="data-card pa-4">
                <div class="d-flex align-center justify-space-between mb-3">
                    <div class="d-flex align-center gap-2">
                        <MudIcon Icon="@Icons.Material.Outlined.TableView" Color="Color.Primary" />
                        <MudText Typo="Typo.h6" Style="font-weight:600;">@_previewTitle</MudText>
                        <MudChip T="string" Color="Color.Primary" Size="Size.Small" Variant="Variant.Outlined">
                            @_previewRows.Count @(Lang?.T("Reports_Records") ?? "records")
                        </MudChip>
                    </div>
                    <MudIconButton Icon="@Icons.Material.Filled.Close" Size="Size.Small"
                                   OnClick="@(() => _showPreview = false)" />
                </div>

                @if (_previewRows.Count == 0)
                {
                    <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Class="mb-3">
                        @(Lang?.T("Reports_NoData") ?? "No records found for the selected criteria.")
                    </MudAlert>
                }
                else
                {
                    <MudTable Items="_previewRows" Dense="true" Hover="true" Striped="true" Elevation="0"
                              RowsPerPage="10" Style="border-radius: 8px;">
                        <HeaderContent>
                            @foreach (var header in _previewHeaders)
                            {
                                <MudTh Style="font-weight:600;">@header</MudTh>
                            }
                        </HeaderContent>
                        <RowTemplate>
                            @foreach (var cell in context)
                            {
                                <MudTd>@cell</MudTd>
                            }
                        </RowTemplate>
                        <PagerContent>
                            <MudTablePager PageSizeOptions="new int[] { 10, 25, 50, 100 }" />
                        </PagerContent>
                    </MudTable>
                }
            </MudPaper>
        </MudItem>
    }


</MudGrid>

@code {
    [CascadingParameter] public AirtimeDistributionCloud.Application.Services.ILanguageService? Lang { get; set; }

    private string _selectedReport = "";
    private DateTime? _dateFrom;
    private DateTime? _dateTo;
    private bool _generating;

    // Preview state
    private bool _showPreview;
    private string _previewTitle = "";
    private string[] _previewHeaders = [];
    private List<string[]> _previewRows = new();

    private string _companyName = "";
    private string _companyNameAr = "";
    private string _companyAddress = "";
    private string _companyAddressAr = "";
    private string _companyTel = "";
    private string _logoPath = "";

    private bool IsRtl => Lang?.IsRtl == true;

    private string CompanyName => IsRtl && !string.IsNullOrEmpty(_companyNameAr) ? _companyNameAr : _companyName;
    private string CompanyAddress => IsRtl && !string.IsNullOrEmpty(_companyAddressAr) ? _companyAddressAr : _companyAddress;

    private static readonly Dictionary<string, string> ReportDescriptions = new()
    {
        ["transfers"] = "Reports_TransfersDescFull",
        ["cash-deposits"] = "Reports_CashDepositsDescFull",
        ["airtime-deposits"] = "Reports_DepositsDescFull",
        ["expenses"] = "Reports_ExpensesDescFull",
        ["dealers"] = "Reports_DealersDescFull"
    };

    private static string GetDefaultDescription(string report) => report switch
    {
        "transfers" => "View all airtime transfer records including dealer, product, branch, amount, commission, transfer type, and approval status.",
        "cash-deposits" => "View cash deposit records from dealers organized by branch with deposit amounts and dates.",
        "airtime-deposits" => "View airtime deposit records with bonus percentage calculations and approval status.",
        "expenses" => "View expense records with categories, descriptions, amounts, and approval status.",
        "dealers" => "View the complete list of registered dealers with contact details, location, and status.",
        _ => ""
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;
        var nameSetting = await SettingsRepo.GetByKeyAsync("CompanyName");
        _companyName = nameSetting?.Value ?? "Airtime Distribution";
        var nameArSetting = await SettingsRepo.GetByKeyAsync("CompanyNameAr");
        _companyNameAr = nameArSetting?.Value ?? "";
        var addrSetting = await SettingsRepo.GetByKeyAsync("CompanyAddress");
        _companyAddress = addrSetting?.Value ?? "";
        var addrArSetting = await SettingsRepo.GetByKeyAsync("CompanyAddressAr");
        _companyAddressAr = addrArSetting?.Value ?? "";
        var telSetting = await SettingsRepo.GetByKeyAsync("CompanyTel1");
        _companyTel = telSetting?.Value ?? "";
        var logoSetting = await SettingsRepo.GetByKeyAsync("CompanyLogoPath");
        _logoPath = logoSetting?.Value ?? "";
        StateHasChanged();
    }

    private string T(string key) => Lang?.T(key) ?? key;

    private string TranslateTransferType(string type) => type switch
    {
        "Airtime" => T("TransferType_Airtime"),
        "Cash" => T("TransferType_Cash"),
        "Loan" => T("TransferType_Loan"),
        _ => type
    };

    private string TranslateStatus(string status) => status switch
    {
        "Pending" => T("Pending"),
        "Approved" => T("Approved"),
        "Rejected" => T("Rejected"),
        "Cancelled" => T("Cancelled"),
        _ => status
    };

    private string TranslateDealerType(string type) => type switch
    {
        "Person" => T("DealerType_Person"),
        "Company" => T("DealerType_Company"),
        _ => type
    };

    private async Task PreviewReport()
    {
        _generating = true;
        StateHasChanged();
        try
        {
            _previewHeaders = GetHeaders();
            _previewRows = await GetRows();
            _previewTitle = _selectedReport switch
            {
                "transfers" => T("Reports_AirtimeTransfers"),
                "cash-deposits" => T("Reports_CashDeposits"),
                "airtime-deposits" => T("Reports_AirtimeDeposits"),
                "expenses" => T("Reports_Expenses"),
                "dealers" => T("Reports_Dealers"),
                _ => T("Report_Suffix")
            };
            _showPreview = true;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"{T("Error")}: {ex.Message}", Severity.Error);
        }
        finally
        {
            _generating = false;
        }
    }

    private async Task GenerateReport(string format)
    {
        _generating = true;
        StateHasChanged();
        try
        {
            byte[] fileBytes;
            string fileName;
            string mimeType;
            var reportTitle = _selectedReport switch
            {
                "transfers" => T("Reports_AirtimeTransfers"),
                "cash-deposits" => T("Reports_CashDeposits"),
                "airtime-deposits" => T("Reports_AirtimeDeposits"),
                "expenses" => T("Reports_Expenses"),
                "dealers" => T("Reports_Dealers"),
                _ => T("Report_Suffix")
            };

            var headers = GetHeaders();
            var rows = await GetRows();

            if (format == "excel")
            {
                fileBytes = GenerateExcel(reportTitle, headers, rows);
                fileName = $"{_selectedReport}-{DateTime.Now:yyyyMMdd}.xlsx";
                mimeType = "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";
            }
            else
            {
                fileBytes = GeneratePdf(reportTitle, headers, rows);
                fileName = $"{_selectedReport}-{DateTime.Now:yyyyMMdd}.pdf";
                mimeType = "application/pdf";
            }

            var base64 = Convert.ToBase64String(fileBytes);
            await JS.InvokeVoidAsync("eval", $@"
                var link = document.createElement('a');
                link.href = 'data:{mimeType};base64,{base64}';
                link.download = '{fileName}';
                link.click();
            ");
            Snackbar.Add($"{reportTitle} {T("Reports_Downloaded")}", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"{T("Error")}: {ex.Message}", Severity.Error);
        }
        finally
        {
            _generating = false;
        }
    }

    private string[] GetHeaders() => _selectedReport switch
    {
        "transfers" => [T("Rpt_No"), T("Rpt_Date"), T("Rpt_Dealer"), T("Rpt_Product"), T("Rpt_Branch"),
                        T("Rpt_Amount"), T("Rpt_Commission"), T("Rpt_LoanAmount"), T("Rpt_Type"), T("Rpt_Status")],
        "cash-deposits" => [T("Rpt_No"), T("Rpt_Date"), T("Rpt_Dealer"), T("Rpt_Branch"), T("Rpt_Amount")],
        "airtime-deposits" => [T("Rpt_No"), T("Rpt_Date"), T("Rpt_Product"), T("Rpt_Amount"),
                               T("Rpt_BonusPercent"), T("Rpt_Bonus"), T("Rpt_Total"), T("Rpt_Status")],
        "expenses" => [T("Rpt_No"), T("Rpt_Date"), T("Rpt_Branch"), T("Rpt_Category"),
                       T("Rpt_Description"), T("Rpt_Amount"), T("Rpt_Status")],
        "dealers" => [T("Rpt_No"), T("Rpt_DealerNo"), T("Rpt_Name"), T("Rpt_Type"),
                      T("Rpt_Phone"), T("Rpt_State"), T("Rpt_County"), T("Rpt_Status")],
        _ => []
    };

    private async Task<List<string[]>> GetRows()
    {
        var rows = new List<string[]>();
        switch (_selectedReport)
        {
            case "transfers":
                var transfers = await TransferService.GetAllTransfersAsync();
                var filteredTransfers = FilterByDate(transfers, t => t.CreatedDate);
                int ti = 0;
                foreach (var t in filteredTransfers)
                    rows.Add([(++ti).ToString(), t.CreatedDate.ToString("dd/MM/yyyy"), t.DealerName, t.ProductName, t.BranchName,
                        t.Amount.ToString("N2"), t.CommissionAmount.ToString("N2"), t.LoanAmount.ToString("N2"),
                        TranslateTransferType(t.TransferType.ToString()), TranslateStatus(t.Status.ToString())]);
                break;

            case "cash-deposits":
                var cashDeps = await CashDepositService.GetAllDepositsAsync();
                var filteredCash = FilterByDate(cashDeps, d => d.DepositDate);
                int ci = 0;
                foreach (var d in filteredCash)
                    rows.Add([(++ci).ToString(), d.DepositDate.ToString("dd/MM/yyyy"), d.DealerName, d.BranchName, d.Amount.ToString("N2")]);
                break;

            case "airtime-deposits":
                var airDeps = await DepositService.GetAllDepositsAsync();
                var filteredAir = FilterByDate(airDeps, d => d.CreatedDate);
                int ai = 0;
                foreach (var d in filteredAir)
                    rows.Add([(++ai).ToString(), d.CreatedDate.ToString("dd/MM/yyyy"), d.ProductName, d.Amount.ToString("N2"),
                        d.BonusPercentage.ToString("N2"), d.BonusAmount.ToString("N2"), d.TotalAmount.ToString("N2"),
                        TranslateStatus(d.Status.ToString())]);
                break;

            case "expenses":
                var expenses = await ExpenseService.GetAllExpensesAsync();
                var filteredExp = FilterByDate(expenses, e => e.ExpenseDate);
                int ei = 0;
                foreach (var e in filteredExp)
                    rows.Add([(++ei).ToString(), e.ExpenseDate.ToString("dd/MM/yyyy"), e.BranchName, e.CategoryName,
                        e.Description, e.Amount.ToString("N2"), TranslateStatus(e.Status.ToString())]);
                break;

            case "dealers":
                var dealers = await DealerService.GetAllDealersAsync();
                int di = 0;
                foreach (var d in dealers)
                    rows.Add([(++di).ToString(), d.DealerNumber, d.Name, TranslateDealerType(d.Type.ToString()),
                        d.PhoneNumber ?? "", d.State ?? "", d.County ?? "",
                        d.IsActive ? T("Active") : T("Inactive")]);
                break;
        }
        return rows;
    }

    private IEnumerable<TItem> FilterByDate<TItem>(IEnumerable<TItem> items, Func<TItem, DateTime> dateSelector)
    {
        if (_dateFrom.HasValue)
            items = items.Where(i => dateSelector(i).Date >= _dateFrom.Value.Date);
        if (_dateTo.HasValue)
            items = items.Where(i => dateSelector(i).Date <= _dateTo.Value.Date);
        return items;
    }

    private string GetDateRangeText()
    {
        if (_dateFrom.HasValue || _dateTo.HasValue)
            return $"{T("Report_Period")}: {_dateFrom?.ToString("dd/MM/yyyy") ?? T("Report_Start")} - {_dateTo?.ToString("dd/MM/yyyy") ?? T("Report_Present")}";
        return $"{T("Report_Generated")}: {DateTime.Now:dd/MM/yyyy HH:mm}";
    }

    private byte[] GenerateExcel(string title, string[] headers, List<string[]> rows)
    {
        using var workbook = new ClosedXML.Excel.XLWorkbook();
        var ws = workbook.Worksheets.Add(title.Length > 31 ? title[..31] : title);

        if (IsRtl)
            ws.RightToLeft = true;

        int logoCol = 1;
        int textCol = 2;
        int lastCol = headers.Length + 1;

        ws.Column(logoCol).Width = 9;

        if (!string.IsNullOrEmpty(_logoPath))
        {
            var physicalPath = Path.Combine(WebHostEnv.WebRootPath, _logoPath.TrimStart('/'));
            if (File.Exists(physicalPath))
            {
                var picture = ws.AddPicture(physicalPath).MoveTo(ws.Cell(1, logoCol), 4, 4);
                picture.WithSize(52, 52);
            }
        }

        ws.Row(1).Height = 22;
        ws.Cell(1, textCol).Value = string.IsNullOrEmpty(CompanyName) ? "RasidBase" : CompanyName;
        ws.Cell(1, textCol).Style.Font.Bold = true;
        ws.Cell(1, textCol).Style.Font.FontSize = 14;
        ws.Cell(1, textCol).Style.Font.FontColor = ClosedXML.Excel.XLColor.FromHtml("#1E3A5F");
        ws.Cell(1, textCol).Style.Alignment.Vertical = ClosedXML.Excel.XLAlignmentVerticalValues.Center;
        ws.Range(1, textCol, 1, lastCol).Merge();

        if (!string.IsNullOrEmpty(CompanyAddress))
        {
            ws.Cell(2, textCol).Value = CompanyAddress;
            ws.Cell(2, textCol).Style.Font.FontSize = 9;
            ws.Cell(2, textCol).Style.Font.FontColor = ClosedXML.Excel.XLColor.FromHtml("#64748B");
            ws.Range(2, textCol, 2, lastCol).Merge();
        }

        if (!string.IsNullOrEmpty(_companyTel))
        {
            ws.Cell(3, textCol).Value = $"{T("Report_Tel")}: {_companyTel}";
            ws.Cell(3, textCol).Style.Font.FontSize = 9;
            ws.Cell(3, textCol).Style.Font.FontColor = ClosedXML.Excel.XLColor.FromHtml("#64748B");
            ws.Range(3, textCol, 3, lastCol).Merge();
        }

        ws.Row(4).Height = 5;

        ws.Cell(5, textCol).Value = title;
        ws.Cell(5, textCol).Style.Font.Bold = true;
        ws.Cell(5, textCol).Style.Font.FontSize = 12;
        ws.Cell(5, textCol).Style.Font.FontColor = ClosedXML.Excel.XLColor.FromHtml("#1E3A5F");
        ws.Range(5, textCol, 5, lastCol).Merge();

        ws.Cell(6, textCol).Value = GetDateRangeText();
        ws.Cell(6, textCol).Style.Font.FontSize = 9;
        ws.Cell(6, textCol).Style.Font.FontColor = ClosedXML.Excel.XLColor.FromHtml("#94A3B8");
        ws.Range(6, textCol, 6, lastCol).Merge();

        ws.Row(7).Height = 5;

        int headerRow = 8;
        for (int c = 0; c < headers.Length; c++)
        {
            var cell = ws.Cell(headerRow, c + 1);
            cell.Value = headers[c];
            cell.Style.Font.Bold = true;
            cell.Style.Font.FontSize = 10;
            cell.Style.Fill.BackgroundColor = ClosedXML.Excel.XLColor.FromHtml("#1E3A5F");
            cell.Style.Font.FontColor = ClosedXML.Excel.XLColor.White;
            cell.Style.Alignment.Horizontal = ClosedXML.Excel.XLAlignmentHorizontalValues.Center;
            cell.Style.Border.BottomBorder = ClosedXML.Excel.XLBorderStyleValues.Thin;
            cell.Style.Border.BottomBorderColor = ClosedXML.Excel.XLColor.FromHtml("#1E3A5F");
        }
        ws.Row(headerRow).Height = 22;

        for (int r = 0; r < rows.Count; r++)
        {
            for (int c = 0; c < rows[r].Length; c++)
            {
                var cell = ws.Cell(headerRow + 1 + r, c + 1);
                if (decimal.TryParse(rows[r][c], System.Globalization.NumberStyles.Any,
                    System.Globalization.CultureInfo.InvariantCulture, out var numVal) && c > 0)
                {
                    cell.Value = numVal;
                    cell.Style.NumberFormat.Format = "#,##0.00";
                }
                else
                    cell.Value = rows[r][c];

                cell.Style.Font.FontSize = 10;
                cell.Style.Alignment.Horizontal = ClosedXML.Excel.XLAlignmentHorizontalValues.Center;
                cell.Style.Border.BottomBorder = ClosedXML.Excel.XLBorderStyleValues.Hair;
                cell.Style.Border.BottomBorderColor = ClosedXML.Excel.XLColor.FromHtml("#E2E8F0");

                if (r % 2 == 1)
                    cell.Style.Fill.BackgroundColor = ClosedXML.Excel.XLColor.FromHtml("#F1F5F9");
            }
        }

        if (rows.Count > 0)
        {
            int summaryRow = headerRow + 1 + rows.Count + 1;
            ws.Cell(summaryRow, 1).Value = $"{T("Rpt_Total")}: {rows.Count}";
            ws.Cell(summaryRow, 1).Style.Font.Bold = true;
            ws.Cell(summaryRow, 1).Style.Font.FontSize = 10;
            ws.Cell(summaryRow, 1).Style.Font.FontColor = ClosedXML.Excel.XLColor.FromHtml("#1E3A5F");
        }

        ws.Columns().AdjustToContents();
        for (int c = 1; c <= headers.Length; c++)
        {
            if (ws.Column(c).Width < 10)
                ws.Column(c).Width = 10;
        }

        using var ms = new MemoryStream();
        workbook.SaveAs(ms);
        return ms.ToArray();
    }

    private byte[] GeneratePdf(string title, string[] headers, List<string[]> rows)
    {
        QuestPDF.Settings.License = QuestPDF.Infrastructure.LicenseType.Community;

        var fontsPath = Path.Combine(WebHostEnv.WebRootPath, "fonts");
        var arabicRegularPath = Path.Combine(fontsPath, "NotoSansArabic-Regular.ttf");
        var arabicBoldPath = Path.Combine(fontsPath, "NotoSansArabic-Bold.ttf");
        if (File.Exists(arabicRegularPath))
        {
            using var regularStream = File.OpenRead(arabicRegularPath);
            QuestPDF.Drawing.FontManager.RegisterFont(regularStream);
        }
        if (File.Exists(arabicBoldPath))
        {
            using var boldStream = File.OpenRead(arabicBoldPath);
            QuestPDF.Drawing.FontManager.RegisterFont(boldStream);
        }

        byte[]? logoBytes = null;
        if (!string.IsNullOrEmpty(_logoPath))
        {
            var physicalPath = Path.Combine(WebHostEnv.WebRootPath, _logoPath.TrimStart('/'));
            if (File.Exists(physicalPath))
                logoBytes = File.ReadAllBytes(physicalPath);
        }

        var companyDisplayName = string.IsNullOrEmpty(CompanyName) ? "RasidBase" : CompanyName;

        var doc = Document.Create(container =>
        {
            container.Page(page =>
            {
                page.Size(297, 210, QuestPDF.Infrastructure.Unit.Millimetre);
                page.Margin(25);
                if (IsRtl) page.ContentFromRightToLeft();
                page.DefaultTextStyle(x =>
                {
                    var style = x.FontSize(9);
                    if (IsRtl) style = style.FontFamily("Noto Sans Arabic");
                    return style;
                });

                page.Header().Column(col =>
                {
                    col.Item().Row(row =>
                    {
                        if (logoBytes is { Length: > 0 })
                        {
                            row.ConstantItem(50).Height(50).Image(logoBytes);
                            row.ConstantItem(10);
                        }

                        row.RelativeItem().PaddingTop(3).Column(info =>
                        {
                            info.Item().Text(companyDisplayName)
                                .Bold().FontSize(14).FontColor(QuestPDF.Helpers.Colors.Blue.Darken4);
                            if (!string.IsNullOrEmpty(CompanyAddress))
                                info.Item().Text(CompanyAddress).FontSize(8).FontColor(QuestPDF.Helpers.Colors.Grey.Darken2);
                            if (!string.IsNullOrEmpty(_companyTel))
                                info.Item().Text($"{T("Report_Tel")}: {_companyTel}").FontSize(8).FontColor(QuestPDF.Helpers.Colors.Grey.Darken2);
                        });

                        row.ConstantItem(180).AlignRight().PaddingTop(3).Column(rt =>
                        {
                            rt.Item().AlignRight().Text(title).Bold().FontSize(13).FontColor(QuestPDF.Helpers.Colors.Blue.Darken4);
                            rt.Item().AlignRight().PaddingTop(2).Text(GetDateRangeText())
                                .FontSize(8).FontColor(QuestPDF.Helpers.Colors.Grey.Darken1);
                        });
                    });

                    col.Item().PaddingVertical(6).LineHorizontal(1.5f).LineColor(QuestPDF.Helpers.Colors.Blue.Darken4);
                });

                page.Content().PaddingTop(5).Table(table =>
                {
                    table.ColumnsDefinition(cd =>
                    {
                        cd.ConstantColumn(25);
                        for (int i = 1; i < headers.Length; i++)
                            cd.RelativeColumn();
                    });

                    table.Header(header =>
                    {
                        foreach (var h in headers)
                        {
                            header.Cell().Background("#1E3A5F")
                                .Padding(5).AlignCenter()
                                .Text(h).FontColor(QuestPDF.Helpers.Colors.White).Bold().FontSize(8);
                        }
                    });

                    for (int r = 0; r < rows.Count; r++)
                    {
                        var bgColor = r % 2 == 0 ? "#FFFFFF" : "#F1F5F9";
                        foreach (var cellVal in rows[r])
                        {
                            table.Cell().Background(bgColor)
                                .BorderBottom(0.5f).BorderColor(QuestPDF.Helpers.Colors.Grey.Lighten2)
                                .Padding(4).AlignCenter()
                                .Text(cellVal).FontSize(8);
                        }
                    }
                });

                page.Footer().Row(footerRow =>
                {
                    footerRow.RelativeItem().AlignLeft().Text(text =>
                    {
                        text.DefaultTextStyle(x => x.FontSize(7).FontColor(QuestPDF.Helpers.Colors.Grey.Darken1));
                        text.Span(companyDisplayName);
                    });
                    footerRow.RelativeItem().AlignCenter().Text(text =>
                    {
                        text.DefaultTextStyle(x => x.FontSize(7).FontColor(QuestPDF.Helpers.Colors.Grey.Darken1));
                        text.Span($"{T("Report_Page")} ");
                        text.CurrentPageNumber();
                        text.Span($" {T("Report_Of")} ");
                        text.TotalPages();
                    });
                    footerRow.RelativeItem().AlignRight().Text(text =>
                    {
                        text.DefaultTextStyle(x => x.FontSize(7).FontColor(QuestPDF.Helpers.Colors.Grey.Darken1));
                        text.Span(DateTime.Now.ToString("dd/MM/yyyy HH:mm"));
                    });
                });
            });
        });

        using var ms = new MemoryStream();
        doc.GeneratePdf(ms);
        return ms.ToArray();
    }
}
