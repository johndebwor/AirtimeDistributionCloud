@page "/admin/assets/{AssetId:int}"
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "SystemAdmin,SuperAdministrator")]
@using AirtimeDistributionCloud.Application.DTOs
@using AirtimeDistributionCloud.Application.Services
@using AirtimeDistributionCloud.Core.Enums
@using AirtimeDistributionCloud.Core.Interfaces
@inject IAssetService AssetService
@inject IBranchService BranchService
@inject ICurrentUserService CurrentUser
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Asset Detail - RasidBase</PageTitle>

@if (_loading)
{
    <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
}
else if (_asset is null)
{
    <MudAlert Severity="Severity.Error" Class="mb-4">Asset not found.</MudAlert>
    <MudButton Variant="Variant.Outlined" OnClick="@(() => Navigation.NavigateTo("/admin/assets"))">Back to Assets</MudButton>
}
else
{
    <div class="page-header">
        <div class="d-flex align-center gap-3">
            <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" OnClick="@(() => Navigation.NavigateTo("/admin/assets"))" />
            <div>
                <h1 class="d-flex align-center gap-2">
                    @_asset.Name
                    @{
                        var statusColor = _asset.Status switch
                        {
                            AssetStatus.Active => Color.Success,
                            AssetStatus.InMaintenance => Color.Warning,
                            AssetStatus.Disposed => Color.Error,
                            AssetStatus.WrittenOff => Color.Dark,
                            _ => Color.Default
                        };
                        var condColor = _asset.Condition switch
                        {
                            AssetCondition.New => Color.Info,
                            AssetCondition.Good => Color.Success,
                            AssetCondition.Fair => Color.Warning,
                            AssetCondition.Poor => Color.Error,
                            _ => Color.Default
                        };
                    }
                    <MudChip T="string" Color="@statusColor" Size="Size.Small">@_asset.Status</MudChip>
                    <MudChip T="string" Color="@condColor" Size="Size.Small">@_asset.Condition</MudChip>
                </h1>
                <p>Asset ID: @_asset.Id &mdash; @_asset.CategoryName</p>
            </div>
        </div>
    </div>

    <div class="page-toolbar">
        <MudButton Variant="Variant.Outlined" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Edit"
                   OnClick="OpenEditDialog">Edit</MudButton>
        @if (_asset.Status == AssetStatus.Active || _asset.Status == AssetStatus.InMaintenance)
        {
            <MudButton Variant="Variant.Outlined" Color="Color.Info" StartIcon="@Icons.Material.Filled.SwapHoriz"
                       OnClick="OpenAssignDialog">Assign</MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Warning" StartIcon="@Icons.Material.Filled.Build"
                       OnClick="OpenMaintenanceDialog">Add Maintenance</MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Error" StartIcon="@Icons.Material.Filled.Delete"
                       OnClick="@(() => { _showDisposeDialog = true; })">Dispose / Write-Off</MudButton>
        }
    </div>

    <MudPaper Elevation="0" Class="data-card pa-4 mb-4">
        <MudGrid>
            <MudItem xs="12" md="6" lg="4">
                <MudText Typo="Typo.caption" Color="Color.Secondary">Name</MudText>
                <MudText Typo="Typo.body1">@_asset.Name</MudText>
            </MudItem>
            <MudItem xs="12" md="6" lg="4">
                <MudText Typo="Typo.caption" Color="Color.Secondary">Category</MudText>
                <MudText Typo="Typo.body1">@_asset.CategoryName</MudText>
            </MudItem>
            <MudItem xs="12" md="6" lg="4">
                <MudText Typo="Typo.caption" Color="Color.Secondary">Serial Number</MudText>
                <MudText Typo="Typo.body1">@(_asset.SerialNumber ?? "N/A")</MudText>
            </MudItem>
            <MudItem xs="12" md="6" lg="4">
                <MudText Typo="Typo.caption" Color="Color.Secondary">Asset Tag</MudText>
                <MudText Typo="Typo.body1">@(_asset.AssetTag ?? "N/A")</MudText>
            </MudItem>
            <MudItem xs="12" md="6" lg="4">
                <MudText Typo="Typo.caption" Color="Color.Secondary">Branch</MudText>
                <MudText Typo="Typo.body1">@_asset.BranchName</MudText>
            </MudItem>
            <MudItem xs="12" md="6" lg="4">
                <MudText Typo="Typo.caption" Color="Color.Secondary">Assigned To</MudText>
                <MudText Typo="Typo.body1">@(_asset.AssignedToUserName ?? "Unassigned")</MudText>
            </MudItem>
            <MudItem xs="12" md="6" lg="4">
                <MudText Typo="Typo.caption" Color="Color.Secondary">Purchase Date</MudText>
                <MudText Typo="Typo.body1">@(_asset.PurchaseDate?.ToString("dd MMM yyyy") ?? "N/A")</MudText>
            </MudItem>
            <MudItem xs="12" md="6" lg="4">
                <MudText Typo="Typo.caption" Color="Color.Secondary">Purchase Value</MudText>
                <MudText Typo="Typo.body1">@_asset.PurchaseValue.ToString("N2")</MudText>
            </MudItem>
            <MudItem xs="12" md="6" lg="4">
                <MudText Typo="Typo.caption" Color="Color.Secondary">Current Value</MudText>
                <MudText Typo="Typo.body1">@_asset.CurrentValue.ToString("N2")</MudText>
            </MudItem>
            <MudItem xs="12" md="6" lg="4">
                <MudText Typo="Typo.caption" Color="Color.Secondary">Book Value</MudText>
                <MudText Typo="Typo.body1">@_asset.BookValue.ToString("N2")</MudText>
            </MudItem>
            <MudItem xs="12" md="6" lg="4">
                <MudText Typo="Typo.caption" Color="Color.Secondary">Useful Life</MudText>
                <MudText Typo="Typo.body1">@_asset.UsefulLifeMonths months</MudText>
            </MudItem>
            <MudItem xs="12" md="6" lg="4">
                <MudText Typo="Typo.caption" Color="Color.Secondary">Depreciation Method</MudText>
                <MudText Typo="Typo.body1">@_asset.DepreciationMethod</MudText>
            </MudItem>
            <MudItem xs="12" md="6" lg="4">
                <MudText Typo="Typo.caption" Color="Color.Secondary">Created</MudText>
                <MudText Typo="Typo.body1">@_asset.CreatedDate.ToString("dd MMM yyyy") by @_asset.CreatedBy</MudText>
            </MudItem>
            @if (!string.IsNullOrEmpty(_asset.Notes))
            {
                <MudItem xs="12">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Notes</MudText>
                    <MudText Typo="Typo.body1">@_asset.Notes</MudText>
                </MudItem>
            }
            @if (!string.IsNullOrEmpty(_asset.PhotoPath))
            {
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Photo</MudText>
                    <MudImage Src="@_asset.PhotoPath" Alt="Asset Photo" Width="300" Elevation="2" Class="rounded mt-1" />
                </MudItem>
            }
            @if (!string.IsNullOrEmpty(_asset.DocumentPath))
            {
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Document</MudText>
                    <MudLink Href="@_asset.DocumentPath" Target="_blank" Typo="Typo.body1">
                        <MudIcon Icon="@Icons.Material.Filled.Description" Size="Size.Small" Class="me-1" />
                        Download Document
                    </MudLink>
                </MudItem>
            }
        </MudGrid>
    </MudPaper>

    <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" Class="data-card">
        <MudTabPanel Text="Assignment History" Icon="@Icons.Material.Filled.SwapHoriz">
            <div class="pa-4">
                @if (_asset.Status == AssetStatus.Active || _asset.Status == AssetStatus.InMaintenance)
                {
                    <div class="d-flex justify-end mb-3">
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small"
                                   StartIcon="@Icons.Material.Filled.Add" OnClick="OpenAssignDialog">Assign</MudButton>
                    </div>
                }
                <MudDataGrid T="AssetAssignmentDto" Items="@_assignments" Dense="true" Hover="true" Striped="true"
                             Loading="@_loadingAssignments">
                    <Columns>
                        <PropertyColumn Property="x => x.BranchName" Title="Branch" />
                        <PropertyColumn Property="x => x.AssignedToUserName" Title="User" />
                        <PropertyColumn Property="x => x.AssignedDate" Title="Assigned Date" Format="dd MMM yyyy" />
                        <TemplateColumn Title="Returned Date">
                            <CellTemplate>
                                @(context.Item.ReturnedDate?.ToString("dd MMM yyyy") ?? "Current")
                            </CellTemplate>
                        </TemplateColumn>
                        <PropertyColumn Property="x => x.Notes" Title="Notes" />
                    </Columns>
                    <NoRecordsContent>
                        <MudText>No assignment history.</MudText>
                    </NoRecordsContent>
                </MudDataGrid>
            </div>
        </MudTabPanel>

        <MudTabPanel Text="Maintenance Log" Icon="@Icons.Material.Filled.Build">
            <div class="pa-4">
                @if (_asset.Status == AssetStatus.Active || _asset.Status == AssetStatus.InMaintenance)
                {
                    <div class="d-flex justify-end mb-3">
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small"
                                   StartIcon="@Icons.Material.Filled.Add" OnClick="OpenMaintenanceDialog">Add Record</MudButton>
                    </div>
                }
                <MudDataGrid T="AssetMaintenanceDto" Items="@_maintenanceRecords" Dense="true" Hover="true" Striped="true"
                             Loading="@_loadingMaintenance">
                    <Columns>
                        <PropertyColumn Property="x => x.MaintenanceDate" Title="Date" Format="dd MMM yyyy" />
                        <PropertyColumn Property="x => x.Description" Title="Description" />
                        <TemplateColumn Title="Cost">
                            <CellTemplate>
                                @context.Item.Cost.ToString("N2")
                            </CellTemplate>
                        </TemplateColumn>
                        <TemplateColumn Title="Next Scheduled">
                            <CellTemplate>
                                @(context.Item.NextScheduledDate?.ToString("dd MMM yyyy") ?? "N/A")
                            </CellTemplate>
                        </TemplateColumn>
                        <PropertyColumn Property="x => x.PerformedBy" Title="Performed By" />
                    </Columns>
                    <NoRecordsContent>
                        <MudText>No maintenance records.</MudText>
                    </NoRecordsContent>
                </MudDataGrid>
            </div>
        </MudTabPanel>

        @if (_asset.Status == AssetStatus.Disposed || _asset.Status == AssetStatus.WrittenOff)
        {
            <MudTabPanel Text="Disposal Info" Icon="@Icons.Material.Filled.Delete">
                <div class="pa-4">
                    <MudGrid>
                        <MudItem xs="12" md="6">
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Disposal Status</MudText>
                            <MudText Typo="Typo.body1">@_asset.Status</MudText>
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Disposal Date</MudText>
                            <MudText Typo="Typo.body1">@(_asset.DisposalDate?.ToString("dd MMM yyyy") ?? "N/A")</MudText>
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Reason</MudText>
                            <MudText Typo="Typo.body1">@(_asset.DisposalReason ?? "N/A")</MudText>
                        </MudItem>
                        <MudItem xs="12">
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Notes</MudText>
                            <MudText Typo="Typo.body1">@(_asset.DisposalNotes ?? "N/A")</MudText>
                        </MudItem>
                    </MudGrid>
                </div>
            </MudTabPanel>
        }
    </MudTabs>

    @* Dispose / Write-Off Overlay Dialog *@
    <MudOverlay Visible="@_showDisposeDialog" DarkBackground="true" AutoClose="false" ZIndex="1300">
        <MudPaper Class="pa-6" Style="max-width: 500px; width: 100%;" Elevation="8">
            <MudText Typo="Typo.h6" Class="mb-4">Dispose / Write-Off Asset</MudText>
            <MudText Typo="Typo.body2" Class="mb-4">
                This will permanently change the status of <strong>@_asset.Name</strong>. This action cannot be undone.
            </MudText>
            <MudSelect T="string" @bind-Value="_disposeAction" Label="Action" Required="true" Class="mb-3">
                <MudSelectItem T="string" Value="@("Dispose")">Dispose</MudSelectItem>
                <MudSelectItem T="string" Value="@("WriteOff")">Write Off</MudSelectItem>
            </MudSelect>
            <MudTextField @bind-Value="_disposeReason" Label="Reason" Required="true"
                          RequiredError="Reason is required" Class="mb-3" />
            <MudTextField @bind-Value="_disposeNotes" Label="Notes" Lines="3" Class="mb-3" />
            <div class="d-flex justify-end gap-2">
                <MudButton OnClick="@(() => { _showDisposeDialog = false; })">Cancel</MudButton>
                <MudButton Color="Color.Error" Variant="Variant.Filled" OnClick="ConfirmDispose"
                           Disabled="@_disposing">Confirm</MudButton>
            </div>
        </MudPaper>
    </MudOverlay>
}

@code {
    [Parameter] public int AssetId { get; set; }

    private AssetDto? _asset;
    private List<AssetAssignmentDto> _assignments = new();
    private List<AssetMaintenanceDto> _maintenanceRecords = new();
    private bool _loading = true;
    private bool _loadingAssignments;
    private bool _loadingMaintenance;

    // Dispose dialog fields
    private bool _showDisposeDialog;
    private bool _disposing;
    private string _disposeAction = "Dispose";
    private string _disposeReason = string.Empty;
    private string _disposeNotes = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadAsset();
    }

    private async Task LoadAsset()
    {
        _loading = true;
        try
        {
            _asset = await AssetService.GetAssetByIdAsync(AssetId);
            if (_asset is not null)
            {
                await LoadAssignments();
                await LoadMaintenance();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading asset: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task LoadAssignments()
    {
        _loadingAssignments = true;
        try
        {
            _assignments = (await AssetService.GetAssignmentHistoryAsync(AssetId)).ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading assignments: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loadingAssignments = false;
        }
    }

    private async Task LoadMaintenance()
    {
        _loadingMaintenance = true;
        try
        {
            _maintenanceRecords = (await AssetService.GetMaintenanceRecordsAsync(AssetId)).ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading maintenance records: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loadingMaintenance = false;
        }
    }

    private async Task OpenEditDialog()
    {
        var branches = (await BranchService.GetAllBranchesAsync()).Where(b => b.IsActive).ToList();
        var categories = (await AssetService.GetActiveCategoriesAsync()).ToList();

        var parameters = new DialogParameters<AssetDialog>
        {
            { x => x.Asset, _asset },
            { x => x.Branches, branches },
            { x => x.Categories, categories }
        };
        var dialog = await DialogService.ShowAsync<AssetDialog>("Edit Asset", parameters,
            new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true });
        var result = await dialog.Result;
        if (result is { Canceled: false })
            await LoadAsset();
    }

    private async Task OpenAssignDialog()
    {
        var branches = (await BranchService.GetAllBranchesAsync()).Where(b => b.IsActive).ToList();

        var parameters = new DialogParameters<AssetAssignmentDialog>
        {
            { x => x.AssetId, AssetId },
            { x => x.Branches, branches }
        };
        var dialog = await DialogService.ShowAsync<AssetAssignmentDialog>("Assign Asset", parameters,
            new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true });
        var result = await dialog.Result;
        if (result is { Canceled: false })
            await LoadAsset();
    }

    private async Task OpenMaintenanceDialog()
    {
        var parameters = new DialogParameters<AssetMaintenanceDialog>
        {
            { x => x.AssetId, AssetId }
        };
        var dialog = await DialogService.ShowAsync<AssetMaintenanceDialog>("Add Maintenance Record", parameters,
            new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true });
        var result = await dialog.Result;
        if (result is { Canceled: false })
            await LoadAsset();
    }

    private async Task ConfirmDispose()
    {
        if (string.IsNullOrWhiteSpace(_disposeReason))
        {
            Snackbar.Add("Please provide a reason", Severity.Warning);
            return;
        }

        _disposing = true;
        try
        {
            var userId = CurrentUser.UserId ?? "";
            if (_disposeAction == "WriteOff")
                await AssetService.WriteOffAssetAsync(AssetId, _disposeReason, _disposeNotes, userId);
            else
                await AssetService.DisposeAssetAsync(AssetId, _disposeReason, _disposeNotes, userId);

            var actionLabel = _disposeAction == "WriteOff" ? "written off" : "disposed";
            Snackbar.Add($"Asset {actionLabel} successfully", Severity.Success);
            _showDisposeDialog = false;
            await LoadAsset();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _disposing = false;
        }
    }
}
