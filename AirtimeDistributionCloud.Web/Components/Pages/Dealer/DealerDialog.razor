@rendermode InteractiveServer
@using AirtimeDistributionCloud.Application.DTOs
@using AirtimeDistributionCloud.Application.Services
@inject IDealerService DealerService
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudGrid>
            <MudItem xs="12" sm="6">
                <MudSelect T="DealerType" @bind-Value="_type" Label="Type" Required="true"
                           RequiredError="Dealer type is required" Class="mb-3">
                    <MudSelectItem T="DealerType" Value="DealerType.Person">Person</MudSelectItem>
                    <MudSelectItem T="DealerType" Value="DealerType.Company">Company</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudTextField @bind-Value="_name" Label="Name" Required="true"
                              RequiredError="Name is required" Class="mb-3" />
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudSelect T="string" @bind-Value="_gender" Label="Gender" Clearable="true" Class="mb-3">
                    <MudSelectItem T="string" Value="@("Male")">Male</MudSelectItem>
                    <MudSelectItem T="string" Value="@("Female")">Female</MudSelectItem>
                    <MudSelectItem T="string" Value="@("Other")">Other</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudTextField @bind-Value="_idNumber" Label="ID Number" Class="mb-3" />
            </MudItem>
            @if (_type == DealerType.Company)
            {
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_companyRegNumber" Label="Company Reg Number" Class="mb-3" />
                </MudItem>
            }
            <MudItem xs="12" sm="6">
                <MudTextField @bind-Value="_nationality" Label="Nationality" Class="mb-3" />
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudTextField @bind-Value="_state" Label="State" Class="mb-3" />
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudTextField @bind-Value="_county" Label="County" Class="mb-3" />
            </MudItem>
            <MudItem xs="12">
                <MudTextField @bind-Value="_physicalAddress" Label="Physical Address" Lines="2" Class="mb-3" />
            </MudItem>
        </MudGrid>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Submit" Disabled="@_saving">Save</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = null!;

    private bool _saving;
    private DealerType _type = DealerType.Person;
    private string _name = "";
    private string? _gender;
    private string? _idNumber;
    private string? _companyRegNumber;
    private string? _nationality;
    private string? _state;
    private string? _county;
    private string? _physicalAddress;

    private async Task Submit()
    {
        if (string.IsNullOrWhiteSpace(_name))
        {
            Snackbar.Add("Name is required", Severity.Warning);
            return;
        }

        _saving = true;
        try
        {
            await DealerService.CreateDealerAsync(new CreateDealerRequest(
                _type, _name, _gender, _idNumber, _companyRegNumber,
                _nationality, _state, _county, _physicalAddress));
            Snackbar.Add("Dealer registered successfully", Severity.Success);
            MudDialog.Close(DialogResult.Ok(true));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    private void Cancel() => MudDialog.Cancel();
}
