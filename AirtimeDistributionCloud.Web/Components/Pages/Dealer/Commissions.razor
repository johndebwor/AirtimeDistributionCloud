@page "/dealer/commissions"
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "SystemAdmin,SuperAdministrator,Dealer")]
@using AirtimeDistributionCloud.Core.Entities
@using AirtimeDistributionCloud.Core.Interfaces
@using AirtimeDistributionCloud.Application.Services
@using AirtimeDistributionCloud.Application.DTOs
@inject IDealerService DealerService
@inject IUnitOfWork UnitOfWork
@inject ISnackbar Snackbar
@rendermode InteractiveServer

<PageTitle>@(Lang?.T("Commissions_Title") ?? "Commissions") - RasidBase</PageTitle>

<div class="page-header">
    <h1>@(Lang?.T("Commissions_Title") ?? "Commissions")</h1>
    <p>@(Lang?.T("Commissions_Subtitle") ?? "View and manage dealer commission rates")</p>
</div>

<div class="page-toolbar">
    <MudTextField @bind-Value="_searchString" Placeholder="@(Lang?.T("Commissions_Search") ?? "Search by dealer name or number...")"
                  Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search"
                  IconSize="Size.Medium" Class="mt-0" Immediate="true" Style="max-width:300px;" />
</div>

<MudPaper Elevation="0" Class="data-card pa-4">
    <MudDataGrid T="DealerCommissionSummary" Items="@_dealerSummaries" Loading="@_loading"
                 Dense="true" Hover="true" Striped="true" Filterable="false"
                 QuickFilter="@_quickFilter">
        <Columns>
            <PropertyColumn Property="x => x.DealerNumber" Title="@(Lang?.T("DealerNumber") ?? "Dealer #")" />
            <PropertyColumn Property="x => x.DealerName" Title="@(Lang?.T("Dealer") ?? "Dealer")" />
            <PropertyColumn Property="x => x.ProductCount" Title="@(Lang?.T("Commissions_Products") ?? "Products")" />
            <PropertyColumn Property="x => x.TotalCommissionBalance" Title="@(Lang?.T("Commissions_Balance") ?? "Commission Balance")" Format="C2" />
            <PropertyColumn Property="x => x.TotalBalance" Title="@(Lang?.T("Balance") ?? "Balance")" Format="C2" />
            <TemplateColumn Title="@(Lang?.T("Actions") ?? "Actions")" Sortable="false">
                <CellTemplate>
                    <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.Edit"
                               OnClick="@(() => OpenDealerEditDialog(context.Item))">
                        @(Lang?.T("Commissions_EditRates") ?? "Edit Rates")
                    </MudButton>
                </CellTemplate>
            </TemplateColumn>
        </Columns>
        <NoRecordsContent>
            <MudText>@(Lang?.T("Commissions_NotFound") ?? "No commission data found. Register dealers with products first.")</MudText>
        </NoRecordsContent>
    </MudDataGrid>
</MudPaper>

@if (_editDialogOpen && _editingDealer is not null)
{
    <MudOverlay Visible="true" DarkBackground="true" ZIndex="9" AutoClose="false">
        <MudPaper Class="pa-6" Style="min-width:480px; max-width:640px; border-radius:12px; max-height:85vh; overflow-y:auto;">
            <div class="d-flex justify-space-between align-center mb-1">
                <MudText Typo="Typo.h6">@(Lang?.T("Commissions_EditTitle") ?? "Edit Commission Rates")</MudText>
                <MudIconButton Icon="@Icons.Material.Filled.Close" Size="Size.Small"
                               OnClick="@(() => _editDialogOpen = false)" />
            </div>
            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-1">@_editingDealer.DealerName</MudText>
            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-4 d-block">
                @(Lang?.T("Commissions_AllowedRange") ?? "Allowed range"): @_minCommission% â€“ @_maxCommission%
            </MudText>

            <MudDivider Class="mb-4" />

            @foreach (var item in _editingProducts)
            {
                <div class="commission-edit-row mb-3">
                    <MudText Typo="Typo.body2" Style="font-weight:600; flex:1;">@item.ProductName</MudText>
                    <div style="width:160px;">
                        <MudTextField T="decimal" @bind-Value="item.CommissionRate"
                                      Label="@(Lang?.T("Commissions_RatePercent") ?? "Rate %")"
                                      Variant="Variant.Outlined" Margin="Margin.Dense"
                                      Format="N2" />
                    </div>
                    <div class="ml-3" style="min-width:120px;">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">@(Lang?.T("Balance") ?? "Bal")</MudText>
                        <MudText Typo="Typo.body2">@item.Balance.ToString("C2")</MudText>
                    </div>
                </div>
            }

            <MudDivider Class="my-4" />

            <div class="d-flex justify-end gap-2">
                <MudButton OnClick="@(() => _editDialogOpen = false)" Variant="Variant.Outlined">
                    @(Lang?.T("Cancel") ?? "Cancel")
                </MudButton>
                <MudButton Color="Color.Primary" Variant="Variant.Filled"
                           StartIcon="@Icons.Material.Filled.Save"
                           OnClick="SaveAllCommissions" Disabled="@_saving">
                    @if (_saving)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    }
                    @(Lang?.T("Commissions_SaveAll") ?? "Save All")
                </MudButton>
            </div>
        </MudPaper>
    </MudOverlay>
}

@code {
    [CascadingParameter] public AirtimeDistributionCloud.Application.Services.ILanguageService? Lang { get; set; }

    private List<DealerDto> _dealers = new();
    private List<DealerCommissionSummary> _dealerSummaries = new();
    private string _searchString = "";
    private bool _loading = true;

    private Func<DealerCommissionSummary, bool> _quickFilter =>
        x => string.IsNullOrWhiteSpace(_searchString) ||
             x.DealerName.Contains(_searchString, StringComparison.OrdinalIgnoreCase) ||
             x.DealerNumber.Contains(_searchString, StringComparison.OrdinalIgnoreCase);
    private bool _editDialogOpen;
    private bool _saving;
    private DealerCommissionSummary? _editingDealer;
    private List<DealerProductEdit> _editingProducts = new();
    private decimal _minCommission = 0;
    private decimal _maxCommission = 200;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _dealers = (await DealerService.GetAllDealersAsync()).ToList();
            await LoadCommissionRange();
            await LoadDealerSummaries();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"{Lang?.T("ErrorLoading") ?? "Error"}: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task LoadCommissionRange()
    {
        var settings = await UnitOfWork.Repository<SystemSetting>().GetAllAsync();
        var minSetting = settings.FirstOrDefault(s => s.Key == "CommissionMinPercentage");
        var maxSetting = settings.FirstOrDefault(s => s.Key == "CommissionMaxPercentage");
        if (minSetting is not null && decimal.TryParse(minSetting.Value, out var min)) _minCommission = min;
        if (maxSetting is not null && decimal.TryParse(maxSetting.Value, out var max)) _maxCommission = max;
    }

    private async Task LoadDealerSummaries()
    {
        _loading = true;
        try
        {
            var allDp = await UnitOfWork.Repository<DealerProduct>().GetAllAsync();
            var products = (await UnitOfWork.Repository<Product>().GetAllAsync()).ToDictionary(p => p.Id);
            var dealerMap = _dealers.ToDictionary(d => d.Id);

            _dealerSummaries = allDp
                .GroupBy(dp => dp.DealerId)
                .Select(g =>
                {
                    var dealer = dealerMap.GetValueOrDefault(g.Key);
                    var items = g.Select(dp => new DealerProductEdit
                    {
                        DealerProductId = dp.Id,
                        ProductName = products.GetValueOrDefault(dp.ProductId)?.Name ?? "Unknown",
                        CommissionRate = dp.CommissionRate,
                        CommissionBalance = dp.CommissionBalance,
                        Balance = dp.Balance
                    }).ToList();

                    return new DealerCommissionSummary
                    {
                        DealerId = g.Key,
                        DealerNumber = dealer?.DealerNumber ?? "",
                        DealerName = dealer?.Name ?? "Unknown",
                        ProductCount = items.Count,
                        TotalCommissionBalance = items.Sum(i => i.CommissionBalance),
                        TotalBalance = items.Sum(i => i.Balance),
                        Products = items
                    };
                })
                .OrderBy(s => s.DealerName)
                .ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"{Lang?.T("ErrorLoading") ?? "Error loading commissions"}: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private void OpenDealerEditDialog(DealerCommissionSummary summary)
    {
        _editingDealer = summary;
        _editingProducts = summary.Products.Select(p => new DealerProductEdit
        {
            DealerProductId = p.DealerProductId,
            ProductName = p.ProductName,
            CommissionRate = p.CommissionRate,
            CommissionBalance = p.CommissionBalance,
            Balance = p.Balance
        }).ToList();
        _editDialogOpen = true;
    }

    private async Task SaveAllCommissions()
    {
        if (_editingDealer is null) return;

        foreach (var item in _editingProducts)
        {
            if (item.CommissionRate < _minCommission || item.CommissionRate > _maxCommission)
            {
                Snackbar.Add(
                    string.Format(Lang?.T("Commissions_RangeError") ?? "Commission for {0} must be between {1}% and {2}%",
                        item.ProductName, _minCommission, _maxCommission),
                    Severity.Warning);
                return;
            }
        }

        _saving = true;
        try
        {
            foreach (var item in _editingProducts)
            {
                await DealerService.UpdateCommissionAsync(new UpdateCommissionRequest(item.DealerProductId, item.CommissionRate));
            }

            var summary = _dealerSummaries.FirstOrDefault(s => s.DealerId == _editingDealer.DealerId);
            if (summary is not null)
            {
                foreach (var product in summary.Products)
                {
                    var edited = _editingProducts.FirstOrDefault(e => e.DealerProductId == product.DealerProductId);
                    if (edited is not null) product.CommissionRate = edited.CommissionRate;
                }
            }

            _editDialogOpen = false;
            Snackbar.Add(Lang?.T("Commissions_Updated") ?? "Commission rates updated successfully", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"{Lang?.T("Error") ?? "Error"}: {ex.Message}", Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    private class DealerCommissionSummary
    {
        public int DealerId { get; set; }
        public string DealerNumber { get; set; } = "";
        public string DealerName { get; set; } = "";
        public int ProductCount { get; set; }
        public decimal TotalCommissionBalance { get; set; }
        public decimal TotalBalance { get; set; }
        public List<DealerProductEdit> Products { get; set; } = new();
    }

    private class DealerProductEdit
    {
        public int DealerProductId { get; set; }
        public string ProductName { get; set; } = "";
        public decimal CommissionRate { get; set; }
        public decimal CommissionBalance { get; set; }
        public decimal Balance { get; set; }
    }
}
