@rendermode InteractiveServer
@using AirtimeDistributionCloud.Application.DTOs
@using AirtimeDistributionCloud.Application.Services
@using AirtimeDistributionCloud.Core.Enums
@inject IJSRuntime JS

<MudDialog>
    <DialogContent>
        <MudSimpleTable Hover="true" Dense="true" Striped="true">
            <tbody>
                <tr>
                    <td><strong>@(Lang?.T("Registration_DealerNum") ?? "Dealer #")</strong></td>
                    <td>@Dealer.DealerNumber</td>
                </tr>
                <tr>
                    <td><strong>@(Lang?.T("Type") ?? "Type")</strong></td>
                    <td>@Dealer.Type</td>
                </tr>
                <tr>
                    <td><strong>@(Lang?.T("Name") ?? "Name")</strong></td>
                    <td>@Dealer.Name</td>
                </tr>
                @if (Dealer.Type == DealerType.Person)
                {
                    <tr>
                        <td><strong>@(Lang?.T("Registration_Gender") ?? "Gender")</strong></td>
                        <td>@(string.IsNullOrEmpty(Dealer.Gender) ? "-" : Dealer.Gender)</td>
                    </tr>
                    <tr>
                        <td><strong>@(Lang?.T("DealerDialog_IDType") ?? "ID Type")</strong></td>
                        <td>@(string.IsNullOrEmpty(Dealer.IdType) ? "-" : Dealer.IdType)</td>
                    </tr>
                    <tr>
                        <td><strong>@(Lang?.T("Registration_IDNumber") ?? "ID Number")</strong></td>
                        <td>@(string.IsNullOrEmpty(Dealer.IDNumber) ? "-" : Dealer.IDNumber)</td>
                    </tr>
                    <tr>
                        <td><strong>@(Lang?.T("DealerDialog_Nationality") ?? "Nationality")</strong></td>
                        <td>@(string.IsNullOrEmpty(Dealer.Nationality) ? "-" : Dealer.Nationality)</td>
                    </tr>
                }
                @if (Dealer.Type == DealerType.Company)
                {
                    <tr>
                        <td><strong>@(Lang?.T("DealerDialog_CompanyRegNum") ?? "Company Reg Number")</strong></td>
                        <td>@(string.IsNullOrEmpty(Dealer.CompanyRegNumber) ? "-" : Dealer.CompanyRegNumber)</td>
                    </tr>
                }
                <tr>
                    <td><strong>@(Lang?.T("Registration_State") ?? "State")</strong></td>
                    <td>@(string.IsNullOrEmpty(Dealer.State) ? "-" : Dealer.State)</td>
                </tr>
                <tr>
                    <td><strong>@(Lang?.T("DealerDialog_County") ?? "County")</strong></td>
                    <td>@(string.IsNullOrEmpty(Dealer.County) ? "-" : Dealer.County)</td>
                </tr>
                <tr>
                    <td><strong>@(Lang?.T("PhoneNumber") ?? "Phone Number")</strong></td>
                    <td>@(string.IsNullOrEmpty(Dealer.PhoneNumber) ? "-" : Dealer.PhoneNumber)</td>
                </tr>
                <tr>
                    <td><strong>@(Lang?.T("DealerDialog_PhysicalAddress") ?? "Physical Address")</strong></td>
                    <td>@(string.IsNullOrEmpty(Dealer.PhysicalAddress) ? "-" : Dealer.PhysicalAddress)</td>
                </tr>
            </tbody>
        </MudSimpleTable>

        <!-- Dealer Photo (Person only) -->
        @if (Dealer.Type == DealerType.Person && !string.IsNullOrEmpty(Dealer.PhotoPath))
        {
            <MudText Typo="Typo.h6" Class="mt-4 mb-2">@(Lang?.T("DealerDialog_Photo") ?? "Photo")</MudText>
            <div style="text-align:center; margin-bottom:12px;">
                <img src="@Dealer.PhotoPath" alt="@(Lang?.T("DealerDialog_Photo") ?? "Photo")"
                     style="width:100px;height:100px;border-radius:50%;object-fit:cover;border:2px solid var(--mud-palette-divider);" />
            </div>
        }

        <!-- Attached Document -->
        <MudText Typo="Typo.h6" Class="mt-4 mb-2">
            @(Dealer.Type == DealerType.Company ? (Lang?.T("DealerDetails_CompanyCert") ?? "Company Certificate") : (Lang?.T("DealerDetails_IDDocument") ?? "ID Document"))
        </MudText>
        @if (!string.IsNullOrEmpty(Dealer.DocumentPath))
        {
            @if (IsImage(Dealer.DocumentPath))
            {
                <div style="text-align:center; margin-bottom:12px;">
                    <MudImage Src="@Dealer.DocumentPath" Alt="@(Lang?.T("Document") ?? "Document")" ObjectFit="ObjectFit.Contain"
                              Style="max-width:100%; max-height:400px; border-radius:8px; border:1px solid #e0e0e0;" Elevation="1" />
                </div>
            }
            else
            {
                <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Dense="true" Class="mb-3">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.PictureAsPdf" />
                        <MudText>@System.IO.Path.GetFileName(Dealer.DocumentPath)</MudText>
                    </MudStack>
                </MudAlert>
            }
            <MudStack Row="true" Spacing="2" Justify="Justify.Center">
                <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small"
                           StartIcon="@Icons.Material.Filled.OpenInNew"
                           OnClick="@(() => OpenDocument())">
                    @(Lang?.T("DealerDetails_ViewDocument") ?? "View Document")
                </MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Secondary" Size="Size.Small"
                           StartIcon="@Icons.Material.Filled.Download"
                           Href="@Dealer.DocumentPath" Target="_blank" download>
                    @(Lang?.T("Download") ?? "Download")
                </MudButton>
            </MudStack>
        }
        else
        {
            <MudAlert Severity="Severity.Normal" Variant="Variant.Outlined" Dense="true">
                @(Lang?.T("DealerDetails_NoDocument") ?? "No document attached")
            </MudAlert>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Close" Variant="Variant.Filled" Color="Color.Primary">@(Lang?.T("Close") ?? "Close")</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = null!;
    [CascadingParameter] public AirtimeDistributionCloud.Application.Services.ILanguageService? Lang { get; set; }
    [Parameter] public DealerDto Dealer { get; set; } = null!;

    private static bool IsImage(string path)
    {
        var ext = System.IO.Path.GetExtension(path)?.ToLowerInvariant();
        return ext is ".jpg" or ".jpeg" or ".png" or ".svg" or ".webp";
    }

    private async Task OpenDocument()
    {
        await JS.InvokeVoidAsync("open", Dealer.DocumentPath, "_blank");
    }

    private void Close() => MudDialog.Close();
}
