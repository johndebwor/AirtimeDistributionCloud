@page "/Account/Manage/EnableAuthenticator"

@using System.ComponentModel.DataAnnotations
@using System.Globalization
@using System.Text
@using System.Text.Encodings.Web
@using Microsoft.AspNetCore.Identity
@using AirtimeDistributionCloud.Core.Entities

@inject UserManager<ApplicationUser> UserManager
@inject UrlEncoder UrlEncoder
@inject IdentityRedirectManager RedirectManager
@inject ILogger<EnableAuthenticator> Logger

<PageTitle>Configure Authenticator - RasidBase</PageTitle>

@if (recoveryCodes is not null)
{
    <ShowRecoveryCodes RecoveryCodes="recoveryCodes.ToArray()" StatusMessage="@message" />
}
else
{
    <div class="page-header">
        <h1>Configure Authenticator App</h1>
        <p>Set up two-factor authentication with an authenticator app</p>
    </div>

    <MudGrid Justify="Justify.Center">
        <MudItem xs="12" sm="10" md="8">
            <StatusMessage Message="@message" />

            <MudPaper Elevation="0" Class="data-card pa-6 mb-4">
                <MudText Typo="Typo.h6" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.LooksOne" Size="Size.Small" Class="mr-1" />
                    Download an Authenticator App
                </MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    Download a two-factor authenticator app like <strong>Microsoft Authenticator</strong> or
                    <strong>Google Authenticator</strong> from your device's app store.
                </MudText>
            </MudPaper>

            <MudPaper Elevation="0" Class="data-card pa-6 mb-4">
                <MudText Typo="Typo.h6" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.LooksTwo" Size="Size.Small" Class="mr-1" />
                    Scan QR Code or Enter Key
                </MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3">
                    Scan the QR code or enter this key into your authenticator app. Spaces and casing do not matter.
                </MudText>
                <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Dense="true" Class="mb-3">
                    <code style="font-size:1.1rem; letter-spacing:2px;">@sharedKey</code>
                </MudAlert>
                <div data-url="@authenticatorUri"></div>
            </MudPaper>

            <MudPaper Elevation="0" Class="data-card pa-6">
                <MudText Typo="Typo.h6" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.Looks3" Size="Size.Small" Class="mr-1" />
                    Enter Verification Code
                </MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3">
                    Enter the 6-digit code from your authenticator app to verify setup.
                </MudText>
                <EditForm Model="Input" FormName="send-code" OnValidSubmit="OnValidSubmitAsync" method="post">
                    <DataAnnotationsValidator />
                    <div class="mb-4">
                        <label class="mud-input-label">Verification Code</label>
                        <InputText @bind-Value="Input.Code" id="Input.Code"
                                   class="form-control mud-input-root" autocomplete="off"
                                   placeholder="Enter the 6-digit code" />
                        <ValidationMessage For="() => Input.Code" class="text-danger mud-input-helper-text" />
                    </div>
                    <button type="submit" class="mud-button-root mud-button mud-button-filled mud-button-filled-primary mud-button-filled-size-medium mud-ripple w-100"
                            style="height:42px; font-size:0.9rem; letter-spacing:0.05em;">
                        Verify
                    </button>
                    <ValidationSummary class="text-danger mt-2" role="alert" />
                </EditForm>
            </MudPaper>
        </MudItem>
    </MudGrid>
}

@code {
    private const string AuthenticatorUriFormat = "otpauth://totp/{0}:{1}?secret={2}&issuer={0}&digits=6";

    private string? message;
    private ApplicationUser? user;
    private string? sharedKey;
    private string? authenticatorUri;
    private IEnumerable<string>? recoveryCodes;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        Input ??= new();

        user = await UserManager.GetUserAsync(HttpContext.User);
        if (user is null)
        {
            RedirectManager.RedirectToInvalidUser(UserManager, HttpContext);
            return;
        }

        await LoadSharedKeyAndQrCodeUriAsync(user);
    }

    private async Task OnValidSubmitAsync()
    {
        if (user is null)
        {
            RedirectManager.RedirectToInvalidUser(UserManager, HttpContext);
            return;
        }

        var verificationCode = Input.Code.Replace(" ", string.Empty).Replace("-", string.Empty);

        var is2faTokenValid = await UserManager.VerifyTwoFactorTokenAsync(
            user, UserManager.Options.Tokens.AuthenticatorTokenProvider, verificationCode);

        if (!is2faTokenValid)
        {
            message = "Error: Verification code is invalid.";
            return;
        }

        await UserManager.SetTwoFactorEnabledAsync(user, true);
        var userId = await UserManager.GetUserIdAsync(user);
        Logger.LogInformation("User with ID '{UserId}' has enabled 2FA with an authenticator app.", userId);

        message = "Your authenticator app has been verified.";

        if (await UserManager.CountRecoveryCodesAsync(user) == 0)
        {
            recoveryCodes = await UserManager.GenerateNewTwoFactorRecoveryCodesAsync(user, 10);
        }
        else
        {
            RedirectManager.RedirectToWithStatus("Account/Manage/TwoFactorAuthentication", message, HttpContext);
        }
    }

    private async ValueTask LoadSharedKeyAndQrCodeUriAsync(ApplicationUser user)
    {
        var unformattedKey = await UserManager.GetAuthenticatorKeyAsync(user);
        if (string.IsNullOrEmpty(unformattedKey))
        {
            await UserManager.ResetAuthenticatorKeyAsync(user);
            unformattedKey = await UserManager.GetAuthenticatorKeyAsync(user);
        }

        sharedKey = FormatKey(unformattedKey!);

        var email = await UserManager.GetEmailAsync(user);
        authenticatorUri = GenerateQrCodeUri(email!, unformattedKey!);
    }

    private string FormatKey(string unformattedKey)
    {
        var result = new StringBuilder();
        int currentPosition = 0;
        while (currentPosition + 4 < unformattedKey.Length)
        {
            result.Append(unformattedKey.AsSpan(currentPosition, 4)).Append(' ');
            currentPosition += 4;
        }
        if (currentPosition < unformattedKey.Length)
        {
            result.Append(unformattedKey.AsSpan(currentPosition));
        }

        return result.ToString().ToLowerInvariant();
    }

    private string GenerateQrCodeUri(string email, string unformattedKey)
    {
        return string.Format(
            CultureInfo.InvariantCulture,
            AuthenticatorUriFormat,
            UrlEncoder.Encode("RasidBase"),
            UrlEncoder.Encode(email),
            unformattedKey);
    }

    private sealed class InputModel
    {
        [Required]
        [StringLength(7, ErrorMessage = "The {0} must be at least {2} and at max {1} characters long.", MinimumLength = 6)]
        [DataType(DataType.Text)]
        [Display(Name = "Verification Code")]
        public string Code { get; set; } = "";
    }
}
