@inherits LayoutComponentBase
@inject NavigationManager Navigation
@inject IJSRuntime JS
@using AirtimeDistributionCloud.Application.Services
@using AirtimeDistributionCloud.Core.Interfaces
@using AirtimeDistributionCloud.Core.Entities
@inject ICurrentUserService CurrentUser
@inject IServiceScopeFactory ScopeFactory

<MudThemeProvider @ref="_themeProvider" Theme="_theme" IsDarkMode="@_isDarkMode" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Elevation="0" Dense="true">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start"
                       OnClick="@ToggleDrawer" />
        <MudText Typo="Typo.h6" Class="d-none d-sm-flex ml-2" Style="font-weight: 600;">
            RasidBase
        </MudText>
        <MudText Typo="Typo.h6" Class="d-flex d-sm-none ml-2" Style="font-weight: 600;">RasidBase</MudText>
        <MudSpacer />

        <MudMenu Icon="@_themeModeIcon" Color="Color.Inherit" AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight">
            <MudMenuItem Icon="@Icons.Material.Outlined.LightMode" OnClick="@(() => SetThemeMode("Light"))">
                Light @if (_themeMode == "Light") { <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" Class="ml-2" /> }
            </MudMenuItem>
            <MudMenuItem Icon="@Icons.Material.Outlined.DarkMode" OnClick="@(() => SetThemeMode("Dark"))">
                Dark @if (_themeMode == "Dark") { <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" Class="ml-2" /> }
            </MudMenuItem>
            <MudMenuItem Icon="@Icons.Material.Outlined.SettingsBrightness" OnClick="@(() => SetThemeMode("Auto"))">
                Auto @if (_themeMode == "Auto") { <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" Class="ml-2" /> }
            </MudMenuItem>
        </MudMenu>

        <AuthorizeView>
            <Authorized>
                <MudMenu AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight">
                    <ActivatorContent>
                        <MudButton Variant="Variant.Text" Color="Color.Inherit" Class="text-transform-none ml-1"
                                   StartIcon="@Icons.Material.Outlined.AccountCircle"
                                   EndIcon="@Icons.Material.Filled.KeyboardArrowDown">
                            <span class="d-none d-sm-inline">@context.User.Identity?.Name</span>
                        </MudButton>
                    </ActivatorContent>
                    <ChildContent>
                        <MudMenuItem Icon="@Icons.Material.Outlined.Person" Href="/profile">Profile</MudMenuItem>
                        <MudDivider />
                        <MudMenuItem Icon="@Icons.Material.Outlined.Logout" IconColor="Color.Error"
                                     OnClick="@SubmitLogout">
                            Sign out
                        </MudMenuItem>
                    </ChildContent>
                </MudMenu>
                <form id="logoutForm" method="post" action="/Account/Logout" style="display:none;">
                    <AntiforgeryToken />
                    <input type="hidden" name="ReturnUrl" value="/" />
                </form>
            </Authorized>
            <NotAuthorized>
                <MudButton Href="/Account/Login" Color="Color.Inherit" Variant="Variant.Text"
                           StartIcon="@Icons.Material.Outlined.Login" Class="text-transform-none">Sign in</MudButton>
            </NotAuthorized>
        </AuthorizeView>
    </MudAppBar>

    <MudDrawer @bind-Open="_drawerOpen" ClipMode="DrawerClipMode.Always" Breakpoint="Breakpoint.Md"
               Elevation="0" Variant="@DrawerVariant.Responsive" Class="sidebar">

        <div class="sidebar-brand">
            <div class="sidebar-brand-logo">
                <MudIcon Icon="@Icons.Material.Filled.CellTower" Style="color: white; font-size: 1.25rem;" />
            </div>
            <div class="sidebar-brand-text">
                <span class="sidebar-brand-name">@(string.IsNullOrEmpty(_companyShortName) ? "RB" : _companyShortName)</span>
                <span class="sidebar-brand-label">@(string.IsNullOrEmpty(_companyFullName) ? "Smart Airtime Distribution" : _companyFullName)</span>
            </div>
        </div>

        <div class="sidebar-nav">
            <NavMenu />
        </div>

        <div class="sidebar-footer">v 0.1.0</div>
    </MudDrawer>

    <MudMainContent Class="pt-16 px-2 px-sm-4">
        <MudContainer MaxWidth="MaxWidth.False" Class="py-4">
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">X</span>
</div>

@code {
    private MudThemeProvider _themeProvider = null!;
    private bool _drawerOpen = true;
    private bool _isDarkMode;
    private string _themeMode = "Auto";
    private string _companyFullName = "";
    private string _companyShortName = "";

    private string _themeModeIcon => _themeMode switch
    {
        "Light" => Icons.Material.Outlined.LightMode,
        "Dark" => Icons.Material.Outlined.DarkMode,
        _ => Icons.Material.Outlined.SettingsBrightness
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            using var scope = ScopeFactory.CreateScope();
            var userPrefs = scope.ServiceProvider.GetRequiredService<IUserPreferenceService>();
            var settingsRepo = scope.ServiceProvider.GetRequiredService<ISystemSettingRepository>();

            var userId = CurrentUser.UserId;
            if (userId is not null)
            {
                var saved = await userPrefs.GetStringAsync(userId, IUserPreferenceService.ThemeMode);
                if (!string.IsNullOrEmpty(saved))
                    _themeMode = saved;
            }

            var nameSetting = await settingsRepo.GetByKeyAsync("CompanyName");
            _companyFullName = nameSetting?.Value ?? "";
            var abbrSetting = await settingsRepo.GetByKeyAsync("CompanyAbbreviation");
            _companyShortName = abbrSetting?.Value ?? "";

            await ApplyThemeMode();
            StateHasChanged();
        }
    }

    private async Task ApplyThemeMode()
    {
        _isDarkMode = _themeMode switch
        {
            "Light" => false,
            "Dark" => true,
            _ => await _themeProvider.GetSystemDarkModeAsync()
        };
    }

    private async Task SetThemeMode(string mode)
    {
        _themeMode = mode;
        await ApplyThemeMode();

        var userId = CurrentUser.UserId;
        if (userId is not null)
        {
            using var scope = ScopeFactory.CreateScope();
            var userPrefs = scope.ServiceProvider.GetRequiredService<IUserPreferenceService>();
            await userPrefs.SetAsync(userId, IUserPreferenceService.ThemeMode, mode);
        }
    }

    private readonly MudTheme _theme = new()
    {
        PaletteLight = new PaletteLight()
        {
            Primary = "#2563EB",
            Secondary = "#F59E0B",
            AppbarBackground = "#1E3A5F",
            AppbarText = "#FFFFFF",
            DrawerBackground = "#1E293B",
            DrawerText = "#CBD5E1",
            Surface = "#FFFFFF",
            Background = "#F8FAFC",
            TextPrimary = "#0F172A",
            TextSecondary = "#64748B",
            ActionDefault = "#64748B",
            Success = "#16A34A",
            Warning = "#D97706",
            Error = "#DC2626",
            Info = "#0284C7",
            Divider = "#E2E8F0"
        },
        PaletteDark = new PaletteDark()
        {
            Primary = "#60A5FA",
            Secondary = "#FBBF24",
            AppbarBackground = "#0F172A",
            AppbarText = "#E2E8F0",
            DrawerBackground = "#1E293B",
            DrawerText = "#CBD5E1",
            Surface = "#1E293B",
            Background = "#0F172A",
            TextPrimary = "#F1F5F9",
            TextSecondary = "#94A3B8",
            ActionDefault = "#94A3B8",
            Success = "#4ADE80",
            Warning = "#FCD34D",
            Error = "#F87171",
            Info = "#38BDF8",
            Divider = "#334155"
        },
        LayoutProperties = new LayoutProperties()
        {
            DrawerWidthLeft = "256px"
        },
        Typography = new Typography()
        {
            Default = new DefaultTypography()
            {
                FontFamily = ["Inter", "Roboto", "Helvetica", "Arial", "sans-serif"]
            }
        }
    };

    private void ToggleDrawer()
    {
        _drawerOpen = !_drawerOpen;
    }

    private async Task SubmitLogout()
    {
        await JS.InvokeVoidAsync("eval", "document.getElementById('logoutForm').submit()");
    }
}
